<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Konfekcja per klient â€” OvocxMalinovi</title>
<script src="zakupy-data.js"></script>
<script src="planowanie-data.js"></script>
<script src="zestawienie-proc-data.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{--orange:#fa4211;--purple:#9013fe;--grad:linear-gradient(135deg,#fa4211,#9013fe);--bg:#f7f7f5;--white:#fff;--border:#e8e6e1;--border2:#d8d5ce;--text:#1a1a18;--text-dim:#6b6b65;--text-muted:#a8a8a0;--surface2:#f2f0eb;--green:#16a34a;--green-bg:rgba(22,163,74,.08);--green-border:rgba(22,163,74,.2);--shadow:0 1px 3px rgba(0,0,0,.06),0 1px 2px rgba(0,0,0,.04)}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;min-height:100vh;font-size:14px}

header{display:flex;align-items:center;justify-content:space-between;padding:12px 32px;background:var(--white);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:200;box-shadow:var(--shadow);gap:12px}
.back-btn{display:flex;align-items:center;gap:7px;text-decoration:none;color:var(--text-dim);font-size:13px;font-weight:500;transition:color .15s}
.back-btn:hover{color:var(--orange)}
.page-title{font-size:15px;font-weight:700}
.btn{display:inline-flex;align-items:center;gap:5px;padding:7px 13px;border-radius:7px;font-size:12px;font-family:'Plus Jakarta Sans',sans-serif;cursor:pointer;transition:all .15s;border:1px solid var(--border2);background:var(--white);color:var(--text-dim);font-weight:500}
.btn:hover{background:var(--surface2)}
.btn-primary{background:var(--grad);color:#fff;border:none;font-weight:600}
.btn-primary:hover{opacity:.9}

.mod-nav{display:flex;background:var(--white);border-bottom:1px solid var(--border);padding:0 32px}
.mod-nav a{display:inline-flex;align-items:center;gap:5px;padding:9px 16px;font-size:12px;font-weight:500;color:var(--text-muted);text-decoration:none;border-bottom:2px solid transparent;transition:all .15s;white-space:nowrap}
.mod-nav a:hover{color:var(--text-dim)}
.mod-nav a.active{color:var(--orange);border-bottom-color:var(--orange);font-weight:600}

main{padding:20px 32px 100px;max-width:1400px;margin:0 auto}

/* CLIENT CARDS */
.client-grid{display:flex;flex-direction:column;gap:10px}
.client-card{background:var(--white);border:1px solid var(--border);border-radius:12px;overflow:hidden;box-shadow:var(--shadow)}

/* HEADER */
.client-head{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;cursor:pointer;user-select:none;transition:background .12s;gap:16px}
.client-head:hover{background:var(--surface2)}
.ch-left{display:flex;align-items:center;gap:10px}
.client-name{font-size:16px;font-weight:700}
.no-zp-badge{font-size:9px;background:#fef9c3;border:1px solid #fde047;color:#854d0e;padding:2px 7px;border-radius:10px;font-weight:600;text-transform:uppercase;letter-spacing:.04em}
.ch-meta{display:flex;align-items:center;gap:24px;font-size:12px;color:var(--text-dim)}
.ch-meta strong{color:var(--text);font-variant-numeric:tabular-nums}
.ch-toggle{font-size:10px;color:var(--text-muted);transition:transform .18s;margin-left:4px}
.client-card.open .ch-toggle{transform:rotate(180deg)}
.client-body{display:none;border-top:1px solid var(--border)}
.client-card.open .client-body{display:block}

/* SECTIONS */
.section{border-bottom:1px solid var(--border)}
.section:last-child{border-bottom:none}
.section-head{display:flex;align-items:center;gap:8px;padding:10px 20px;background:var(--surface2);font-size:10px;text-transform:uppercase;letter-spacing:.07em;color:var(--text-muted);font-weight:700}
.section-dot{width:7px;height:7px;border-radius:2px}

/* KARTONY TABLE */
.pak-table{width:100%;border-collapse:collapse}
.pak-table th{padding:7px 14px;font-size:10px;text-transform:uppercase;letter-spacing:.05em;color:var(--text-muted);font-weight:600;text-align:right;background:var(--white);border-bottom:1px solid var(--border)}
.pak-table th:first-child{text-align:left}
.pak-table td{padding:8px 14px;border-bottom:1px solid var(--border);font-size:13px;vertical-align:middle;text-align:right}
.pak-table td:first-child{text-align:left}
.pak-table tbody tr:last-child td{border-bottom:none}
.pak-table tbody tr:hover td{background:rgba(0,0,0,.02)}
.pak-table tfoot td{background:var(--surface2);font-weight:700;font-size:12px;padding:8px 14px;text-align:right;border-top:1px solid var(--border2)}
.pak-table tfoot td:first-child{text-align:left}
.num{font-family:'DM Mono',monospace;font-size:12px}
.pak-dot{display:inline-block;width:8px;height:8px;border-radius:2px;margin-right:7px;vertical-align:middle;flex-shrink:0}
.pak-label-main{font-weight:500}
.pak-code-small{font-family:'DM Mono',monospace;font-size:10px;color:var(--text-muted);display:block;margin-top:1px}
.proj-col{color:var(--orange);font-weight:600}
.col-dim{color:var(--text-muted)}

/* PUNNETY */
.punnets-row{display:flex;flex-wrap:wrap;gap:8px;padding:12px 20px}
.punnet-chip{display:flex;align-items:center;gap:6px;padding:6px 12px;background:var(--surface2);border:1px solid var(--border2);border-radius:8px;font-size:12px}
.punnet-waga{font-weight:700;color:var(--text)}
.punnet-szt{font-family:'DM Mono',monospace;color:var(--text-dim)}
.punnet-proj{font-family:'DM Mono',monospace;color:var(--orange);font-size:11px}
.punnet-arrow{color:var(--text-muted);font-size:10px}

/* ETYKIETY */
.etyk-section{padding:12px 20px;display:flex;flex-wrap:wrap;gap:6px;align-items:center}
.etyk-empty{font-size:12px;color:var(--text-muted);font-style:italic}
.etyk-chip{display:inline-flex;align-items:center;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:500;cursor:pointer;transition:all .12s;border:1px solid var(--border2);background:var(--surface2);color:var(--text-dim);user-select:none;gap:4px}
.etyk-chip.assigned{background:var(--green-bg);border-color:var(--green-border);color:var(--green);font-weight:600}
.etyk-chip:hover{border-color:var(--border2);background:var(--bg)}
.etyk-chip.assigned:hover{background:var(--green-bg);opacity:.8}
.etyk-add-btn{font-size:11px;color:var(--text-muted);background:none;border:1px dashed var(--border2);border-radius:20px;padding:4px 10px;cursor:pointer;transition:all .12s}
.etyk-add-btn:hover{border-color:var(--orange);color:var(--orange)}

/* SAVE BAR */
.save-bar{position:fixed;bottom:0;left:0;right:0;background:rgba(255,255,255,.95);backdrop-filter:blur(8px);border-top:1px solid var(--border);padding:12px 32px;display:flex;align-items:center;gap:10px;z-index:100;box-shadow:0 -2px 10px rgba(0,0,0,.05)}
.save-status{font-size:12px;color:var(--green);margin-right:auto;font-weight:500}
.save-status.unsaved{color:#d97706}
</style>
</head>
<body>

<header>
  <a href="index.html" class="back-btn">â† Baza wiedzy</a>
  <span class="page-title">Konfekcja per klient â€” ZP 2025</span>
  <span></span>
</header>

<nav class="mod-nav">
  <a href="zakupy-planowanie.html">ğŸ“Š Stan magazynowy</a>
  <a href="zakupy-klienci.html" class="active">ğŸ“¦ Konfekcja per klient</a>
  <a href="zakupy-harmonogram.html">ğŸ“… Harmonogram zakupÃ³w</a>
</nav>

<main>
  <div style="background:var(--white);border:1px solid var(--border);border-radius:10px;padding:13px 20px;margin-bottom:16px;font-size:13px;color:var(--text-dim);line-height:1.6">
    Zestawienie kartonÃ³w, opakowaÅ„ jednorazowych i etykiet wykorzystanych w sezonie <strong>2025</strong> per klient (ÅºrÃ³dÅ‚o: ZP)
    oraz prognoza na <strong>2026</strong> z planu sprzedaÅ¼y.<br>
    <strong>Etykiety</strong> â€” kliknij aby przypisaÄ‡/odpiÄ…Ä‡ klientowi. Zmiany zapisywane w przeglÄ…darce.
  </div>
  <div class="client-grid" id="client-grid"></div>
</main>

<div class="save-bar">
  <span class="save-status" id="save-status"></span>
  <button class="btn btn-primary" onclick="saveEtyk()">ğŸ’¾ Zapisz przypisania etykiet</button>
</div>

<script>
// â”€â”€ DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SNAPS   = ((window.ZAKUPY_DATA || {}).stany || []).filter(s => s.kategoria === 'etykiety');
const LS_ETYK = 'oxm_klient_etyk_v1';

// Mapowanie: nazwa klienta w planie â†’ nazwy odbiorcÃ³w w ZP 2025
const CLIENT_MAP = {
  'Biedronka':     ['JERONIMO MARTINS POLSKA SPÃ“ÅKA AKCYJNA'],
  'Dino':          ['DINO POLSKA SPÃ“ÅKA  AKCYJNA'],
  'OGL':           ['OGL FOOD TRADE POLSKA', 'OGL FOOD TRADE NIEMCY'],
  'SanLucar':      ['SANLUCAR'],
  'Kaczmarek':     ['RAFAÅ KACZMAREK'],
  'Special Fruit': ['SPECIAL FRUIT', 'SPECIAL FRUIT- MAXIMA'],
  'Frutania':      ['FRUTANIA'],
  'Garden Frutta': ['GARDEN FRUTTA S.R.L.'],
  'SpecjaÅ‚':       ['SPECJAÅ'],
  'Berry World':   ['BERRYWORLD (NL-NIP)'],
  'Kaufland':      ['FHU ROBERT (KAUFLAND)'],
  'Spar':          ['SCA PR POLSKA SPÃ“ÅKA Z OGRANICZONÄ„ ODPOWIEDZIALNOÅšCIÄ„'],
  'InterMarche':   [],
};

// Buduj ZS bezpoÅ›rednio z ZP_DATA.rekordy (zestawienie-proc-data.js)
const ZS = (function() {
  const zpRekordy = (window.ZP_DATA || {}).rekordy || [];
  const result = {};
  Object.entries(CLIENT_MAP).forEach(([planClient, zpClients]) => {
    const pakMap = {};
    zpClients.forEach(zpC => {
      zpRekordy.filter(r => r.odbiorca === zpC).forEach(r => {
        if (!pakMap[r.pak]) {
          pakMap[r.pak] = { pak: r.pak, kart_2025: 0, kg_2025: 0,
                            kgpk: r.kg_per_karton || 0, szt_pkrt: r.szt_w_kartonie || 0 };
        }
        pakMap[r.pak].kart_2025 += r.kartonow    || 0;
        pakMap[r.pak].kg_2025   += r.wolumen_kg  || 0;
        if (!pakMap[r.pak].kgpk    && r.kg_per_karton)   pakMap[r.pak].kgpk    = r.kg_per_karton;
        if (!pakMap[r.pak].szt_pkrt && r.szt_w_kartonie) pakMap[r.pak].szt_pkrt = r.szt_w_kartonie;
      });
    });
    const paks = Object.values(pakMap)
      .map(v => ({ ...v, kart_2025: Math.round(v.kart_2025), kg_2025: Math.round(v.kg_2025) }))
      .filter(v => v.kg_2025 > 0)
      .sort((a, b) => b.kg_2025 - a.kg_2025);
    result[planClient] = {
      paks,
      total_kg:   Math.round(paks.reduce((s, v) => s + v.kg_2025,   0)),
      total_kart: Math.round(paks.reduce((s, v) => s + v.kart_2025, 0)),
    };
  });
  return result;
})();

// PLAN 2026 per client
const PLAN_DATA_ALL = window.PLAN_DATA || [];
const PLAN_2026 = {};
PLAN_DATA_ALL.filter(r => r.typ === 'klient').forEach(r => {
  PLAN_2026[r.podmiot] = (PLAN_2026[r.podmiot] || 0) + (r.kg || 0);
});
const CLIENTS = Object.keys(PLAN_2026).sort((a, b) => (PLAN_2026[b] || 0) - (PLAN_2026[a] || 0));

// â”€â”€ LABEL ASSIGNMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function defaultEtyk() {
  const r = {};
  SNAPS.forEach(l => {
    const n = (l.nazwa || '').toLowerCase();
    const a = [];
    if (n.includes('biedronka'))  a.push('Biedronka');
    if (n.includes('sanlucar'))   a.push('SanLucar');
    if (n.includes('frutania') || n.includes('rewe')) a.push('Frutania');
    if (n.includes('colruyt') || n.includes('maxima') || n.includes('carrefour') ||
        (n.includes('aldi') && n.includes('frambozen')) || n.includes('60x65') || n.includes('60x80'))
      { if (!a.includes('Special Fruit')) a.push('Special Fruit'); }
    if (n.includes('kaufland'))   a.push('Kaufland');
    if (n.includes('inter') || n.includes('z sadÃ³w')) a.push('InterMarche');
    if (n.includes('berry') || n.includes('pirkka'))  a.push('Berry World');
    if (n.includes('lidl'))       a.push('Garden Frutta');
    r[l.indeks] = a;
  });
  return r;
}
let ETYK = {};
try { ETYK = JSON.parse(localStorage.getItem(LS_ETYK)) || defaultEtyk(); } catch(e) { ETYK = defaultEtyk(); }
if (!ETYK || typeof ETYK !== 'object') ETYK = defaultEtyk();

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s) {
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}
function cid(s) { return s.replace(/[^a-zA-Z0-9]/g, '_'); }
function fN(n) { return Math.round(n).toLocaleString('pl-PL'); }

function parsePak(pak) {
  const m = pak.match(/__(\d+)X(\d+)/);
  const wagaG   = m ? parseInt(m[1]) : 0;
  const sztPKrt = m ? parseInt(m[2]) : 0;
  const typ  = pak.startsWith('PEÅNE')  ? 'Ziel.' : 'Czar.';
  const rodz = pak.includes('KLEJONY') ? 'klej.' : 'skÅ‚.';
  const roz  = pak.includes('MAÅY')    ? 'MaÅ‚y'  : 'DuÅ¼y';
  const ts   = pak.includes('TOPSEAL') ? ' TS'   : '';
  const label = wagaG
    ? `${roz} ${wagaG}g\u00D7${sztPKrt} szt/k (${typ} ${rodz}${ts})`
    : pak;
  return { wagaG, sztPKrt, label, typ, rodz, roz };
}

function pakColor(pak) {
  if (pak.startsWith('PEÅNE')  && pak.includes('MAÅY')) return '#16a34a';
  if (pak.startsWith('PEÅNE')  && pak.includes('DUÅ»Y')) return '#2563eb';
  if (pak.startsWith('PROSTE') && pak.includes('MAÅY')) return '#6b7280';
  return '#9013fe';
}

// Compute 2026 projected cartons for a client's pak given planKg
function projKarton(pak_entry, planKg, totalKgZP) {
  const share = totalKgZP > 0 ? pak_entry.kg_2025 / totalKgZP : 0;
  return pak_entry.kgpk > 0 ? Math.round(planKg * share / pak_entry.kgpk) : 0;
}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
  document.getElementById('client-grid').innerHTML = CLIENTS.map(c => clientCard(c)).join('');
  // Auto-open first card
  if (CLIENTS[0]) {
    const card = document.getElementById('cc_' + cid(CLIENTS[0]));
    const body = document.getElementById('cb_' + cid(CLIENTS[0]));
    if (card && body) { card.classList.add('open'); body.style.display = 'block'; }
  }
}

function clientCard(c) {
  const planKg  = PLAN_2026[c] || 0;
  const stats   = ZS[c];
  const hasZP   = stats && stats.paks && stats.paks.length > 0;

  // Header meta
  const kart2025 = hasZP ? stats.total_kart : 0;
  const kg2025   = hasZP ? stats.total_kg   : 0;
  const proj2026 = hasZP
    ? stats.paks.reduce((s, v) => s + projKarton(v, planKg, stats.total_kg), 0)
    : 0;

  return `<div class="client-card" id="cc_${cid(c)}">
    <div class="client-head" onclick="toggleCard('${esc(c)}')">
      <div class="ch-left">
        <span class="client-name">${esc(c)}</span>
        ${!hasZP ? '<span class="no-zp-badge">brak w ZP 2025</span>' : ''}
      </div>
      <div class="ch-meta">
        ${hasZP ? `<span>ZP 2025: <strong>${fN(kart2025)}</strong> kart. Â· <strong>${fN(kg2025)}</strong> kg</span>` : ''}
        <span>Plan 2026: <strong>${fN(planKg)}</strong> kg</span>
        ${hasZP ? `<span>Prognoza 2026: <strong style="color:var(--orange)">${fN(proj2026)}</strong> kart.</span>` : ''}
        <span class="ch-toggle">â–¼</span>
      </div>
    </div>
    <div class="client-body" id="cb_${cid(c)}">
      ${kartonySection(c, stats, planKg)}
      ${punnetySection(c, stats, planKg)}
      ${etykietySection(c)}
    </div>
  </div>`;
}

function kartonySection(c, stats, planKg) {
  if (!stats || !stats.paks || stats.paks.length === 0) {
    return `<div class="section">
      <div class="section-head"><span class="section-dot" style="background:#6b7280"></span>KARTONY</div>
      <div style="padding:14px 20px;font-size:12px;color:var(--text-muted);font-style:italic">
        Brak danych w ZP 2025. Prognoza bazuje na Å›rednim miksie ze wszystkich klientÃ³w.
      </div>
    </div>`;
  }

  const totalKg   = stats.total_kg;
  const totalKart = stats.total_kart;
  const totalProj = stats.paks.reduce((s, v) => s + projKarton(v, planKg, totalKg), 0);

  const rows = stats.paks.map(v => {
    const { label, wagaG } = parsePak(v.pak);
    const color = pakColor(v.pak);
    const pct   = totalKg > 0 ? (v.kg_2025 / totalKg * 100).toFixed(1) : '0.0';
    const proj  = projKarton(v, planKg, totalKg);
    return `<tr>
      <td>
        <span class="pak-dot" style="background:${color}"></span>
        <span class="pak-label-main">${esc(label)}</span>
        <span class="pak-code-small">${esc(v.pak)}</span>
      </td>
      <td class="num">${fN(v.kart_2025)}</td>
      <td class="num col-dim">${fN(v.kg_2025)}</td>
      <td class="num col-dim">${pct}%</td>
      <td class="num proj-col">${fN(proj)}</td>
    </tr>`;
  }).join('');

  return `<div class="section">
    <div class="section-head"><span class="section-dot" style="background:#2563eb"></span>KARTONY</div>
    <table class="pak-table">
      <thead><tr>
        <th>Format</th>
        <th>Kart. 2025</th>
        <th>kg 2025</th>
        <th>% vol.</th>
        <th style="color:var(--orange)">Prognoza 2026</th>
      </tr></thead>
      <tbody>${rows}</tbody>
      <tfoot><tr>
        <td>Razem</td>
        <td>${fN(totalKart)}</td>
        <td>${fN(totalKg)}</td>
        <td>100%</td>
        <td style="color:var(--orange)">${fN(totalProj)}</td>
      </tr></tfoot>
    </table>
  </div>`;
}

function punnetySection(c, stats, planKg) {
  if (!stats || !stats.paks || stats.paks.length === 0) return '';

  const totalKg = stats.total_kg;

  // Aggregate by wagaG â†’ {szt2025, proj2026}
  const agg = {};
  stats.paks.forEach(v => {
    const { wagaG, sztPKrt } = parsePak(v.pak);
    if (!wagaG || !sztPKrt) return;
    if (!agg[wagaG]) agg[wagaG] = { szt2025: 0, proj2026: 0 };
    agg[wagaG].szt2025  += v.kart_2025 * sztPKrt;
    const proj = projKarton(v, planKg, totalKg);
    agg[wagaG].proj2026 += proj * sztPKrt;
  });

  const entries = Object.entries(agg)
    .filter(([, v]) => v.szt2025 > 0)
    .sort((a, b) => parseInt(a[0]) - parseInt(b[0]));

  if (entries.length === 0) return '';

  const chips = entries.map(([wagaG, v]) => `
    <div class="punnet-chip">
      <span class="punnet-waga">${wagaG}g</span>
      <span class="punnet-szt">${fN(v.szt2025)} szt (2025)</span>
      <span class="punnet-arrow">â†’</span>
      <span class="punnet-proj">~${fN(v.proj2026)} (2026)</span>
    </div>`).join('');

  return `<div class="section">
    <div class="section-head"><span class="section-dot" style="background:#f97316"></span>OPAKOWANIA JEDNORAZOWE (punnety)</div>
    <div class="punnets-row">${chips}</div>
  </div>`;
}

function etykietySection(c) {
  // Labels assigned to this client
  const assigned = SNAPS.filter(l => (ETYK[l.indeks] || []).includes(c));
  // Labels not assigned (for adding)
  const others   = SNAPS.filter(l => !(ETYK[l.indeks] || []).includes(c));

  const assignedChips = assigned.map(l =>
    `<span class="etyk-chip assigned" onclick="toggleEtyk('${esc(l.indeks)}','${esc(c)}')" title="${esc(l.indeks)}">
      âœ“ ${esc(l.nazwa)}
    </span>`
  ).join('');

  // Show "Dodaj etykietÄ™" dropdown â€” render as expandable
  const addId = 'etyk_add_' + cid(c);

  return `<div class="section">
    <div class="section-head"><span class="section-dot" style="background:#16a34a"></span>ETYKIETY</div>
    <div class="etyk-section" id="etyk_${cid(c)}">
      ${assignedChips || '<span class="etyk-empty">Brak przypisanych etykiet</span>'}
      <button class="etyk-add-btn" onclick="toggleAddEtyk('${esc(c)}')" title="Przypisz etykietÄ™">+ Dodaj</button>
    </div>
    <div id="${addId}" style="display:none;padding:10px 20px;border-top:1px dashed var(--border2);display:none">
      <div style="font-size:11px;color:var(--text-muted);margin-bottom:8px;text-transform:uppercase;letter-spacing:.05em">Kliknij etykietÄ™ aby przypisaÄ‡:</div>
      <div style="display:flex;flex-wrap:wrap;gap:5px">
        ${others.map(l =>
          `<span class="etyk-chip" onclick="addEtyk('${esc(l.indeks)}','${esc(c)}')" title="${esc(l.indeks)}">${esc(l.nazwa)}</span>`
        ).join('')}
      </div>
    </div>
  </div>`;
}

// â”€â”€ INTERACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleCard(c) {
  const card = document.getElementById('cc_' + cid(c));
  const body = document.getElementById('cb_' + cid(c));
  if (!card || !body) return;
  const opening = !card.classList.contains('open');
  card.classList.toggle('open', opening);
  body.style.display = opening ? 'block' : 'none';
}

function toggleEtyk(indeks, client) {
  if (!ETYK[indeks]) ETYK[indeks] = [];
  const arr = ETYK[indeks];
  const i = arr.indexOf(client);
  if (i >= 0) arr.splice(i, 1);
  else arr.push(client);
  refreshEtykSection(client);
  markUnsaved();
}

function addEtyk(indeks, client) {
  if (!ETYK[indeks]) ETYK[indeks] = [];
  if (!ETYK[indeks].includes(client)) ETYK[indeks].push(client);
  refreshEtykSection(client);
  document.getElementById('etyk_add_' + cid(client)).style.display = 'none';
  markUnsaved();
}

function toggleAddEtyk(c) {
  const el = document.getElementById('etyk_add_' + cid(c));
  if (!el) return;
  el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

function refreshEtykSection(c) {
  // Re-render just the etyk section inside the card
  const body = document.getElementById('cb_' + cid(c));
  if (!body) return;
  const oldEtyk = body.querySelector('.section:last-child');
  if (!oldEtyk) return;
  oldEtyk.outerHTML = etykietySection(c);
}

// â”€â”€ SAVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function markUnsaved() {
  const el = document.getElementById('save-status');
  if (el) { el.textContent = 'Niezapisane zmiany'; el.className = 'save-status unsaved'; }
}

function saveEtyk() {
  localStorage.setItem(LS_ETYK, JSON.stringify(ETYK));
  const el = document.getElementById('save-status');
  if (el) { el.textContent = 'Zapisano!'; el.className = 'save-status'; }
  setTimeout(() => { if (el) el.textContent = ''; }, 2500);
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
render();
</script>
</body>
</html>
