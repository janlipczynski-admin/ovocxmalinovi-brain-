<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Planowanie i Sprzeda≈º 2026 ‚Äî OvocxMalinovi</title>
<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
<script src="planowanie-data.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --orange: #fa4211; --purple: #9013fe;
    --grad: linear-gradient(135deg,#fa4211,#9013fe);
    --bg: #f7f7f5; --white: #fff;
    --border: #e8e6e1; --border2: #d8d5ce;
    --text: #1a1a18; --text-dim: #6b6b65; --text-muted: #a8a8a0;
    --surface2: #f2f0eb;
    --green: #16a34a; --yellow: #d97706; --red: #dc2626; --blue: #2563eb;
    --shadow: 0 1px 3px rgba(0,0,0,.06),0 1px 2px rgba(0,0,0,.04);
    --shadow-md: 0 4px 12px rgba(0,0,0,.08),0 2px 4px rgba(0,0,0,.04);
  }
  *{margin:0;padding:0;box-sizing:border-box}
  body{background:var(--bg);color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;min-height:100vh;font-size:14px}

  /* HEADER */
  header{display:flex;align-items:center;justify-content:space-between;padding:13px 32px;background:var(--white);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:200;box-shadow:var(--shadow);gap:12px}
  .back-btn{display:flex;align-items:center;gap:7px;text-decoration:none;color:var(--text-dim);font-size:13px;font-weight:500;transition:color .15s;white-space:nowrap}
  .back-btn:hover{color:var(--orange)}
  .h-center{display:flex;align-items:center;gap:10px;flex:1;justify-content:center}
  .page-title{font-size:16px;font-weight:700}
  .year-pill{font-family:'DM Mono',monospace;font-size:11px;font-weight:600;background:var(--grad);color:#fff;padding:3px 10px;border-radius:20px}
  .h-actions{display:flex;align-items:center;gap:7px}
  .btn{display:inline-flex;align-items:center;gap:5px;padding:7px 13px;border-radius:7px;font-size:12px;font-family:'Plus Jakarta Sans',sans-serif;cursor:pointer;transition:all .15s;border:1px solid var(--border2);background:var(--white);color:var(--text-dim);font-weight:500}
  .btn:hover{background:var(--surface2)}
  .btn-primary{background:var(--grad);border:none;color:#fff}
  .btn-primary:hover{opacity:.88}
  .btn-danger{border-color:rgba(220,38,38,.3);color:var(--red)}
  .btn-danger:hover{background:rgba(220,38,38,.06)}

  /* TABS */
  .tabs-bar{display:flex;background:var(--white);border-bottom:1px solid var(--border);padding:0 32px;overflow-x:auto}
  .tab{display:flex;align-items:center;gap:6px;padding:12px 16px;font-size:12px;font-weight:500;color:var(--text-muted);cursor:pointer;border-bottom:2px solid transparent;transition:all .15s;white-space:nowrap}
  .tab:hover{color:var(--text-dim)}
  .tab.active{color:var(--orange);border-bottom-color:var(--orange)}
  .tab-badge{font-family:'DM Mono',monospace;font-size:9px;background:var(--surface2);color:var(--text-muted);padding:1px 6px;border-radius:10px;border:1px solid var(--border)}
  .tab.active .tab-badge{background:rgba(250,66,17,.1);color:var(--orange);border-color:rgba(250,66,17,.2)}

  /* MAIN */
  main{padding:20px 32px;max-width:1600px;margin:0 auto}
  .tab-content{display:none}
  .tab-content.active{display:block}

  /* IMPORT */
  .import-zone{border:2px dashed var(--border2);border-radius:14px;padding:48px 32px;text-align:center;cursor:pointer;transition:all .2s;background:var(--white);margin-bottom:18px}
  .import-zone:hover,.import-zone.drag-over{border-color:var(--orange);background:rgba(250,66,17,.02)}
  .import-icon{font-size:40px;margin-bottom:12px}
  .import-title{font-size:16px;font-weight:600;margin-bottom:6px}
  .import-sub{font-size:12px;color:var(--text-muted);margin-bottom:16px;line-height:1.6}

  /* FILTERS */
  .filters-bar{background:var(--white);border:1px solid var(--border);border-radius:12px;padding:13px 17px;margin-bottom:13px;display:flex;flex-wrap:wrap;gap:10px;align-items:flex-end}
  .fg{display:flex;flex-direction:column;gap:4px}
  .fl{font-family:'DM Mono',monospace;font-size:9px;color:var(--text-muted);text-transform:uppercase;letter-spacing:.1em}
  .fs{background:var(--bg);border:1px solid var(--border);border-radius:7px;padding:6px 10px;font-size:12px;color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;min-width:130px;outline:none;transition:border-color .15s;cursor:pointer}
  .fs:focus{border-color:rgba(250,66,17,.4)}
  .fi{background:var(--bg);border:1px solid var(--border);border-radius:7px;padding:6px 10px;font-size:12px;color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;min-width:180px;outline:none;transition:border-color .15s}
  .fi:focus{border-color:rgba(250,66,17,.4)}
  .fi::placeholder{color:var(--text-muted)}

  /* SUMMARY */
  .sum-bar{display:flex;gap:10px;margin-bottom:13px;flex-wrap:wrap}
  .sc{background:var(--white);border:1px solid var(--border);border-radius:10px;padding:12px 15px;box-shadow:var(--shadow);flex:1;min-width:110px}
  .sl{font-family:'DM Mono',monospace;font-size:9px;color:var(--text-muted);text-transform:uppercase;letter-spacing:.1em;margin-bottom:4px}
  .sv{font-size:18px;font-weight:700;line-height:1}
  .sv.grad{background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent}

  /* TABLE */
  .tw{background:var(--white);border:1px solid var(--border);border-radius:12px;overflow:hidden;box-shadow:var(--shadow)}
  .th-bar{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;border-bottom:1px solid var(--border);background:var(--surface2);gap:8px;flex-wrap:wrap}
  .t-title{font-family:'DM Mono',monospace;font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:.1em}
  .t-count{font-family:'DM Mono',monospace;font-size:10px;color:var(--text-muted)}
  .t-scroll{overflow-x:auto;max-height:calc(100vh - 340px);overflow-y:auto}
  table{width:100%;border-collapse:collapse;font-size:12px}
  thead th{position:sticky;top:0;background:var(--surface2);border-bottom:1px solid var(--border2);padding:8px 10px;text-align:left;font-family:'DM Mono',monospace;font-size:9px;color:var(--text-dim);text-transform:uppercase;letter-spacing:.07em;white-space:nowrap;user-select:none;cursor:pointer;transition:background .1s}
  thead th:hover{background:var(--border)}
  thead th.sort-asc::after{content:' ‚Üë';color:var(--orange)}
  thead th.sort-desc::after{content:' ‚Üì';color:var(--orange)}
  thead th.no-sort{cursor:default}
  tbody tr{border-bottom:1px solid var(--border);transition:background .1s}
  tbody tr:hover{background:rgba(250,66,17,.02)}
  tbody tr.edited-row{background:rgba(217,119,6,.05)}
  tbody tr:last-child{border-bottom:none}
  tbody td{padding:7px 10px;color:var(--text)}
  td.num{text-align:right;font-family:'DM Mono',monospace;font-size:11px}
  td.muted{color:var(--text-muted);font-size:11px}
  td.bold{font-weight:600}
  td.prod-col{color:var(--green);font-weight:500}
  td.klient-col{color:var(--blue);font-weight:500}

  .badge{display:inline-block;font-family:'DM Mono',monospace;font-size:9px;padding:2px 7px;border-radius:20px;white-space:nowrap}
  .badge-prod{background:rgba(22,163,74,.1);color:var(--green);border:1px solid rgba(22,163,74,.2)}
  .badge-klient{background:rgba(37,99,235,.1);color:var(--blue);border:1px solid rgba(37,99,235,.2)}
  .badge-owoc{background:rgba(250,66,17,.08);color:var(--orange);border:1px solid rgba(250,66,17,.15)}

  /* Edit cells */
  .ecell{display:inline-block;min-width:60px;padding:2px 5px;border-radius:4px;cursor:text;transition:background .1s}
  .ecell:focus{outline:2px solid var(--orange);background:rgba(250,66,17,.05)}
  .changed-dot{display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--yellow);margin-left:4px;vertical-align:middle}

  /* Bilans colors */
  .bilans-pos{color:var(--green);font-weight:600}
  .bilans-neg{color:var(--red);font-weight:600}
  .bilans-zero{color:var(--text-muted)}

  /* PAGINATION */
  .pag{display:flex;align-items:center;justify-content:center;gap:5px;padding:11px 16px;border-top:1px solid var(--border);background:var(--surface2);flex-wrap:wrap}
  .pb{background:var(--white);border:1px solid var(--border2);border-radius:6px;padding:4px 9px;font-size:11px;color:var(--text-dim);cursor:pointer;transition:all .15s;font-family:'Plus Jakarta Sans',sans-serif}
  .pb:hover{border-color:var(--orange);color:var(--orange)}
  .pb.active{background:var(--orange);border-color:var(--orange);color:#fff}
  .pb:disabled{opacity:.4;cursor:default}
  .pi{font-family:'DM Mono',monospace;font-size:10px;color:var(--text-muted)}

  /* HISTORY */
  .h-item{background:var(--white);border:1px solid var(--border);border-radius:10px;padding:11px 15px;display:flex;gap:12px;align-items:flex-start;margin-bottom:7px}
  .h-time{font-family:'DM Mono',monospace;font-size:10px;color:var(--text-muted);white-space:nowrap;min-width:110px}
  .h-body{flex:1}
  .h-id{font-family:'DM Mono',monospace;font-size:11px;color:var(--orange);font-weight:500;margin-bottom:3px}
  .h-ch{font-size:12px}
  .h-old{color:var(--text-muted);text-decoration:line-through}
  .h-arr{color:var(--text-muted);margin:0 4px}
  .h-new{color:var(--green);font-weight:500}
  .h-meta{font-size:10px;color:var(--text-muted);margin-top:2px;font-family:'DM Mono',monospace}
  .h-empty{text-align:center;padding:60px 20px;color:var(--text-muted);font-family:'DM Mono',monospace;font-size:11px}

  /* TOAST */
  .toast{position:fixed;bottom:22px;right:22px;background:var(--text);color:#fff;padding:9px 16px;border-radius:8px;font-size:12px;font-family:'DM Mono',monospace;box-shadow:var(--shadow-md);opacity:0;transform:translateY(8px);transition:all .25s;z-index:999;pointer-events:none}
  .toast.show{opacity:1;transform:translateY(0)}
  .toast.ok{background:var(--green)}

  ::-webkit-scrollbar{width:5px;height:5px}
  ::-webkit-scrollbar-track{background:var(--bg)}
  ::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}

  @media(max-width:700px){
    header,main{padding-left:14px;padding-right:14px}
    .tabs-bar{padding:0 14px}
  }
</style>
</head>
<body>

<header>
  <a href="index.html" class="back-btn">‚Üê Dashboard</a>
  <div class="h-center">
    <span class="page-title">Planowanie i Sprzeda≈º</span>
    <span class="year-pill">2026</span>
  </div>
  <div class="h-actions">
    <button class="btn" onclick="exportChanges()">‚¨á Eksport zmian</button>
    <button class="btn btn-primary" onclick="document.getElementById('fileIn').click()">+ Wgraj plik Excel</button>
    <input type="file" id="fileIn" accept=".xlsx,.xls" style="display:none" onchange="handleUpload(event)">
  </div>
</header>

<div class="tabs-bar">
  <div class="tab active" onclick="switchTab('prod')">üå± Deklaracje Producent√≥w <span class="tab-badge" id="tbProd">‚Äî</span></div>
  <div class="tab" onclick="switchTab('klient')">üõí Zapotrzebowanie Klient√≥w <span class="tab-badge" id="tbKlient">‚Äî</span></div>
  <div class="tab" onclick="switchTab('bilans')">‚öñÔ∏è Bilans Tygodniowy <span class="tab-badge" id="tbBilans">‚Äî</span></div>
  <div class="tab" onclick="switchTab('hist')">üïê Historia zmian <span class="tab-badge" id="tbHist">0</span></div>
</div>

<main>

<!-- ========== IMPORT ========== -->
<div id="importBox">
  <div class="import-zone" id="dropZone"
    onclick="document.getElementById('fileIn').click()"
    ondragover="event.preventDefault();this.classList.add('drag-over')"
    ondragleave="this.classList.remove('drag-over')"
    ondrop="handleDrop(event)">
    <div class="import-icon">üìÇ</div>
    <div class="import-title">Wgraj plik "Planowanie + sprzeda≈º 2026"</div>
    <div class="import-sub">
      Kliknij lub przeciƒÖgnij plik .xlsx<br>
      Strona automatycznie rozpoznaje producent√≥w i klient√≥w.
    </div>
    <button class="btn btn-primary" onclick="event.stopPropagation();document.getElementById('fileIn').click()">Wybierz plik</button>
  </div>
</div>

<!-- ========== TAB: PRODUCENCI ========== -->
<div class="tab-content active" id="tab-prod">
  <div class="filters-bar" id="pfProd" style="display:none">
    <div class="fg"><div class="fl">Szukaj</div><input class="fi" id="pSearch" type="text" placeholder="Producent, owoc..."></div>
    <div class="fg"><div class="fl">Owoc</div><select class="fs" id="pOwoc"><option value="">Wszystkie</option></select></div>
    <div class="fg"><div class="fl">Tydzie≈Ñ</div><select class="fs" id="pTydz"><option value="">Wszystkie</option></select></div>
    <div class="fg"><div class="fl">Producent</div><select class="fs" id="pProd"><option value="">Wszyscy</option></select></div>
    <button class="btn" onclick="resetF('prod')">‚Ü∫ Wyczy≈õƒá</button>
    <button class="btn btn-primary" id="btnSaveProd" style="display:none" onclick="saveEdits('prod')">üíæ Zapisz</button>
    <button class="btn" id="btnEditProd" onclick="toggleEdit('prod')" style="display:none">‚úèÔ∏è Tryb edycji</button>
  </div>
  <div class="sum-bar" id="sumProd" style="display:none">
    <div class="sc"><div class="sl">Wierszy</div><div class="sv" id="sProdCount">‚Äî</div></div>
    <div class="sc"><div class="sl">≈ÅƒÖczny wolumen</div><div class="sv grad" id="sProdKg">‚Äî</div></div>
    <div class="sc"><div class="sl">Producent√≥w</div><div class="sv" id="sProdN">‚Äî</div></div>
    <div class="sc"><div class="sl">Owoc√≥w</div><div class="sv" id="sProdOwoc">‚Äî</div></div>
    <div class="sc"><div class="sl">Tygodni</div><div class="sv" id="sProdTydz">‚Äî</div></div>
  </div>
  <div class="tw" id="twProd" style="display:none">
    <div class="th-bar">
      <div class="t-title">Deklaracje Producent√≥w</div>
      <div style="display:flex;gap:8px;align-items:center">
        <span class="t-count" id="cProd"></span>
      </div>
    </div>
    <div class="t-scroll" id="tsProd"></div>
    <div class="pag" id="pagProd" style="display:none"></div>
  </div>
</div>

<!-- ========== TAB: KLIENCI ========== -->
<div class="tab-content" id="tab-klient">
  <div class="filters-bar" id="pfKlient" style="display:none">
    <div class="fg"><div class="fl">Szukaj</div><input class="fi" id="kSearch" type="text" placeholder="Klient, owoc..."></div>
    <div class="fg"><div class="fl">Owoc</div><select class="fs" id="kOwoc"><option value="">Wszystkie</option></select></div>
    <div class="fg"><div class="fl">Tydzie≈Ñ</div><select class="fs" id="kTydz"><option value="">Wszystkie</option></select></div>
    <div class="fg"><div class="fl">Klient</div><select class="fs" id="kKlient"><option value="">Wszyscy</option></select></div>
    <button class="btn" onclick="resetF('klient')">‚Ü∫ Wyczy≈õƒá</button>
    <button class="btn btn-primary" id="btnSaveKlient" style="display:none" onclick="saveEdits('klient')">üíæ Zapisz</button>
    <button class="btn" id="btnEditKlient" onclick="toggleEdit('klient')" style="display:none">‚úèÔ∏è Tryb edycji</button>
  </div>
  <div class="sum-bar" id="sumKlient" style="display:none">
    <div class="sc"><div class="sl">Wierszy</div><div class="sv" id="sKlientCount">‚Äî</div></div>
    <div class="sc"><div class="sl">Zapotrzebowanie</div><div class="sv grad" id="sKlientKg">‚Äî</div></div>
    <div class="sc"><div class="sl">Klient√≥w</div><div class="sv" id="sKlientN">‚Äî</div></div>
    <div class="sc"><div class="sl">Owoc√≥w</div><div class="sv" id="sKlientOwoc">‚Äî</div></div>
  </div>
  <div class="tw" id="twKlient" style="display:none">
    <div class="th-bar">
      <div class="t-title">Zapotrzebowanie Klient√≥w</div>
      <span class="t-count" id="cKlient"></span>
    </div>
    <div class="t-scroll" id="tsKlient"></div>
    <div class="pag" id="pagKlient" style="display:none"></div>
  </div>
</div>

<!-- ========== TAB: BILANS ========== -->
<div class="tab-content" id="tab-bilans">
  <div class="filters-bar" id="pfBilans" style="display:none">
    <div class="fg"><div class="fl">Owoc</div><select class="fs" id="bOwoc"><option value="">Wszystkie</option></select></div>
    <div class="fg"><div class="fl">Tydzie≈Ñ</div><select class="fs" id="bTydz"><option value="">Wszystkie</option></select></div>
    <button class="btn" onclick="resetF('bilans')">‚Ü∫ Wyczy≈õƒá</button>
  </div>
  <div class="tw" id="twBilans" style="display:none">
    <div class="th-bar">
      <div class="t-title">Bilans: Dostƒôpne vs Zam√≥wione</div>
      <span class="t-count" id="cBilans"></span>
    </div>
    <div class="t-scroll" id="tsBilans"></div>
  </div>
</div>

<!-- ========== TAB: HISTORIA ========== -->
<div class="tab-content" id="tab-hist">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
    <div>
      <div style="font-size:15px;font-weight:600;margin-bottom:3px">Historia zmian</div>
      <div style="font-size:12px;color:var(--text-muted)">Edycje zapisywane lokalnie w przeglƒÖdarce ¬∑ trwa≈Çe miƒôdzy sesjami</div>
    </div>
    <button class="btn btn-danger" onclick="clearHist()">üóë Wyczy≈õƒá</button>
  </div>
  <div id="histList"></div>
</div>

</main>
<div class="toast" id="toast"></div>

<script>
// ================================================================
// CONSTANTS
// ================================================================
const HIST_KEY = 'oxm_plan26_hist';
const DATA_KEY = 'oxm_plan26_data';
const PAGE = 100;

// Znani producenci ‚Äî reszta to klienci
const PRODUCENCI = new Set([
  'Sarbinowski','Ovoc','Lipczy≈Ñski','Domasz','Dr√≥bka',
  'Pietruszka','Pluta','Fons','Wencel'
]);

// Mapowanie nazw arkuszy ‚Üí ≈Çadna nazwa owocu
const OWOC_NAMES = {
  'Truskawka tunelowa':    'Truskawka tunelowa',
  'Truskawka szklarniowa': 'Truskawka szklarniowa',
  'Malina':    'Malina',
  'Je≈ºyna':    'Je≈ºyna',
  'Porzeczka': 'Porzeczka',
  'Agrest':    'Agrest',
};

// ================================================================
// STATE
// ================================================================
let allRows = [];       // [{owoc, podmiot, typ, tydzien, kg, _id}]
let prodRows = [];      // filtered producenci
let klientRows = [];    // filtered klienci
let bilansRows = [];    // aggregated

let prodPage = 0, klientPage = 0;
let prodSort = {col:null,dir:1}, klientSort = {col:null,dir:1};

let editMode = {prod: false, klient: false};
let pending  = {prod: {}, klient: {}};  // {id: newKg}

let fileName = '';

// ================================================================
// UTILS
// ================================================================
function toast(msg, type='') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'toast show' + (type ? ' '+type : '');
  clearTimeout(el._t);
  el._t = setTimeout(() => el.className = 'toast', 2800);
}

function fmt(n, dec=0) {
  if (n == null || n === '') return '‚Äî';
  const v = parseFloat(n);
  return isNaN(v) ? '‚Äî' : v.toLocaleString('pl-PL',{minimumFractionDigits:dec,maximumFractionDigits:dec});
}

function getHist() { try { return JSON.parse(localStorage.getItem(HIST_KEY)||'[]'); } catch(e){ return []; } }
function saveHist(h) { try { localStorage.setItem(HIST_KEY, JSON.stringify(h)); } catch(e){} updateHistBadge(); }
function addHist(entry) { const h=getHist(); h.unshift({...entry,ts:new Date().toISOString()}); if(h.length>500)h.length=500; saveHist(h); }
function updateHistBadge() { document.getElementById('tbHist').textContent = getHist().length || '0'; }

// ================================================================
// TABS
// ================================================================
function switchTab(name) {
  const names = ['prod','klient','bilans','hist'];
  document.querySelectorAll('.tab').forEach((t,i) => t.classList.toggle('active', names[i]===name));
  document.querySelectorAll('.tab-content').forEach(el => el.classList.toggle('active', el.id==='tab-'+name));
  if (name === 'hist') renderHist();
  if (name === 'bilans') renderBilans();
}

// ================================================================
// FILE UPLOAD
// ================================================================
function handleUpload(e) { const f=e.target.files[0]; if(f) loadFile(f); e.target.value=''; }
function handleDrop(e) { e.preventDefault(); document.getElementById('dropZone').classList.remove('drag-over'); const f=e.dataTransfer.files[0]; if(f) loadFile(f); }

function loadFile(file) {
  fileName = file.name;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const wb = XLSX.read(ev.target.result, {type:'binary', cellDates:true});
      parseWorkbook(wb);
      toast('Za≈Çadowano: ' + file.name, 'ok');
    } catch(err) {
      toast('B≈ÇƒÖd: ' + err.message);
    }
  };
  reader.readAsBinaryString(file);
}

// ================================================================
// PARSER ‚Äî specjalistyczny dla tej struktury pliku
// ================================================================
function parseWorkbook(wb) {
  allRows = [];
  let uid = 0;

  for (const sheetName of wb.SheetNames) {
    if (sheetName.toLowerCase().includes('wykres')) continue;
    const owoc = OWOC_NAMES[sheetName] || sheetName;
    const ws = wb.Sheets[sheetName];
    const raw = XLSX.utils.sheet_to_json(ws, {header:1, raw:true, defval:null});
    if (raw.length < 6) continue;

    // Wiersz z nazwami producent√≥w/klient√≥w (row index 4 = 5-ty wiersz)
    const podmiotRow = raw[4] || [];
    // Wiersz z nag≈Ç√≥wkami kolumn (row 5)
    // Dane zaczynajƒÖ siƒô od row 6 (index 6)

    // Znajd≈∫ grupy: ka≈ºda nazwa w podmiotRow wyznacza grupƒô (tydzie≈Ñ, kg)
    // Wzorzec: col[i] = nazwa, col[i+1] = tydzie≈Ñ, col[i+2] = kg
    // Czyli nazwa jest o 1 przed "numer tygodnia"
    // Ale patrzƒÖc na dane: podmiotRow[1]=Pietruszka, podmiotRow[4]=Sarbinowski...
    // ka≈ºdy podmiot co 3 kolumny, dane w i+1 (tydzie≈Ñ) i i+2 (kg)? Nie ‚Äî
    // patrzƒÖc na row5: col1='numer tygodnia', col2='ilo≈õƒá [kg]'
    // wiƒôc: podmiot jest w col N, tydzie≈Ñ w col N (same), kg w N+1
    // Actually podmiot jest nad-nag≈Ç√≥wkiem: zajmuje cols N..N+1
    // Dane: col N = tydzie≈Ñ, col N+1 = kg

    const groups = []; // [{podmiot, typ, tCol, kgCol}]
    for (let ci = 0; ci < podmiotRow.length; ci++) {
      const v = podmiotRow[ci];
      if (!v || String(v).trim() === '' || String(v).trim() === 'SUMA') continue;
      const name = String(v).trim();
      if (name.toLowerCase().includes('numer') || name.toLowerCase().includes('ilo≈õƒá')) continue;
      const typ = PRODUCENCI.has(name) ? 'producent' : 'klient';
      // Szukamy najbli≈ºszej kolumny z 'numer tygodnia' lub liczbƒÖ w danych
      // Na podstawie wzorca: podmiot w ci, dane w ci, ci+1
      groups.push({podmiot: name, typ, tCol: ci, kgCol: ci+1});
    }

    // Iteracja wierszy danych (od row 6 = index 6)
    for (let ri = 6; ri < raw.length; ri++) {
      const row = raw[ri] || [];
      if (!row.some(c => c != null)) continue;

      for (const grp of groups) {
        const rawTydz = row[grp.tCol];
        const rawKg   = row[grp.kgCol];

        const tydzien = rawTydz != null ? parseInt(rawTydz) : null;
        const kg = rawKg != null ? parseFloat(rawKg) : null;

        if (tydzien == null || isNaN(tydzien)) continue;
        if (kg == null || isNaN(kg) || kg === 0) continue; // pomijamy zera

        allRows.push({
          owoc,
          podmiot: grp.podmiot,
          typ: grp.typ,
          tydzien,
          kg,
          _id: uid++,
          _sheet: sheetName,
        });
      }
    }
  }

  // Zapisz do localStorage
  try { localStorage.setItem(DATA_KEY, JSON.stringify(allRows)); } catch(e) {}

  buildUI();
}

// ================================================================
// BUILD UI AFTER DATA LOADED
// ================================================================
function buildUI() {
  document.getElementById('importBox').style.display = 'none';

  // Wype≈Çnij filtry
  buildFilters();

  // Poka≈º sekcje
  ['pfProd','sumProd','twProd','pfKlient','sumKlient','twKlient','pfBilans','twBilans'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = el.id.startsWith('pf') || el.id.startsWith('sum') ? 'flex' : 'block';
  });
  document.getElementById('btnEditProd').style.display = 'inline-flex';
  document.getElementById('btnEditKlient').style.display = 'inline-flex';

  applyAll();
}

function buildFilters() {
  const owocSet = [...new Set(allRows.map(r => r.owoc))].sort();
  const tydzSet = [...new Set(allRows.map(r => r.tydzien))].sort((a,b)=>a-b);
  const prodSet = [...new Set(allRows.filter(r=>r.typ==='producent').map(r=>r.podmiot))].sort();
  const klientSet = [...new Set(allRows.filter(r=>r.typ==='klient').map(r=>r.podmiot))].sort();

  function fill(id, vals, label='') {
    const sel = document.getElementById(id);
    const first = sel.options[0]?.textContent || '';
    sel.innerHTML = `<option value="">${first}</option>`;
    vals.forEach(v => { const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
  }

  fill('pOwoc', owocSet); fill('kOwoc', owocSet); fill('bOwoc', owocSet);
  fill('pTydz', tydzSet.map(String)); fill('kTydz', tydzSet.map(String)); fill('bTydz', tydzSet.map(String));
  fill('pProd', prodSet);
  fill('kKlient', klientSet);

  // Events
  ['pSearch','pOwoc','pTydz','pProd'].forEach(id => {
    document.getElementById(id).oninput = () => { prodPage=0; applyProd(); };
    document.getElementById(id).onchange = () => { prodPage=0; applyProd(); };
  });
  ['kSearch','kOwoc','kTydz','kKlient'].forEach(id => {
    document.getElementById(id).oninput = () => { klientPage=0; applyKlient(); };
    document.getElementById(id).onchange = () => { klientPage=0; applyKlient(); };
  });
  ['bOwoc','bTydz'].forEach(id => {
    document.getElementById(id).onchange = renderBilans;
  });
}

function applyAll() { applyProd(); applyKlient(); renderBilans(); }

// ================================================================
// PRODUCENCI
// ================================================================
function applyProd() {
  const search = document.getElementById('pSearch').value.toLowerCase();
  const owoc   = document.getElementById('pOwoc').value;
  const tydz   = document.getElementById('pTydz').value;
  const prod   = document.getElementById('pProd').value;

  prodRows = allRows.filter(r => {
    if (r.typ !== 'producent') return false;
    if (owoc && r.owoc !== owoc) return false;
    if (tydz && String(r.tydzien) !== tydz) return false;
    if (prod && r.podmiot !== prod) return false;
    if (search) { const h = (r.owoc+r.podmiot+r.tydzien).toLowerCase(); if (!h.includes(search)) return false; }
    return true;
  });

  if (prodSort.col) sortArr(prodRows, prodSort.col, prodSort.dir);

  updateProdSummary();
  renderProdTable();
  renderPag('prod');
  document.getElementById('tbProd').textContent = allRows.filter(r=>r.typ==='producent').length;
}

function updateProdSummary() {
  const kgTotal = prodRows.reduce((s,r) => {
    const kg = pending.prod[r._id] !== undefined ? parseFloat(pending.prod[r._id])||0 : r.kg;
    return s + kg;
  }, 0);
  document.getElementById('sProdCount').textContent = prodRows.length.toLocaleString('pl-PL');
  document.getElementById('sProdKg').textContent = fmt(kgTotal) + ' kg';
  document.getElementById('sProdN').textContent = new Set(prodRows.map(r=>r.podmiot)).size;
  document.getElementById('sProdOwoc').textContent = new Set(prodRows.map(r=>r.owoc)).size;
  document.getElementById('sProdTydz').textContent = new Set(prodRows.map(r=>r.tydzien)).size;
  document.getElementById('cProd').textContent = prodRows.length.toLocaleString('pl-PL') + ' wierszy';
}

function renderProdTable() {
  const rows = prodRows.slice(prodPage*PAGE, (prodPage+1)*PAGE);
  const em = editMode.prod;

  let cols = [
    {k:'owoc',    l:'Owoc',       s:true},
    {k:'podmiot', l:'Producent',  s:true},
    {k:'tydzien', l:'Tydzie≈Ñ',    s:true},
    {k:'kg',      l:'Ilo≈õƒá [kg]', s:true, num:true, edit:true},
  ];

  let h = '<table><thead><tr>';
  cols.forEach(c => {
    const cls = prodSort.col===c.k ? (prodSort.dir===1?'sort-asc':'sort-desc') : '';
    h += `<th class="${cls}${c.s?'':' no-sort'}" onclick="${c.s?`sortP('prod','${c.k}')`:''}">${c.l}</th>`;
  });
  h += '</tr></thead><tbody>';

  if (!rows.length) {
    h += `<tr><td colspan="4" style="text-align:center;padding:40px;color:var(--text-muted);font-family:'DM Mono',monospace;font-size:11px">Brak danych dla wybranych filtr√≥w</td></tr>`;
  } else {
    rows.forEach(r => {
      const curKg = pending.prod[r._id] !== undefined ? pending.prod[r._id] : r.kg;
      const changed = pending.prod[r._id] !== undefined;
      h += `<tr class="${changed?'edited-row':''}">`;
      h += `<td><span class="badge badge-owoc">${r.owoc}</span></td>`;
      h += `<td class="prod-col bold">${r.podmiot}</td>`;
      h += `<td class="num">T${r.tydzien}</td>`;
      if (em) {
        h += `<td class="num"><span class="ecell" contenteditable="true" data-id="${r._id}" data-typ="prod" onblur="onEdit(this)">${curKg}</span>${changed?'<span class="changed-dot" title="Zmieniono"></span>':''}</td>`;
      } else {
        h += `<td class="num">${fmt(curKg)} kg${changed?'<span class="changed-dot" title="Zmieniono"></span>':''}</td>`;
      }
      h += '</tr>';
    });
  }
  h += '</tbody></table>';
  document.getElementById('tsProd').innerHTML = h;
}

// ================================================================
// KLIENCI
// ================================================================
function applyKlient() {
  const search  = document.getElementById('kSearch').value.toLowerCase();
  const owoc    = document.getElementById('kOwoc').value;
  const tydz    = document.getElementById('kTydz').value;
  const klient  = document.getElementById('kKlient').value;

  klientRows = allRows.filter(r => {
    if (r.typ !== 'klient') return false;
    if (owoc && r.owoc !== owoc) return false;
    if (tydz && String(r.tydzien) !== tydz) return false;
    if (klient && r.podmiot !== klient) return false;
    if (search) { const h = (r.owoc+r.podmiot+r.tydzien).toLowerCase(); if (!h.includes(search)) return false; }
    return true;
  });

  if (klientSort.col) sortArr(klientRows, klientSort.col, klientSort.dir);

  const kgTotal = klientRows.reduce((s,r) => s + (parseFloat(pending.klient[r._id]??r.kg)||0), 0);
  document.getElementById('sKlientCount').textContent = klientRows.length.toLocaleString('pl-PL');
  document.getElementById('sKlientKg').textContent = fmt(kgTotal) + ' kg';
  document.getElementById('sKlientN').textContent = new Set(klientRows.map(r=>r.podmiot)).size;
  document.getElementById('sKlientOwoc').textContent = new Set(klientRows.map(r=>r.owoc)).size;
  document.getElementById('cKlient').textContent = klientRows.length.toLocaleString('pl-PL') + ' wierszy';
  document.getElementById('tbKlient').textContent = allRows.filter(r=>r.typ==='klient').length;

  renderKlientTable();
  renderPag('klient');
}

function renderKlientTable() {
  const rows = klientRows.slice(klientPage*PAGE, (klientPage+1)*PAGE);
  const em = editMode.klient;

  let h = '<table><thead><tr>';
  [['owoc','Owoc'],['podmiot','Klient'],['tydzien','Tydzie≈Ñ'],['kg','Zapotrzebowanie [kg]']].forEach(([k,l]) => {
    const cls = klientSort.col===k ? (klientSort.dir===1?'sort-asc':'sort-desc') : '';
    h += `<th class="${cls}" onclick="sortP('klient','${k}')">${l}</th>`;
  });
  h += '</tr></thead><tbody>';

  if (!rows.length) {
    h += `<tr><td colspan="4" style="text-align:center;padding:40px;color:var(--text-muted);font-family:'DM Mono',monospace;font-size:11px">Brak danych dla wybranych filtr√≥w</td></tr>`;
  } else {
    rows.forEach(r => {
      const curKg = pending.klient[r._id] !== undefined ? pending.klient[r._id] : r.kg;
      const changed = pending.klient[r._id] !== undefined;
      h += `<tr class="${changed?'edited-row':''}">`;
      h += `<td><span class="badge badge-owoc">${r.owoc}</span></td>`;
      h += `<td class="klient-col bold">${r.podmiot}</td>`;
      h += `<td class="num">T${r.tydzien}</td>`;
      if (em) {
        h += `<td class="num"><span class="ecell" contenteditable="true" data-id="${r._id}" data-typ="klient" onblur="onEdit(this)">${curKg}</span>${changed?'<span class="changed-dot"></span>':''}</td>`;
      } else {
        h += `<td class="num">${fmt(curKg)} kg${changed?'<span class="changed-dot"></span>':''}</td>`;
      }
      h += '</tr>';
    });
  }
  h += '</tbody></table>';
  document.getElementById('tsKlient').innerHTML = h;
}

// ================================================================
// BILANS
// ================================================================
function renderBilans() {
  if (!allRows.length) return;
  const owoc = document.getElementById('bOwoc').value;
  const tydz = document.getElementById('bTydz').value;

  // Agreguj per owoc+tydzie≈Ñ
  const map = {};
  allRows.forEach(r => {
    if (owoc && r.owoc !== owoc) return;
    if (tydz && String(r.tydzien) !== tydz) return;
    const key = r.owoc + '|' + r.tydzien;
    if (!map[key]) map[key] = {owoc: r.owoc, tydzien: r.tydzien, dostepne:0, zamowione:0};
    const kg = parseFloat(pending[r.typ]?.[r._id] ?? r.kg) || 0;
    if (r.typ === 'producent') map[key].dostepne += kg;
    else map[key].zamowione += kg;
  });

  bilansRows = Object.values(map).sort((a,b) => {
    if (a.owoc !== b.owoc) return a.owoc.localeCompare(b.owoc,'pl');
    return a.tydzien - b.tydzien;
  });

  document.getElementById('twBilans').style.display = 'block';
  document.getElementById('pfBilans').style.display = 'flex';
  document.getElementById('tbBilans').textContent = bilansRows.length;
  document.getElementById('cBilans').textContent = bilansRows.length + ' wierszy';

  let h = '<table><thead><tr><th>Owoc</th><th>Tydzie≈Ñ</th><th>Dostƒôpne (producenci)</th><th>Zam√≥wione (klienci)</th><th>Saldo</th></tr></thead><tbody>';
  if (!bilansRows.length) {
    h += `<tr><td colspan="5" style="text-align:center;padding:40px;color:var(--text-muted);font-family:'DM Mono',monospace;font-size:11px">Brak danych</td></tr>`;
  } else {
    bilansRows.forEach(r => {
      const delta = r.dostepne - r.zamowione;
      const cls = delta > 0 ? 'bilans-pos' : delta < 0 ? 'bilans-neg' : 'bilans-zero';
      const sign = delta > 0 ? '+' : '';
      h += `<tr>
        <td><span class="badge badge-owoc">${r.owoc}</span></td>
        <td class="num">T${r.tydzien}</td>
        <td class="num">${fmt(r.dostepne)} kg</td>
        <td class="num">${r.zamowione ? fmt(r.zamowione)+' kg' : '‚Äî'}</td>
        <td class="num ${cls}">${sign}${fmt(delta)} kg</td>
      </tr>`;
    });
  }
  h += '</tbody></table>';
  document.getElementById('tsBilans').innerHTML = h;
}

// ================================================================
// EDIT
// ================================================================
function onEdit(el) {
  const id  = parseInt(el.dataset.id);
  const typ = el.dataset.typ;
  const row = allRows.find(r => r._id === id);
  if (!row) return;
  const oldVal = parseFloat(pending[typ][id] ?? row.kg) || 0;
  const newVal = parseFloat(el.textContent.replace(',','.')) || 0;
  if (oldVal === newVal) return;
  pending[typ][id] = newVal;
  document.getElementById('btnSave'+cap(typ)).style.display = 'inline-flex';
  if (typ === 'prod') { updateProdSummary(); renderProdTable(); }
  else { applyKlient(); }
}

function cap(s) { return s.charAt(0).toUpperCase() + s.slice(1); }

function saveEdits(typ) {
  const changes = [];
  for (const [idStr, newKg] of Object.entries(pending[typ])) {
    const id = parseInt(idStr);
    const row = allRows.find(r => r._id === id);
    if (!row) continue;
    const oldKg = row.kg;
    changes.push({ owoc: row.owoc, podmiot: row.podmiot, tydzien: row.tydzien, oldKg, newKg, typ });
    row.kg = newKg;
  }
  if (!changes.length) { toast('Brak zmian'); return; }

  addHist({ changes, file: fileName, typ });
  try { localStorage.setItem(DATA_KEY, JSON.stringify(allRows)); } catch(e) {}
  pending[typ] = {};
  document.getElementById('btnSave'+cap(typ)).style.display = 'none';
  if (typ === 'prod') applyProd();
  else applyKlient();
  renderBilans();
  toast('Zapisano ' + changes.length + ' zmian', 'ok');
}

function toggleEdit(typ) {
  if (editMode[typ] && Object.keys(pending[typ]).length) saveEdits(typ);
  editMode[typ] = !editMode[typ];
  const btn = document.getElementById('btnEdit'+cap(typ));
  btn.textContent = editMode[typ] ? '‚úÖ Zako≈Ñcz edycjƒô' : '‚úèÔ∏è Tryb edycji';
  btn.style.background  = editMode[typ] ? 'rgba(250,66,17,.08)' : '';
  btn.style.borderColor = editMode[typ] ? 'rgba(250,66,17,.3)' : '';
  btn.style.color       = editMode[typ] ? 'var(--orange)' : '';
  if (typ === 'prod') renderProdTable();
  else renderKlientTable();
}

// ================================================================
// SORT + PAGINATION
// ================================================================
function sortP(typ, col) {
  const st = typ === 'prod' ? prodSort : klientSort;
  if (st.col === col) st.dir *= -1; else { st.col = col; st.dir = 1; }
  if (typ === 'prod') { prodPage = 0; applyProd(); }
  else { klientPage = 0; applyKlient(); }
}

function sortArr(arr, col, dir) {
  arr.sort((a,b) => {
    const av = a[col] ?? '', bv = b[col] ?? '';
    const an = parseFloat(av), bn = parseFloat(bv);
    if (!isNaN(an) && !isNaN(bn)) return (an-bn)*dir;
    return String(av).localeCompare(String(bv),'pl')*dir;
  });
}

function resetF(typ) {
  if (typ === 'prod') {
    ['pSearch','pOwoc','pTydz','pProd'].forEach(id => document.getElementById(id).value='');
    prodSort={col:null,dir:1}; prodPage=0; applyProd();
  } else if (typ === 'klient') {
    ['kSearch','kOwoc','kTydz','kKlient'].forEach(id => document.getElementById(id).value='');
    klientSort={col:null,dir:1}; klientPage=0; applyKlient();
  } else {
    ['bOwoc','bTydz'].forEach(id => document.getElementById(id).value='');
    renderBilans();
  }
}

function renderPag(typ) {
  const rows = typ === 'prod' ? prodRows : klientRows;
  const curPage = typ === 'prod' ? prodPage : klientPage;
  const elId = 'pag' + cap(typ);
  const total = Math.ceil(rows.length / PAGE);
  const el = document.getElementById(elId);
  if (total <= 1) { el.style.display = 'none'; return; }
  el.style.display = 'flex';
  let h = `<button class="pb" onclick="goPag('${typ}',${curPage-1})" ${curPage===0?'disabled':''}>‚Üê Poprz.</button>`;
  let s=Math.max(0,curPage-3), e=Math.min(total-1,s+6);
  if (e-s<6) s=Math.max(0,e-6);
  if (s>0) h += `<button class="pb" onclick="goPag('${typ}',0)">1</button><span class="pi">‚Ä¶</span>`;
  for(let i=s;i<=e;i++) h += `<button class="pb ${i===curPage?'active':''}" onclick="goPag('${typ}',${i})">${i+1}</button>`;
  if (e<total-1) h += `<span class="pi">‚Ä¶</span><button class="pb" onclick="goPag('${typ}',${total-1})">${total}</button>`;
  h += `<button class="pb" onclick="goPag('${typ}',${curPage+1})" ${curPage===total-1?'disabled':''}>Nast. ‚Üí</button>`;
  h += `<span class="pi">${curPage+1} / ${total}</span>`;
  el.innerHTML = h;
}

function goPag(typ, p) {
  const rows = typ === 'prod' ? prodRows : klientRows;
  const total = Math.ceil(rows.length/PAGE);
  p = Math.max(0, Math.min(total-1, p));
  if (typ === 'prod') { prodPage = p; renderProdTable(); renderPag('prod'); }
  else { klientPage = p; renderKlientTable(); renderPag('klient'); }
}

// ================================================================
// HISTORY
// ================================================================
function renderHist() {
  const h = getHist();
  const el = document.getElementById('histList');
  if (!h.length) { el.innerHTML = '<div class="h-empty">üì≠ Brak zmian.<br>Edytuj dane i kliknij Zapisz.</div>'; return; }
  el.innerHTML = h.map(entry => {
    const dt = new Date(entry.ts);
    const dtStr = dt.toLocaleDateString('pl-PL') + ' ' + dt.toLocaleTimeString('pl-PL',{hour:'2-digit',minute:'2-digit'});
    return entry.changes.map(ch => `
      <div class="h-item">
        <div class="h-time">${dtStr}</div>
        <div class="h-body">
          <div class="h-id">${ch.owoc} ¬∑ T${ch.tydzien} ¬∑ ${ch.podmiot}</div>
          <div class="h-ch">
            <span class="h-old">${fmt(ch.oldKg)} kg</span>
            <span class="h-arr">‚Üí</span>
            <span class="h-new">${fmt(ch.newKg)} kg</span>
          </div>
          <div class="h-meta">${entry.file || '‚Äî'} ¬∑ ${ch.typ}</div>
        </div>
      </div>`).join('');
  }).join('');
}

function clearHist() {
  if (!confirm('UsunƒÖƒá ca≈ÇƒÖ historiƒô?')) return;
  localStorage.removeItem(HIST_KEY);
  updateHistBadge();
  renderHist();
  toast('Historia wyczyszczona');
}

function exportChanges() {
  const h = getHist();
  if (!h.length) { toast('Brak zmian'); return; }
  const rows = [['Data','Owoc','Tydzie≈Ñ','Podmiot','Typ','Stara ilo≈õƒá [kg]','Nowa ilo≈õƒá [kg]','Plik']];
  h.forEach(e => {
    const dt = new Date(e.ts).toLocaleString('pl-PL');
    e.changes.forEach(ch => rows.push([dt, ch.owoc, ch.tydzien, ch.podmiot, ch.typ, ch.oldKg, ch.newKg, e.file||'‚Äî']));
  });
  const ws = XLSX.utils.aoa_to_sheet(rows);
  const wb2 = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb2, ws, 'Historia');
  XLSX.writeFile(wb2, 'historia-zmian-2026.xlsx');
  toast('Wyeksportowano', 'ok');
}

// ================================================================
// AUTO-LOAD FROM REPO
// ================================================================
function tryAutoLoad() {
  // 1. Dane wygenerowane przez serwer (planowanie-data.js) ‚Äî najbardziej niezawodne
  if (typeof window.PLAN_DATA !== 'undefined' && window.PLAN_DATA.length > 0) {
    allRows = window.PLAN_DATA;
    fileName = 'Planowanie + sprzeda≈º 2026.xlsx';
    buildUI();
    return;
  }

  // 2. Dane z poprzedniej sesji (localStorage)
  try {
    const saved = JSON.parse(localStorage.getItem(DATA_KEY)||'null');
    if (saved && saved.length > 0) {
      allRows = saved;
      fileName = 'dane z pamiƒôci';
      buildUI();
      toast('Przywr√≥cono dane z poprzedniej sesji');
      return;
    }
  } catch(e) {}

  // 3. Brak danych ‚Äî poka≈º strefƒô importu
  document.getElementById('importBox').style.display = 'block';
}

// ================================================================
// INIT
// ================================================================
updateHistBadge();
tryAutoLoad();
</script>
</body>
</html>
