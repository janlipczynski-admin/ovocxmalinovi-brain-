<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Harmonogram zakupÃ³w opakowaÅ„ â€” OvocxMalinovi</title>
<script src="zakupy-data.js"></script>
<script src="planowanie-data.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{--orange:#fa4211;--purple:#9013fe;--grad:linear-gradient(135deg,#fa4211,#9013fe);--bg:#f7f7f5;--white:#fff;--border:#e8e6e1;--border2:#d8d5ce;--text:#1a1a18;--text-dim:#6b6b65;--text-muted:#a8a8a0;--surface2:#f2f0eb;--green:#16a34a;--green-bg:rgba(22,163,74,.08);--yellow:#d97706;--yellow-bg:rgba(217,119,6,.08);--red:#dc2626;--red-bg:rgba(220,38,38,.08);--shadow:0 1px 3px rgba(0,0,0,.06),0 1px 2px rgba(0,0,0,.04);--shadow-md:0 4px 12px rgba(0,0,0,.08)}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;min-height:100vh;font-size:14px}

header{display:flex;align-items:center;justify-content:space-between;padding:12px 32px;background:var(--white);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:200;box-shadow:var(--shadow);gap:12px}
.back-btn{display:flex;align-items:center;gap:7px;text-decoration:none;color:var(--text-dim);font-size:13px;font-weight:500;transition:color .15s;white-space:nowrap}
.back-btn:hover{color:var(--orange)}
.page-title{font-size:15px;font-weight:700}
.btn{display:inline-flex;align-items:center;gap:5px;padding:7px 13px;border-radius:7px;font-size:12px;font-family:'Plus Jakarta Sans',sans-serif;cursor:pointer;transition:all .15s;border:1px solid var(--border2);background:var(--white);color:var(--text-dim);font-weight:500}
.btn:hover{background:var(--surface2)}
.btn-primary{background:var(--grad);color:#fff;border:none;font-weight:600}
.btn-primary:hover{opacity:.9}

.mod-nav{display:flex;background:var(--white);border-bottom:1px solid var(--border);padding:0 32px;gap:2px}
.mod-nav a{display:inline-flex;align-items:center;gap:5px;padding:9px 16px;font-size:12px;font-weight:500;color:var(--text-muted);text-decoration:none;border-bottom:2px solid transparent;transition:all .15s;white-space:nowrap}
.mod-nav a:hover{color:var(--text-dim)}
.mod-nav a.active{color:var(--orange);border-bottom-color:var(--orange);font-weight:600}

main{padding:20px 32px 100px;max-width:1600px;margin:0 auto}

.page-desc{background:var(--white);border:1px solid var(--border);border-radius:10px;padding:14px 20px;margin-bottom:20px;font-size:13px;color:var(--text-dim);line-height:1.6;display:flex;align-items:flex-start;justify-content:space-between;gap:20px}
.page-desc p strong{color:var(--text)}
.desc-actions{display:flex;gap:8px;flex-shrink:0}

/* SUMMARY CARDS */
.summary-row{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;margin-bottom:24px}
.sum-card{background:var(--white);border:1px solid var(--border);border-radius:10px;padding:14px 16px;box-shadow:var(--shadow)}
.sum-card-label{font-size:10px;text-transform:uppercase;letter-spacing:.06em;color:var(--text-muted);font-weight:600;margin-bottom:5px;display:flex;align-items:center;gap:5px}
.sum-dot{width:8px;height:8px;border-radius:2px;display:inline-block}
.sum-card-val{font-size:20px;font-weight:700;font-variant-numeric:tabular-nums;font-family:'DM Mono',monospace}
.sum-card-sub{font-size:10px;color:var(--text-muted);margin-top:2px}

/* HARMONOGRAM TABLE */
.table-wrap{overflow-x:auto;border-radius:12px;box-shadow:var(--shadow-md);background:var(--white);border:1px solid var(--border)}
.harm-table{width:100%;border-collapse:collapse;min-width:900px}
.harm-table th{padding:10px 14px;font-size:10px;text-transform:uppercase;letter-spacing:.06em;color:var(--text-muted);font-weight:600;background:var(--surface2);border-bottom:1px solid var(--border);white-space:nowrap;text-align:right}
.harm-table th:first-child{text-align:left;min-width:180px}
.harm-table th.th-total{background:var(--bg);border-left:2px solid var(--border2)}
.harm-weeks{display:block;font-size:9px;color:var(--text-muted);font-weight:400;margin-top:1px;font-family:'DM Mono',monospace}
.harm-table td{padding:0;border-bottom:1px solid var(--border);vertical-align:middle}
.harm-table tbody tr:last-child td{border-bottom:none}
.harm-table tbody tr:hover td{background:rgba(250,66,17,.03)}
.harm-table tfoot td{background:var(--surface2);border-top:2px solid var(--border2);font-weight:700;padding:10px 14px;font-family:'DM Mono',monospace;font-size:12px;text-align:right}
.harm-table tfoot td:first-child{text-align:left;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px}
.harm-table tfoot td.td-total{border-left:2px solid var(--border2);background:var(--bg)}

/* ROW LABEL */
.row-label{display:flex;align-items:center;gap:8px;padding:10px 14px}
.row-dot{width:10px;height:10px;border-radius:2px;flex-shrink:0}
.row-name{font-size:13px;font-weight:600}
.row-clients{font-size:10px;color:var(--text-muted);margin-top:1px}

/* CELL */
.cell-wrap{position:relative;height:100%}
.cell-val{display:block;padding:10px 14px;text-align:right;font-family:'DM Mono',monospace;font-size:12px;cursor:pointer;min-width:90px;transition:background .1s;user-select:none}
.cell-val:hover{background:rgba(250,66,17,.06)}
.cell-val.custom{color:var(--orange);font-weight:700}
.cell-val.zero{color:var(--text-muted)}
.cell-total-col{border-left:2px solid var(--border2)}
td.cell-total-col .cell-val{background:var(--bg);cursor:default}
td.cell-total-col .cell-val:hover{background:var(--bg)}
.cell-input{display:none;width:100%;padding:10px 14px;text-align:right;font-family:'DM Mono',monospace;font-size:12px;border:none;outline:2px solid var(--orange);outline-offset:-2px;background:#fff;color:var(--text)}

/* LEGEND */
.legend{display:flex;align-items:center;gap:16px;font-size:11px;color:var(--text-dim);margin-bottom:12px}
.leg-item{display:flex;align-items:center;gap:5px}
.leg-dot{width:8px;height:8px;border-radius:50%}
.leg-custom{font-family:'DM Mono',monospace;color:var(--orange);font-weight:700}

/* SAVE BAR */
.save-bar{position:fixed;bottom:0;left:0;right:0;background:rgba(255,255,255,.95);backdrop-filter:blur(8px);border-top:1px solid var(--border);padding:12px 32px;display:flex;align-items:center;gap:10px;z-index:100;box-shadow:0 -2px 10px rgba(0,0,0,.05)}
.save-status{font-size:12px;color:var(--green);margin-right:auto;font-weight:500}
.save-status.unsaved{color:var(--yellow)}
</style>
</head>
<body>

<header>
  <a href="index.html" class="back-btn">â† Baza wiedzy</a>
  <span class="page-title">Harmonogram zakupÃ³w opakowaÅ„ 2026</span>
  <span></span>
</header>

<nav class="mod-nav">
  <a href="zakupy-planowanie.html">ğŸ“Š Stan magazynowy</a>
  <a href="zakupy-klienci.html">ğŸ“¦ Konfekcja per klient</a>
  <a href="zakupy-harmonogram.html" class="active">ğŸ“… Harmonogram zakupÃ³w</a>
</nav>

<main>

<div class="page-desc">
  <p>
    Prognoza zapotrzebowania na kartony w podziale na <strong>miesiÄ…ce sezonu 2026</strong>.<br>
    WartoÅ›ci obliczone z planu sprzedaÅ¼y Ã— miks konfekcji per klient (z zakÅ‚adki <a href="zakupy-klienci.html">Konfekcja per klient</a>).
    <strong>Kliknij komÃ³rkÄ™</strong> aby wpisaÄ‡ wÅ‚asnÄ… wartoÅ›Ä‡ â€” zmiany zapisywane sÄ… w przeglÄ…darce.
  </p>
  <div class="desc-actions">
    <button class="btn" onclick="resetSchedule()" title="WrÃ³Ä‡ do wartoÅ›ci z planu">â†º Resetuj</button>
    <button class="btn btn-primary" onclick="saveSchedule()">ğŸ’¾ Zapisz zmiany</button>
  </div>
</div>

<div class="summary-row" id="summary-row"></div>

<div class="legend">
  <span class="leg-item"><span class="leg-dot" style="background:var(--text-muted)"></span> WartoÅ›Ä‡ z planu</span>
  <span class="leg-item"><span class="leg-custom">â– </span> RÄ™cznie edytowane</span>
  <span>Kliknij komÃ³rkÄ™ aby edytowaÄ‡ Â· Enter lub klik poza polem aby zatwierdziÄ‡</span>
</div>

<div class="table-wrap">
  <table class="harm-table" id="harm-table">
    <thead id="harm-thead"></thead>
    <tbody id="harm-tbody"></tbody>
    <tfoot id="harm-tfoot"></tfoot>
  </table>
</div>

</main>

<div class="save-bar">
  <span class="save-status" id="save-status"></span>
  <button class="btn" onclick="resetSchedule()">â†º WrÃ³Ä‡ do planu bazowego</button>
  <button class="btn btn-primary" onclick="saveSchedule()">ğŸ’¾ Zapisz zmiany</button>
</div>

<script>
// â”€â”€ DEFINICJE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MONTHS = [
  { id:'maj', label:'Maj',        weeks:[18,19,20,21,22] },
  { id:'cze', label:'Czerwiec',   weeks:[23,24,25,26]    },
  { id:'lip', label:'Lipiec',     weeks:[27,28,29,30]    },
  { id:'sie', label:'SierpieÅ„',   weeks:[31,32,33,34,35] },
  { id:'wrz', label:'WrzesieÅ„',   weeks:[36,37,38,39]    },
  { id:'paz', label:'PaÅºdziernik',weeks:[40,41,42,43]    },
  { id:'lis', label:'Listopad',   weeks:[44,45,46]       },
];

const KARTON_TYPY = [
  { id:'mb',  label:'MaÅ‚y Biedronka',       color:'#f97316', clients:'Biedronka',
    filter: p => p.includes('PEÅNE') && p.includes('MAÅY') && (p.includes('X6') || p.includes('250X8')) },
  { id:'mz',  label:'MaÅ‚y zielona deska',   color:'#16a34a', clients:'OGL, Frutania, Special Fruitâ€¦',
    filter: p => p.includes('PEÅNE') && p.includes('MAÅY') && p.includes('X12') },
  { id:'mc',  label:'MaÅ‚y czarny / apla',   color:'#6b7280', clients:'Berry World, Kaczmarekâ€¦',
    filter: p => p.includes('PROSTE') && p.includes('MAÅY') },
  { id:'dzk', label:'DuÅ¼y ziel. klejony',   color:'#2563eb', clients:'Dino, Frutaniaâ€¦',
    filter: p => p.includes('PEÅNE') && p.includes('DUÅ»Y') && p.includes('KLEJONY') },
  { id:'dzs', label:'DuÅ¼y ziel. skÅ‚adany',  color:'#0ea5e9', clients:'Biedronka, Dino, SanLucarâ€¦',
    filter: p => p.includes('PEÅNE') && p.includes('DUÅ»Y') && p.includes('SKÅADANY') },
  { id:'dck', label:'DuÅ¼y czar. klejony',   color:'#7c3aed', clients:'OGLâ€¦',
    filter: p => p.includes('PROSTE') && p.includes('DUÅ»Y') && p.includes('KLEJONY') },
  { id:'dcs', label:'DuÅ¼y czar. skÅ‚adany',  color:'#9013fe', clients:'OGL, Garden Fruttaâ€¦',
    filter: p => p.includes('PROSTE') && p.includes('DUÅ»Y') && p.includes('SKÅADANY') },
];

// â”€â”€ DANE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ZCP_DEFAULT = (window.ZAKUPY_DATA || {}).zp_client_pak || {};
const LS_PAK  = 'oxm_klient_pak_v1';
const LS_HARM = 'oxm_harmonogram_v1';

// Load assignments (saved or default from ZCP)
function loadPak() {
  try { const s = localStorage.getItem(LS_PAK); if (s) return JSON.parse(s); } catch(e) {}
  // fallback: convert ZCP to share format
  const r = {};
  Object.entries(ZCP_DEFAULT).forEach(([c, paks]) => {
    const total = paks.reduce((s, v) => s + v.kg_zp, 0);
    r[c] = paks.map(v => ({
      pak: v.pak, kgpk: v.kgpk,
      share: total > 0 ? +(v.kg_zp / total * 100).toFixed(2) : 0
    })).sort((a, b) => b.share - a.share);
  });
  // Average mix for missing clients
  const avg = buildAvgMix(r);
  const PLAN_DATA_ALL = window.PLAN_DATA || [];
  const clients = [...new Set(PLAN_DATA_ALL.filter(x => x.typ==='klient').map(x => x.podmiot))];
  clients.forEach(c => { if (!r[c]) r[c] = avg; });
  return r;
}

function buildAvgMix(pak) {
  const avg = {};
  Object.values(pak).forEach(paks => {
    paks.forEach(v => {
      if (!avg[v.pak]) avg[v.pak] = { kg: 0, kgpk: v.kgpk };
      avg[v.pak].kg += v.share;
    });
  });
  const total = Object.values(avg).reduce((s, v) => s + v.kg, 0);
  return Object.entries(avg).map(([pak, v]) => ({
    pak, kgpk: v.kgpk,
    share: total > 0 ? +(v.kg / total * 100).toFixed(2) : 0
  }));
}

const PAK = loadPak();

// Weekly plan: week -> {client -> kg}
const PLAN_DATA_ALL = window.PLAN_DATA || [];
const PLAN_BY_WEEK = {};
PLAN_DATA_ALL.filter(r => r.typ === 'klient').forEach(r => {
  if (!PLAN_BY_WEEK[r.tydzien]) PLAN_BY_WEEK[r.tydzien] = {};
  PLAN_BY_WEEK[r.tydzien][r.podmiot] = (PLAN_BY_WEEK[r.tydzien][r.podmiot] || 0) + (r.kg || 0);
});

// â”€â”€ OBLICZENIA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function computeBase() {
  const base = {};
  MONTHS.forEach(m => {
    base[m.id] = {};
    KARTON_TYPY.forEach(kt => {
      let total = 0;
      m.weeks.forEach(w => {
        Object.entries(PLAN_BY_WEEK[w] || {}).forEach(([client, planKg]) => {
          const paks     = PAK[client] || [];
          const shareSum = paks.reduce((s, v) => s + v.share, 0);
          if (!shareSum) return;
          paks.forEach(v => {
            if (!kt.filter(v.pak)) return;
            const shareNorm = v.share / shareSum;
            if (v.kgpk > 0) total += planKg * shareNorm / v.kgpk;
          });
        });
      });
      base[m.id][kt.id] = Math.round(total);
    });
  });
  return base;
}

let BASE = computeBase();
let SAVED = {};
try { SAVED = JSON.parse(localStorage.getItem(LS_HARM)) || {}; } catch(e) { SAVED = {}; }

function getValue(monthId, ktId) {
  return (SAVED[monthId] && SAVED[monthId][ktId] != null)
    ? SAVED[monthId][ktId]
    : (BASE[monthId] ? BASE[monthId][ktId] : 0);
}

function isCustom(monthId, ktId) {
  return SAVED[monthId] && SAVED[monthId][ktId] != null;
}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
  renderSummary();
  renderTable();
}

function renderSummary() {
  const row = document.getElementById('summary-row');
  row.innerHTML = KARTON_TYPY.map(kt => {
    const total = MONTHS.reduce((s, m) => s + getValue(m.id, kt.id), 0);
    return `<div class="sum-card">
      <div class="sum-card-label">
        <span class="sum-dot" style="background:${kt.color}"></span>${kt.label}
      </div>
      <div class="sum-card-val" id="sumcard_${kt.id}">${fmtK(total)}</div>
      <div class="sum-card-sub">kartonÃ³w Â· sezon 2026</div>
    </div>`;
  }).join('');
}

function renderTable() {
  // HEAD
  document.getElementById('harm-thead').innerHTML = `<tr>
    <th>Typ kartonu</th>
    ${MONTHS.map(m =>
      `<th>${m.label}<span class="harm-weeks">wk ${m.weeks[0]}â€“${m.weeks[m.weeks.length-1]}</span></th>`
    ).join('')}
    <th class="th-total">Razem 2026</th>
  </tr>`;

  // BODY
  document.getElementById('harm-tbody').innerHTML = KARTON_TYPY.map(kt => {
    const rowTotal = MONTHS.reduce((s, m) => s + getValue(m.id, kt.id), 0);
    const cells = MONTHS.map(m => {
      const val = getValue(m.id, kt.id);
      const custom = isCustom(m.id, kt.id);
      return `<td>
        <span class="cell-val${custom ? ' custom' : ''}${val === 0 ? ' zero' : ''}"
          id="cv_${kt.id}_${m.id}"
          onclick="startEdit('${kt.id}','${m.id}')">${fmtN(val)}</span>
        <input class="cell-input" id="ci_${kt.id}_${m.id}" type="number" min="0"
          onblur="endEdit('${kt.id}','${m.id}')"
          onkeydown="onCellKey(event,'${kt.id}','${m.id}')">
      </td>`;
    }).join('');
    return `<tr>
      <td>
        <div class="row-label">
          <span class="row-dot" style="background:${kt.color}"></span>
          <div>
            <div class="row-name">${kt.label}</div>
            <div class="row-clients">${kt.clients}</div>
          </div>
        </div>
      </td>
      ${cells}
      <td class="cell-total-col">
        <span class="cell-val" id="rt_${kt.id}">${fmtK(rowTotal)}</span>
      </td>
    </tr>`;
  }).join('');

  // FOOT
  document.getElementById('harm-tfoot').innerHTML = `<tr>
    <td>RAZEM kartony</td>
    ${MONTHS.map(m => {
      const colTotal = KARTON_TYPY.reduce((s, kt) => s + getValue(m.id, kt.id), 0);
      return `<td id="ft_${m.id}">${fmtK(colTotal)}</td>`;
    }).join('')}
    <td class="td-total" id="ft_total">${fmtK(
      MONTHS.reduce((s, m) => s + KARTON_TYPY.reduce((ss, kt) => ss + getValue(m.id, kt.id), 0), 0)
    )}</td>
  </tr>`;
}

// â”€â”€ CELL EDITING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let activeEdit = null;

function startEdit(ktId, monthId) {
  if (activeEdit) endEdit(activeEdit.kt, activeEdit.m);
  const valEl = document.getElementById('cv_' + ktId + '_' + monthId);
  const inpEl = document.getElementById('ci_' + ktId + '_' + monthId);
  if (!valEl || !inpEl) return;
  activeEdit = { kt: ktId, m: monthId };
  inpEl.value = getValue(monthId, ktId);
  valEl.style.display = 'none';
  inpEl.style.display = 'block';
  inpEl.focus();
  inpEl.select();
}

function endEdit(ktId, monthId) {
  const valEl = document.getElementById('cv_' + ktId + '_' + monthId);
  const inpEl = document.getElementById('ci_' + ktId + '_' + monthId);
  if (!valEl || !inpEl) return;
  if (activeEdit && activeEdit.kt === ktId && activeEdit.m === monthId) activeEdit = null;

  const newVal = parseInt(inpEl.value, 10);
  const base   = (BASE[monthId] || {})[ktId] || 0;

  if (!isNaN(newVal)) {
    if (newVal === base) {
      // Remove custom if matches base
      if (SAVED[monthId]) { delete SAVED[monthId][ktId]; if (!Object.keys(SAVED[monthId]).length) delete SAVED[monthId]; }
    } else {
      if (!SAVED[monthId]) SAVED[monthId] = {};
      SAVED[monthId][ktId] = newVal;
    }
  }

  // Update display
  const val    = getValue(monthId, ktId);
  const custom = isCustom(monthId, ktId);
  valEl.textContent = fmtN(val);
  valEl.className = 'cell-val' + (custom ? ' custom' : '') + (val === 0 ? ' zero' : '');
  inpEl.style.display = 'none';
  valEl.style.display = 'block';

  updateTotals(ktId, monthId);
  markUnsaved();
}

function onCellKey(e, ktId, monthId) {
  if (e.key === 'Enter' || e.key === 'Tab') {
    e.preventDefault();
    endEdit(ktId, monthId);
    // Move to next month if Tab
    if (e.key === 'Tab') {
      const mi = MONTHS.findIndex(m => m.id === monthId);
      if (mi >= 0 && mi + 1 < MONTHS.length) startEdit(ktId, MONTHS[mi + 1].id);
    }
  } else if (e.key === 'Escape') {
    const inpEl = document.getElementById('ci_' + ktId + '_' + monthId);
    const valEl = document.getElementById('cv_' + ktId + '_' + monthId);
    if (inpEl) inpEl.style.display = 'none';
    if (valEl) valEl.style.display = 'block';
    activeEdit = null;
  }
}

function updateTotals(ktId, monthId) {
  // Row total
  const rowTotal = MONTHS.reduce((s, m) => s + getValue(m.id, ktId), 0);
  const rtEl = document.getElementById('rt_' + ktId);
  if (rtEl) rtEl.textContent = fmtK(rowTotal);

  // Summary card
  const scEl = document.getElementById('sumcard_' + ktId);
  if (scEl) scEl.textContent = fmtK(rowTotal);

  // Column total
  const colTotal = KARTON_TYPY.reduce((s, kt) => s + getValue(monthId, kt.id), 0);
  const ftEl = document.getElementById('ft_' + monthId);
  if (ftEl) ftEl.textContent = fmtK(colTotal);

  // Grand total
  const grand = MONTHS.reduce((s, m) => s + KARTON_TYPY.reduce((ss, kt) => ss + getValue(m.id, kt.id), 0), 0);
  const gtEl = document.getElementById('ft_total');
  if (gtEl) gtEl.textContent = fmtK(grand);
}

// â”€â”€ SAVE / RESET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function markUnsaved() {
  const el = document.getElementById('save-status');
  if (el) { el.textContent = 'Niezapisane zmiany'; el.className = 'save-status unsaved'; }
}

function saveSchedule() {
  localStorage.setItem(LS_HARM, JSON.stringify(SAVED));
  const el = document.getElementById('save-status');
  if (el) { el.textContent = 'Zapisano!'; el.className = 'save-status'; }
  setTimeout(() => { if (el) el.textContent = ''; }, 2500);
}

function resetSchedule() {
  if (!confirm('UsunÄ…Ä‡ wszystkie rÄ™czne zmiany i wrÃ³ciÄ‡ do wartoÅ›ci z planu sprzedaÅ¼y?')) return;
  SAVED = {};
  localStorage.removeItem(LS_HARM);
  render();
}

// â”€â”€ FORMAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmtN(n) {
  if (!n) return '0';
  return Math.round(n).toLocaleString('pl-PL');
}
function fmtK(n) {
  if (!n || n === 0) return '0';
  if (Math.abs(n) >= 1000) return (n/1000).toFixed(1).replace('.0','') + 'k';
  return Math.round(n).toString();
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
render();
</script>
</body>
</html>
