<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dostawcy Karton√≥w 2026 ‚Äî OvocxMalinovi</title>
<script src="dostawcy-data.js"></script>
<script src="plan-zakupow-2026-data.js"></script>
<script src="planowanie-data.js"></script>
<script src="zakupy-data.js"></script>
<!-- SheetJS for Excel export -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --orange:#fa4211; --purple:#9013fe; --green:#16a34a; --blue:#2563eb; --yellow:#d97706;
  --grad:linear-gradient(135deg,#fa4211,#9013fe);
  --bg:#f7f7f5; --white:#fff;
  --border:#e8e6e1; --border2:#d8d5ce;
  --text:#1a1a18; --text-dim:#4a4a46; --text-muted:#8a8a82;
  --surface2:#f0ede8; --nav-h:52px;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
.nav{height:var(--nav-h);background:var(--white);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 20px;gap:12px;position:sticky;top:0;z-index:100}
.nav-logo{background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight:800;font-size:15px;letter-spacing:-.3px;white-space:nowrap}
.nav-sep{width:1px;height:20px;background:var(--border2)}
.nav-back{font-size:12px;color:var(--text-muted);text-decoration:none;display:flex;align-items:center;gap:4px;padding:4px 8px;border-radius:6px;transition:background .15s}
.nav-back:hover{background:var(--surface2);color:var(--text-dim)}
.nav-title{font-size:13px;font-weight:600;color:var(--text)}
.nav-spacer{flex:1}
.main{max-width:1200px;margin:0 auto;padding:20px 16px 48px}
/* Page head */
.page-head{margin-bottom:24px}
.page-head-row{display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:12px}
.page-head h1{font-size:22px;font-weight:800;letter-spacing:-.4px;line-height:1.2}
/* CTA button */
.gen-btn{background:var(--grad);color:white;border:none;padding:9px 18px;border-radius:9px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:700;cursor:pointer;letter-spacing:.2px;display:flex;align-items:center;gap:7px;transition:opacity .15s,transform .12s;white-space:nowrap;box-shadow:0 2px 8px rgba(250,66,17,.3)}
.gen-btn:hover{opacity:.9;transform:translateY(-1px)}
.gen-btn:active{transform:translateY(0)}
/* Supplier cards grid */
.cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px;margin-bottom:28px}
.sup-card{background:var(--white);border:2px solid var(--border);border-radius:12px;padding:16px;transition:all .15s;cursor:pointer;position:relative}
.sup-card:hover{border-color:var(--border2);box-shadow:0 2px 12px rgba(0,0,0,.07)}
.sup-card.selected{border-width:2px;box-shadow:0 0 0 3px rgba(250,66,17,.15)}
.sup-card-check{position:absolute;top:12px;right:12px;width:20px;height:20px;border-radius:50%;border:2px solid var(--border2);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;transition:all .15s;background:white}
.sup-card.selected .sup-card-check{background:var(--orange);border-color:var(--orange);color:white}
.sup-card-badge{display:inline-block;padding:3px 8px;border-radius:6px;font-size:10px;font-weight:800;font-family:'DM Mono',monospace;margin-bottom:8px;letter-spacing:.05em}
.sup-card h3{font-size:13px;font-weight:700;margin-bottom:4px;padding-right:24px}
.sup-card-sub{font-size:11px;color:var(--text-muted);margin-bottom:10px}
.sup-card-meta{font-size:11px;line-height:1.7;color:var(--text-dim)}
.sup-card-meta a{color:var(--blue);text-decoration:none}
.sup-card-meta a:hover{text-decoration:underline}
.sup-card-uwagi{font-size:10px;color:var(--text-muted);margin-top:8px;line-height:1.5;padding-top:8px;border-top:1px solid var(--border)}
.sup-card-actions{display:flex;gap:6px;margin-top:10px}
.btn-sm{padding:4px 10px;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;border:none;font-family:'Plus Jakarta Sans',sans-serif;transition:all .15s}
.btn-outline{background:transparent;border:1.5px solid var(--border2);color:var(--text-dim)}
.btn-outline:hover{border-color:var(--orange);color:var(--orange)}
.btn-edit{background:var(--surface2);color:var(--text-dim)}
.btn-edit:hover{background:var(--border2);color:var(--text)}
/* Section separator */
.section-head{display:flex;align-items:center;gap:10px;margin:28px 0 14px}
.section-head h2{font-size:14px;font-weight:800;letter-spacing:-.2px;white-space:nowrap}
.section-head::after{content:'';flex:1;height:1px;background:var(--border)}
/* Selected summary bar */
.sel-bar{background:var(--white);border:1.5px solid var(--orange);border-radius:10px;padding:12px 16px;display:flex;align-items:center;gap:12px;margin-bottom:18px;flex-wrap:wrap}
.sel-bar.hidden{display:none}
.sel-count{font-size:13px;font-weight:700;color:var(--orange)}
/* Edit modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:500;display:flex;align-items:center;justify-content:center;padding:16px}
.modal-overlay.hidden{display:none}
.modal-panel{background:var(--white);border-radius:14px;width:100%;max-width:560px;box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden}
.modal-head{background:var(--grad);padding:13px 18px;display:flex;align-items:center;justify-content:space-between}
.modal-head h3{color:white;font-size:13px;font-weight:800}
.modal-close{background:rgba(255,255,255,.18);border:none;color:white;width:26px;height:26px;border-radius:6px;cursor:pointer;font-size:14px}
.modal-body{padding:18px 20px;overflow-y:auto;max-height:70vh}
.modal-footer{padding:12px 20px;border-top:1px solid var(--border);background:var(--surface2);display:flex;justify-content:flex-end;gap:8px}
.field-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
.field-row.full{grid-template-columns:1fr}
.field-group label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--text-muted);display:block;margin-bottom:4px}
.field-group input,.field-group textarea{width:100%;padding:7px 10px;border:1.5px solid var(--border2);border-radius:7px;font-size:12px;font-family:'Plus Jakarta Sans',sans-serif;color:var(--text);transition:border-color .15s}
.field-group input:focus,.field-group textarea:focus{outline:none;border-color:var(--orange)}
.field-group textarea{resize:vertical;min-height:60px}
/* Wiz buttons */
.btn-primary{background:var(--grad);color:white;padding:8px 18px;border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:700;cursor:pointer;border:none}
.btn-primary:hover{opacity:.9}
.btn-ghost{background:transparent;border:1.5px solid var(--border2);color:var(--text-dim);padding:8px 18px;border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:700;cursor:pointer}
.btn-ghost:hover{border-color:var(--text-muted)}
/* RFQ wizard overlay */
.rfq-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:600;display:flex;align-items:flex-start;justify-content:center;overflow-y:auto;padding:24px 16px 48px}
.rfq-overlay.hidden{display:none}
.rfq-panel{background:var(--white);border-radius:16px;width:100%;max-width:860px;box-shadow:0 24px 80px rgba(0,0,0,.35);overflow:hidden;margin:auto}
.rfq-head{background:var(--grad);padding:14px 18px;display:flex;align-items:center;justify-content:space-between}
.rfq-head h2{color:white;font-size:14px;font-weight:800;letter-spacing:-.2px}
.rfq-close{background:rgba(255,255,255,.18);border:none;color:white;width:28px;height:28px;border-radius:7px;cursor:pointer;font-size:16px}
.rfq-close:hover{background:rgba(255,255,255,.35)}
.rfq-body{padding:20px}
.rfq-footer{padding:12px 20px;border-top:1px solid var(--border);background:var(--surface2);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px}
/* RFQ config */
.rfq-sec{margin-bottom:20px}
.rfq-sec h3{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--text-muted);margin-bottom:10px;display:flex;align-items:center;gap:6px}
.rfq-sec h3::after{content:'';flex:1;height:1px;background:var(--border)}
.rfq-chips{display:flex;gap:8px;flex-wrap:wrap}
.rfq-chip{padding:7px 13px;border:2px solid var(--border);border-radius:8px;cursor:pointer;font-size:11px;font-weight:600;transition:all .15s;user-select:none;background:transparent;font-family:'Plus Jakarta Sans',sans-serif;color:var(--text-muted)}
.rfq-chip.on{border-color:var(--orange);background:rgba(250,66,17,.07);color:var(--orange)}
.rfq-months{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-top:8px}
.mth2{padding:6px 4px;border:1.5px solid var(--border);border-radius:7px;text-align:center;cursor:pointer;font-size:11px;font-weight:600;transition:all .15s;background:transparent;font-family:'Plus Jakarta Sans',sans-serif;color:var(--text-muted)}
.mth2:hover{border-color:var(--border2)}
.mth2.sel{border-color:var(--blue);background:rgba(37,99,235,.09);color:var(--blue)}
.sup-chk-list{display:flex;flex-direction:column;gap:7px}
.sup-chk-item{display:flex;align-items:center;gap:10px;padding:9px 13px;border:2px solid var(--border);border-radius:9px;cursor:pointer;transition:all .15s;user-select:none}
.sup-chk-item.on{border-color:var(--orange);background:rgba(250,66,17,.04)}
.sup-chk-item input[type=checkbox]{accent-color:var(--orange);width:15px;height:15px;flex-shrink:0}
.sup-chk-badge{font-size:10px;font-weight:800;font-family:'DM Mono',monospace;padding:2px 7px;border-radius:5px}
.sup-chk-name{font-size:12px;font-weight:600}
.sup-chk-sub{font-size:10px;color:var(--text-muted);margin-left:auto}
/* Excel progress */
.xls-progress{display:flex;flex-direction:column;gap:8px}
.xls-row{display:flex;align-items:center;gap:10px;font-size:12px}
.xls-icon{font-size:16px;flex-shrink:0}
.xls-name{flex:1;font-weight:600}
.xls-status{font-size:11px;color:var(--text-muted)}
.xls-dl-btn{padding:5px 12px;background:var(--green);color:white;border:none;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif}
</style>
</head>
<body>

<!-- ‚îÄ‚îÄ Nav ‚îÄ‚îÄ -->
<nav class="nav">
  <span class="nav-logo">OvocxMalinovi</span>
  <span class="nav-sep"></span>
  <a href="zakupy-planowanie.html" class="nav-back">‚Üê Zakupy</a>
  <span class="nav-sep"></span>
  <span class="nav-title">Dostawcy Karton√≥w</span>
  <span class="nav-spacer"></span>
  <a href="zakupy-plan2026.html" style="font-size:11px;color:var(--text-muted);text-decoration:none;padding:4px 9px;border:1px solid var(--border2);border-radius:7px;font-family:'DM Mono',monospace">üì¶ Plan 2026</a>
</nav>

<main class="main">

  <!-- ‚îÄ‚îÄ Header ‚îÄ‚îÄ -->
  <div class="page-head">
    <div class="page-head-row">
      <div>
        <h1>Kartoteki Dostawc√≥w Karton√≥w</h1>
        <p style="font-size:12px;color:var(--text-muted);margin-top:4px">
          Dane kontaktowe dostawc√≥w ¬∑ Generuj zapytania ofertowe (Excel) dla wybranych dostawc√≥w
        </p>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn-ghost" style="display:flex;align-items:center;gap:6px;font-size:11px" onclick="openAddDostawca()">
          Ôºã Dodaj dostawcƒô
        </button>
        <button class="gen-btn" onclick="openRFQ()">
          <span style="font-size:14px">üìÑ</span> GENERUJ ZAPYTANIA OFERTOWE
        </button>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ Selected bar ‚îÄ‚îÄ -->
  <div class="sel-bar hidden" id="sel-bar">
    <span class="sel-count" id="sel-count-lbl">0 dostawc√≥w zaznaczonych</span>
    <span style="font-size:11px;color:var(--text-muted)">Kliknij "Generuj zapytania ofertowe" aby stworzyƒá pliki Excel</span>
    <button class="btn-primary" style="margin-left:auto" onclick="openRFQ()">üìÑ Generuj Excel dla zaznaczonych</button>
    <button class="btn-ghost" style="font-size:11px" onclick="clearSel()">Odznacz wszystkie</button>
  </div>

  <!-- ‚îÄ‚îÄ Supplier cards ‚îÄ‚îÄ -->
  <div class="section-head"><h2>Dostawcy</h2></div>
  <div class="cards-grid" id="cards-grid"></div>

</main>

<!-- ‚îÄ‚îÄ Edit/Add dostawca modal ‚îÄ‚îÄ -->
<div class="modal-overlay hidden" id="edit-modal">
  <div class="modal-panel">
    <div class="modal-head">
      <h3 id="edit-modal-title">Edytuj dostawcƒô</h3>
      <button class="modal-close" onclick="closeEditModal()">‚úï</button>
    </div>
    <div class="modal-body" id="edit-modal-body"></div>
    <div class="modal-footer">
      <button class="btn-ghost" onclick="closeEditModal()">Anuluj</button>
      <button class="btn-primary" onclick="saveDostawca()">Zapisz zmiany</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ RFQ Wizard ‚îÄ‚îÄ -->
<div class="rfq-overlay hidden" id="rfq-overlay">
  <div class="rfq-panel">
    <div class="rfq-head">
      <h2>üìÑ Generuj Zapytania Ofertowe ‚Äî Excel</h2>
      <button class="rfq-close" onclick="closeRFQ()">‚úï</button>
    </div>
    <div class="rfq-body" id="rfq-body"></div>
    <div class="rfq-footer" id="rfq-footer"></div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let dostawcy  = JSON.parse(JSON.stringify(window.DOSTAWCY_DATA.dostawcy)); // mutable copy
let selected  = new Set();
let editingId = null;

const fmt = n => n == null ? '‚Äî' : Math.round(n).toLocaleString('pl-PL');

// ‚îÄ‚îÄ Render cards ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCards() {
  const grid = document.getElementById('cards-grid');
  grid.innerHTML = dostawcy.filter(d => d.aktywny).map(d => {
    const isSel = selected.has(d.id);
    const colorStyle = `background:${d.kolor}20;color:${d.kolor};border:1px solid ${d.kolor}40`;
    return `
    <div class="sup-card ${isSel?'selected':''}" id="card-${d.id}"
         style="${isSel?'border-color:'+d.kolor:''}"
         onclick="toggleSel('${d.id}')">
      <div class="sup-card-check">${isSel?'‚úì':''}</div>
      <div class="sup-card-badge" style="${colorStyle}">${d.skrot}</div>
      <h3>${d.nazwa}</h3>
      <div class="sup-card-sub">${d.miasto ? d.kod_pocztowy+' '+d.miasto+', '+d.kraj : d.kraj}</div>
      <div class="sup-card-meta">
        ${d.telefon && d.telefon !== 'do uzupe≈Çnienia' ? `üìû ${d.telefon}<br>` : ''}
        ${d.email && d.email !== 'do uzupe≈Çnienia' ? `‚úâÔ∏è <a href="mailto:${d.email}" onclick="e=>{e.stopPropagation()}">${d.email}</a><br>` : ''}
        ${d.www ? `üåê <a href="${d.www}" target="_blank" onclick="event.stopPropagation()">${d.www.replace('https://','')}</a><br>` : ''}
        ${d.kontakt_os ? `üë§ ${d.kontakt_os}<br>` : ''}
        ${d.nip ? `<span style="font-family:'DM Mono',monospace;font-size:10px;color:var(--text-muted)">NIP: ${d.nip}</span>` : ''}
      </div>
      ${d.uwagi ? `<div class="sup-card-uwagi">${d.uwagi}</div>` : ''}
      <div class="sup-card-actions" onclick="event.stopPropagation()">
        <button class="btn-sm btn-outline" onclick="openEdit('${d.id}')">‚úèÔ∏è Edytuj</button>
        ${isSel
          ? `<button class="btn-sm" style="background:rgba(250,66,17,.1);color:var(--orange);border:none" onclick="toggleSel('${d.id}')">‚úì Zaznaczony</button>`
          : `<button class="btn-sm btn-outline" onclick="toggleSel('${d.id}')">Zaznacz do RFQ</button>`}
      </div>
    </div>`;
  }).join('');
  updateSelBar();
}

function toggleSel(id) {
  if (selected.has(id)) selected.delete(id); else selected.add(id);
  renderCards();
}
function clearSel() { selected.clear(); renderCards(); }
function updateSelBar() {
  const bar = document.getElementById('sel-bar');
  const n = selected.size;
  bar.classList.toggle('hidden', n === 0);
  document.getElementById('sel-count-lbl').textContent =
    n === 0 ? '' : `${n} dostawc${n===1?'a':'√≥w'} zaznaczonych`;
}

// ‚îÄ‚îÄ Edit modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openEdit(id) {
  editingId = id;
  const d = dostawcy.find(x => x.id === id);
  if (!d) return;
  document.getElementById('edit-modal-title').textContent = 'Edytuj: ' + d.skrot;
  document.getElementById('edit-modal-body').innerHTML = editForm(d);
  document.getElementById('edit-modal').classList.remove('hidden');
}
function openAddDostawca() {
  editingId = '__new__';
  document.getElementById('edit-modal-title').textContent = 'Dodaj nowego dostawcƒô';
  document.getElementById('edit-modal-body').innerHTML = editForm({
    id:'', skrot:'', nazwa:'', adres:'', miasto:'', kod_pocztowy:'', kraj:'Polska',
    nip:'', krs:'', www:'', telefon:'', email:'', kontakt_os:'', uwagi:'', kolor:'#6b7280'
  });
  document.getElementById('edit-modal').classList.remove('hidden');
}
function closeEditModal() { document.getElementById('edit-modal').classList.add('hidden'); }
function editForm(d) {
  const f = (label, name, val, full=false) => `
    <div class="field-group">
      <label>${label}</label>
      <input type="text" name="${name}" value="${(val||'').replace(/"/g,'&quot;')}">
    </div>`;
  return `
  <div class="field-row"><${f('ID / Skr√≥t','skrot',d.skrot)}</div>
  <div class="field-row full">${f('Pe≈Çna nazwa','nazwa',d.nazwa)}</div>
  <div class="field-row">${f('Adres (ulica nr)','adres',d.adres)}${f('Miasto','miasto',d.miasto)}</div>
  <div class="field-row">${f('Kod pocztowy','kod_pocztowy',d.kod_pocztowy)}${f('Kraj','kraj',d.kraj)}</div>
  <div class="field-row">${f('NIP','nip',d.nip)}${f('KRS','krs',d.krs)}</div>
  <div class="field-row full">${f('Strona www','www',d.www)}</div>
  <div class="field-row">${f('Telefon','telefon',d.telefon)}${f('E-mail','email',d.email)}</div>
  <div class="field-row full">${f('Osoba kontaktowa','kontakt_os',d.kontakt_os)}</div>
  <div class="field-row full"><div class="field-group"><label>Uwagi</label><textarea name="uwagi">${d.uwagi||''}</textarea></div></div>
  <div class="field-row">${f('Kolor (hex)','kolor',d.kolor)}</div>`;
}
function saveDostawca() {
  const body = document.getElementById('edit-modal-body');
  const get = name => (body.querySelector(`[name="${name}"]`)?.value || '').trim();
  const data = {
    skrot: get('skrot'), nazwa: get('nazwa'), adres: get('adres'), miasto: get('miasto'),
    kod_pocztowy: get('kod_pocztowy'), kraj: get('kraj'), nip: get('nip'), krs: get('krs'),
    www: get('www'), telefon: get('telefon'), email: get('email'),
    kontakt_os: get('kontakt_os'), uwagi: get('uwagi'), kolor: get('kolor') || '#6b7280', aktywny: true
  };
  if (editingId === '__new__') {
    data.id = data.skrot.toUpperCase().replace(/\s+/g,'_') || 'D_'+Date.now();
    dostawcy.push(data);
  } else {
    const i = dostawcy.findIndex(d => d.id === editingId);
    if (i >= 0) dostawcy[i] = { ...dostawcy[i], ...data };
  }
  closeEditModal();
  renderCards();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RFQ WIZARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const WEEK_MONTH = {
  18:4,19:5,20:5,21:5,22:5,23:6,24:6,25:6,26:6,27:6,
  28:7,29:7,30:7,31:7,32:8,33:8,34:8,35:8,36:8,
  37:9,38:9,39:9,40:9,41:10,42:10,43:10,44:10,45:11,46:11
};
const ALL_WEEKS = new Set(Object.keys(WEEK_MONTH).map(Number));
const MONTHS_INFO = [
  {m:4,name:'Kwiecie≈Ñ',short:'Kwi',weeks:[18]},
  {m:5,name:'Maj',short:'Maj',weeks:[19,20,21,22]},
  {m:6,name:'Czerwiec',short:'Cze',weeks:[23,24,25,26,27]},
  {m:7,name:'Lipiec',short:'Lip',weeks:[28,29,30,31]},
  {m:8,name:'Sierpie≈Ñ',short:'Sie',weeks:[32,33,34,35,36]},
  {m:9,name:'Wrzesie≈Ñ',short:'Wrz',weeks:[37,38,39,40]},
  {m:10,name:'Pa≈∫dziernik',short:'Pa≈∫',weeks:[41,42,43,44]},
  {m:11,name:'Listopad',short:'Lis',weeks:[45,46]}
];
const RFQ = {
  step: 1,
  groups: {OGL:true, Jeronimo:true, Pozostali:true},
  periodType: 'season',
  selMonths: new Set([5,6,7,8,9,10,11]),
  selSuppliers: new Set(),
  generated: []
};

function openRFQ() {
  RFQ.selSuppliers = new Set(selected.size > 0 ? [...selected] : dostawcy.filter(d=>d.aktywny).map(d=>d.id));
  document.getElementById('rfq-overlay').classList.remove('hidden');
  document.body.style.overflow = 'hidden';
  renderRFQ1();
}
function closeRFQ() {
  document.getElementById('rfq-overlay').classList.add('hidden');
  document.body.style.overflow = '';
}
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeRFQ(); });

function rfqWeeks() {
  if (RFQ.periodType === 'season') return ALL_WEEKS;
  const s = new Set();
  MONTHS_INFO.forEach(mi => { if (RFQ.selMonths.has(mi.m)) mi.weeks.forEach(w => s.add(w)); });
  return s;
}

// ‚îÄ‚îÄ RFQ Step 1 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderRFQ1() {
  const gt = window.PLAN2026_DATA?.group_totals || {};
  const grpChips = ['OGL','Jeronimo','Pozostali'].map(g => {
    const on = RFQ.groups[g];
    return `<button class="rfq-chip ${on?'on':''}" onclick="RFQ.groups['${g}']=!RFQ.groups['${g}'];renderRFQ1()">
      ${g==='OGL'?'üçÉ OGL':g==='Jeronimo'?'ü´ê Jeronimo':''} ${g}
      <span style="font-size:10px;opacity:.65;margin-left:3px">${fmt(gt[g]?.kartony_2026||0)} kart.</span>
    </button>`;
  }).join('');

  const monthBtns = MONTHS_INFO.map(mi => {
    const sel = RFQ.selMonths.has(mi.m) && RFQ.periodType==='months';
    return `<button class="mth2 ${sel?'sel':''}" onclick="rfqClickMonth(${mi.m})">
      <div>${mi.short}</div><div style="font-size:9px;opacity:.6">W${mi.weeks[0]}${mi.weeks.length>1?'‚Äì'+mi.weeks[mi.weeks.length-1]:''}</div>
    </button>`;
  }).join('');

  const supList = dostawcy.filter(d=>d.aktywny).map(d => {
    const on = RFQ.selSuppliers.has(d.id);
    const cs = `background:${d.kolor}20;color:${d.kolor}`;
    return `<div class="sup-chk-item ${on?'on':''}" onclick="rfqToggleSup('${d.id}')">
      <input type="checkbox" ${on?'checked':''} onclick="event.stopPropagation();rfqToggleSup('${d.id}')">
      <span class="sup-chk-badge" style="${cs}">${d.skrot}</span>
      <span class="sup-chk-name">${d.nazwa}</span>
      <span class="sup-chk-sub">${d.miasto||d.kraj}</span>
    </div>`;
  }).join('');

  document.getElementById('rfq-body').innerHTML = `
  <div class="rfq-sec">
    <h3>Grupy klient√≥w (zakres zapotrzebowania)</h3>
    <div class="rfq-chips">${grpChips}</div>
  </div>
  <div class="rfq-sec">
    <h3>Okres zam√≥wienia</h3>
    <div style="display:flex;flex-direction:column;gap:8px">
      <label style="display:flex;align-items:flex-start;gap:10px;padding:9px 13px;border:2px solid ${RFQ.periodType==='season'?'var(--blue)':'var(--border)'};border-radius:9px;cursor:pointer;background:${RFQ.periodType==='season'?'rgba(37,99,235,.03)':'transparent'}" onclick="RFQ.periodType='season';renderRFQ1()">
        <input type="radio" name="rfqperiod" ${RFQ.periodType==='season'?'checked':''} style="margin-top:2px;accent-color:var(--blue)">
        <div><div style="font-size:12px;font-weight:700">Ca≈Çy sezon 2026</div><div style="font-size:11px;color:var(--text-muted)">W18‚ÄìW46 ¬∑ kwiecie≈Ñ ‚Äì listopad 2026</div></div>
      </label>
      <label style="display:flex;align-items:flex-start;gap:10px;padding:9px 13px;border:2px solid ${RFQ.periodType==='months'?'var(--blue)':'var(--border)'};border-radius:9px;cursor:pointer;background:${RFQ.periodType==='months'?'rgba(37,99,235,.03)':'transparent'}" onclick="RFQ.periodType='months';renderRFQ1()">
        <input type="radio" name="rfqperiod" ${RFQ.periodType==='months'?'checked':''} style="margin-top:2px;accent-color:var(--blue)">
        <div style="width:100%"><div style="font-size:12px;font-weight:700">Wybrane miesiƒÖce</div><div class="rfq-months" style="margin-top:8px">${monthBtns}</div></div>
      </label>
    </div>
  </div>
  <div class="rfq-sec">
    <h3>Dostawcy (zaznacz dla kt√≥rych generowaƒá Excel)</h3>
    <div class="sup-chk-list">${supList}</div>
  </div>`;

  document.getElementById('rfq-footer').innerHTML = `
    <button class="btn-ghost" onclick="closeRFQ()">‚úï Anuluj</button>
    <button class="btn-primary" onclick="generateExcels()">üìä Generuj pliki Excel ‚Üí</button>`;
}

function rfqClickMonth(m) {
  RFQ.periodType = 'months';
  if (RFQ.selMonths.has(m)) RFQ.selMonths.delete(m); else RFQ.selMonths.add(m);
  renderRFQ1();
}
function rfqToggleSup(id) {
  if (RFQ.selSuppliers.has(id)) RFQ.selSuppliers.delete(id); else RFQ.selSuppliers.add(id);
  renderRFQ1();
}

// ‚îÄ‚îÄ Build order rows (shared with wizard in zakupy-plan2026) ‚îÄ‚îÄ
function buildOrderRows() {
  const weeks   = rfqWeeks();
  const pl      = {};
  (window.PLAN_DATA||[]).filter(r=>r.typ==='klient').forEach(r => {
    const k = `${r.podmiot}||${r.owoc}||${r.tydzien}`;
    pl[k] = (pl[k]||0) + r.kg;
  });

  const selGrp = Object.entries(RFQ.groups).filter(([,v])=>v).map(([g])=>g);
  const pakMap = {};
  (window.PLAN2026_DATA?.rows||[])
    .filter(r => r.kartony_2026 && selGrp.includes(r.group))
    .forEach(r => {
      let pKg = 0;
      weeks.forEach(w => {
        if (r.owoc==='Truskawka') {
          pKg += pl[`${r.klient}||Truskawka tunelowa||${w}`]    || 0;
          pKg += pl[`${r.klient}||Truskawka szklarniowa||${w}`] || 0;
        } else {
          pKg += pl[`${r.klient}||${r.owoc}||${w}`] || 0;
        }
      });
      if (pKg===0 && r.kg_2026) pKg = r.kg_2026 * (weeks.size / ALL_WEEKS.size);
      r.paks.forEach(p => {
        if (!pakMap[p.pak]) pakMap[p.pak] = {...p, kartony_period:0, kg_period:0};
        pakMap[p.pak].kartony_period += Math.round(pKg * (p.udzial/100) / p.kgpk);
        pakMap[p.pak].kg_period      += Math.round(pKg * (p.udzial/100));
      });
    });

  // Map to stan
  const stanyMap = {};
  ((window.ZAKUPY_DATA||{stany:[]}).stany).filter(s=>s.kategoria==='kartony')
    .forEach(s => stanyMap[s.indeks]=s);

  // Group by physical carton using default size-based assignment
  const orderMap = {};
  Object.entries(pakMap).forEach(([pak, d]) => {
    const asgn = d.rozmiar==='MA≈ÅY' ? 'K-380X300X90' : 'K-600X400X100';
    if (!orderMap[asgn]) {
      const s = stanyMap[asgn]||{};
      orderMap[asgn] = {indeks:asgn, nazwa:s.nazwa||asgn, total_need:0, stan:s.total||0, formats:[]};
    }
    orderMap[asgn].total_need += d.kartony_period;
    orderMap[asgn].formats.push(`${d.waga_g}g√ó${d.szt}`);
  });

  return Object.values(orderMap).sort((a,b)=>b.total_need-a.total_need);
}

// ‚îÄ‚îÄ Excel generation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function generateExcels() {
  if (RFQ.selSuppliers.size === 0) { alert('Zaznacz co najmniej jednego dostawcƒô.'); return; }
  if (!Object.values(RFQ.groups).some(v=>v)) { alert('Zaznacz co najmniej jednƒÖ grupƒô.'); return; }
  if (RFQ.periodType==='months' && RFQ.selMonths.size===0) { alert('Wybierz miesiƒÖce.'); return; }

  const orderRows = buildOrderRows();
  const totalOrder = orderRows.reduce((s,r)=>s+Math.max(0,r.total_need-r.stan),0);
  const selGrpsLbl = Object.entries(RFQ.groups).filter(([,v])=>v).map(([g])=>g).join(', ');
  const periodLbl = RFQ.periodType==='season' ? 'Ca≈Çy sezon 2026 (kwiecie≈Ñ‚Äìlistopad)'
    : MONTHS_INFO.filter(mi=>RFQ.selMonths.has(mi.m)).map(mi=>mi.name).join(', ');

  const selDost = dostawcy.filter(d=>RFQ.selSuppliers.has(d.id));

  // Show progress screen
  document.getElementById('rfq-body').innerHTML = `
  <p style="font-size:13px;font-weight:700;margin-bottom:14px">Generowanie plik√≥w Excel‚Ä¶</p>
  <div class="xls-progress" id="xls-progress">
    ${selDost.map(d=>`
    <div class="xls-row" id="xls-row-${d.id}">
      <span class="xls-icon">üìä</span>
      <span class="xls-name">${d.nazwa}</span>
      <span class="xls-status" id="xls-st-${d.id}">Generowanie‚Ä¶</span>
    </div>`).join('')}
  </div>`;
  document.getElementById('rfq-footer').innerHTML = `
    <button class="btn-ghost" onclick="closeRFQ()">Zamknij</button>
    <button class="btn-primary" id="dl-all-btn" style="display:none" onclick="alert('Pobierz ka≈ºdy plik osobno klikajƒÖc przycisk przy dostawcy.')">Pobrano wszystkie</button>`;

  // Generate each Excel with delay for UX
  let i = 0;
  function next() {
    if (i >= selDost.length) {
      document.getElementById('dl-all-btn').style.display = '';
      return;
    }
    const d = selDost[i++];
    try {
      buildExcel(d, orderRows, totalOrder, selGrpsLbl, periodLbl);
      const st = document.getElementById('xls-st-'+d.id);
      const row = document.getElementById('xls-row-'+d.id);
      if (st) st.innerHTML = `<span style="color:var(--green);font-weight:700">‚úì Gotowe</span>
        <button class="xls-dl-btn" onclick="buildExcel(dostawcy.find(x=>x.id==='${d.id}'),buildOrderRows(),null,'${selGrpsLbl}','${periodLbl}')">‚¨á Pobierz ponownie</button>`;
    } catch(err) {
      const st = document.getElementById('xls-st-'+d.id);
      if (st) st.innerHTML = `<span style="color:red">B≈ÇƒÖd: ${err.message}</span>`;
    }
    setTimeout(next, 200);
  }
  setTimeout(next, 100);
}

function buildExcel(d, orderRows, totalOrder, grpsLbl, periodLbl) {
  if (!window.XLSX) { alert('Biblioteka SheetJS nie za≈Çadowana. Sprawd≈∫ po≈ÇƒÖczenie z internetem.'); return; }
  const XLSX = window.XLSX;
  const wb   = XLSX.utils.book_new();
  const today = '26.02.2026';

  // ‚îÄ‚îÄ Arkusz 1: Zapytanie ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const wsData = [
    ['OvocxMalinovi sp. z o.o.', '', '', '', '', '', ''],
    ['ZAPYTANIE OFERTOWE ‚Äî KARTONY SEZON 2026', '', '', '', '', '', ''],
    ['', '', '', '', '', '', ''],
    ['Dostawca:', d.nazwa, '', '', 'Data:', today, ''],
    ['Adres:', [d.adres, d.miasto, d.kraj].filter(Boolean).join(', '), '', '', 'Grupy klient√≥w:', grpsLbl, ''],
    ['Kontakt:', d.kontakt_os || '‚Äî do uzupe≈Çnienia', '', '', 'Okres:', periodLbl, ''],
    ['Tel:', d.telefon, '', '', '', '', ''],
    ['E-mail:', d.email, '', '', '', '', ''],
    ['', '', '', '', '', '', ''],
    ['Prosimy o przedstawienie oferty na dostawƒô karton√≥w opakowaniowych na sezon 2026:', '', '', '', '', '', ''],
    ['', '', '', '', '', '', ''],
    ['Lp', 'Kod kartonu', 'Nazwa / opis', 'Formaty opakowa≈Ñ', 'Zapotrzebowanie (szt.)', 'Stan magazynowy (szt.)', 'Do zam√≥wienia (szt.)', 'CENA JEDNOSTKOWA NETTO', 'WARTO≈öƒÜ NETTO', 'Uwagi'],
  ];
  orderRows.forEach((r, i) => {
    const toOrder = Math.max(0, r.total_need - r.stan);
    const fmts = [...new Set(r.formats)].join(', ');
    wsData.push([
      i+1, r.indeks, r.nazwa, fmts,
      r.total_need, r.stan, toOrder,
      '', // cena jednostkowa ‚Äî do wype≈Çnienia
      '', // warto≈õƒá netto ‚Äî do wype≈Çnienia
      ''  // uwagi
    ]);
  });
  const tot = orderRows.reduce((s,r)=>s+Math.max(0,r.total_need-r.stan),0);
  wsData.push(['', '', '', '≈ÅƒÑCZNIE', orderRows.reduce((s,r)=>s+r.total_need,0), orderRows.reduce((s,r)=>s+r.stan,0), tot, '', '', '']);
  wsData.push(['', '', '', '', '', '', '', '', '', '']);
  wsData.push(['WARUNKI I UWAGI', '', '', '', '', '', '', '', '', '']);
  wsData.push(['Termin p≈Çatno≈õci:', '‚Äî do uzupe≈Çnienia', '', '', '', '', '', '', '', '']);
  wsData.push(['Gramatura tektury (g/m¬≤):', '‚Äî do uzupe≈Çnienia', '', '', '', '', '', '', '', '']);
  wsData.push(['Kolor:', '‚Äî do uzupe≈Çnienia', '', '', '', '', '', '', '', '']);
  wsData.push(['Specyfikacja techniczna:', '‚Äî do uzupe≈Çnienia / do≈ÇƒÖcz PDF', '', '', '', '', '', '', '', '']);
  wsData.push(['Warunki dostawy (Incoterms):', '‚Äî do uzupe≈Çnienia', '', '', '', '', '', '', '', '']);
  wsData.push(['Miejsce dostawy:', 'Chodzie≈º / ≈Åob≈ºenica / Str√≥≈ºewo / Wyszynki ‚Äî do uzgodnienia', '', '', '', '', '', '', '', '']);
  wsData.push(['Inne:', '‚Äî do uzupe≈Çnienia', '', '', '', '', '', '', '', '']);

  const ws1 = XLSX.utils.aoa_to_sheet(wsData);

  // Column widths
  ws1['!cols'] = [{wch:4},{wch:22},{wch:42},{wch:22},{wch:20},{wch:18},{wch:18},{wch:22},{wch:18},{wch:24}];

  // Merge header cells
  ws1['!merges'] = [
    {s:{r:0,c:0},e:{r:0,c:5}}, // company name
    {s:{r:1,c:0},e:{r:1,c:5}}, // doc title
    {s:{r:9,c:0},e:{r:9,c:6}}, // intro text
  ];

  // Freeze header rows
  ws1['!freeze'] = {xSplit:0, ySplit:12};

  XLSX.utils.book_append_sheet(wb, ws1, 'Zapytanie ofertowe');

  // ‚îÄ‚îÄ Arkusz 2: Dane dostawcy ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const ws2data = [
    ['KARTOTEKA DOSTAWCY', ''],
    ['', ''],
    ['Pe≈Çna nazwa:', d.nazwa],
    ['Skr√≥t:', d.skrot],
    ['Adres:', d.adres],
    ['Miasto:', d.miasto],
    ['Kod pocztowy:', d.kod_pocztowy],
    ['Kraj:', d.kraj],
    ['NIP:', d.nip],
    ['KRS:', d.krs],
    ['Strona www:', d.www],
    ['Telefon:', d.telefon],
    ['E-mail:', d.email],
    ['Osoba kontaktowa:', d.kontakt_os],
    ['', ''],
    ['Uwagi:', d.uwagi],
    ['', ''],
    ['Data wygenerowania:', today],
    ['Wygenerowano przez:', 'OxM Brain ‚Äî OvocxMalinovi sp. z o.o.'],
  ];
  const ws2 = XLSX.utils.aoa_to_sheet(ws2data);
  ws2['!cols'] = [{wch:24},{wch:60}];
  XLSX.utils.book_append_sheet(wb, ws2, 'Kartoteka dostawcy');

  // Save
  const filename = `RFQ_${d.skrot.replace(/[^a-zA-Z0-9]/g,'_')}_Kartony_2026_${today.replace(/\./g,'')}.xlsx`;
  XLSX.writeFile(wb, filename);
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
renderCards();
</script>
</body>
</html>