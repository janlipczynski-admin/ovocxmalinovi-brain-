<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <title>OvocxMalinovi â€” Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="config.js"></script>
  <script src="firma-wiedza.js"></script>
  <script src="opakowania-data.js" defer></script>
  <script src="planowanie-data.js" defer></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:     #07080f;
      --bg2:    #0d0f1c;
      --bg3:    #121428;
      --border: rgba(255,255,255,0.07);
      --text:   #dde0f0;
      --muted:  rgba(200,204,224,0.45);
      --os:     #e0407b;
      --accent: #fa4211;
      --red:    #ff4d6d;
      --green:  #00c875;
    }

    html, body { height: 100%; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', sans-serif;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    /* â”€â”€ HEADER â”€â”€ */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 24px;
      background: var(--bg2);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .hd-logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .hd-logo-icon { font-size: 22px; }

    .hd-logo-name {
      font-family: 'DM Mono', monospace;
      font-size: 13px;
      font-weight: 500;
      letter-spacing: 0.04em;
    }

    .hd-logo-sub {
      font-family: 'DM Mono', monospace;
      font-size: 9px;
      color: var(--muted);
      letter-spacing: 0.14em;
      margin-top: 2px;
    }

    .hd-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .pill {
      font-family: 'DM Mono', monospace;
      font-size: 10px;
      letter-spacing: 0.1em;
      padding: 4px 10px;
      border-radius: 20px;
    }

    .pill-live {
      color: var(--green);
      background: rgba(0,200,117,0.08);
      border: 1px solid rgba(0,200,117,0.2);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .pill-live-dot {
      width: 6px; height: 6px;
      background: var(--green);
      border-radius: 50%;
      animation: blink 1.6s ease-in-out infinite;
    }

    @keyframes blink {
      0%,100% { opacity: 1; }
      50%      { opacity: 0.25; }
    }

    .pill-ver {
      color: var(--os);
      background: rgba(224,64,123,0.07);
      border: 1px solid rgba(224,64,123,0.18);
    }

    .hd-time {
      font-family: 'DM Mono', monospace;
      font-size: 11px;
      color: var(--muted);
    }

    /* â”€â”€ MAIN â”€â”€ */
    main {
      flex: 1;
      padding: 20px 24px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .section-label {
      font-family: 'DM Mono', monospace;
      font-size: 9px;
      letter-spacing: 0.2em;
      color: var(--muted);
      text-transform: uppercase;
    }

    /* â”€â”€ MAPA PROCESÃ“W â”€â”€ */
    .proc-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-bottom: 14px;
    }

    .card {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
    }

    .card-title {
      font-family: 'DM Mono', monospace;
      font-size: 10px;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--text);
    }

    .card-link {
      font-family: 'DM Mono', monospace;
      font-size: 9px;
      color: var(--accent);
      text-decoration: none;
      padding: 3px 8px;
      border-radius: 20px;
      border: 1px solid rgba(250,66,17,0.2);
      transition: background .15s;
    }

    .card-link:hover { background: rgba(250,66,17,0.1); }

    .card-body { padding: 14px 16px; }

    .process-list { display: flex; flex-direction: column; gap: 5px; }

    .process-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 9px 11px;
      border-radius: 8px;
      border: 1px solid var(--border);
      transition: all 0.15s;
      background: var(--bg);
    }

    .process-item:hover {
      border-color: rgba(250,66,17,0.3);
      background: rgba(250,66,17,0.02);
      transform: translateX(1px);
    }

    .process-item.active {
      border-color: rgba(250,66,17,0.35);
      background: linear-gradient(to right, rgba(250,66,17,0.04), rgba(144,19,254,0.02));
    }

    .process-item.has-sheet { cursor: pointer; }
    .process-item.has-sheet:hover .sheet-badge { opacity: 1; }
    .process-item.has-sheet .sheet-badge { opacity: 0.45; }

    .sheet-badge {
      font-family: 'DM Mono', monospace;
      font-size: 9px;
      color: var(--accent);
      margin-left: 6px;
      transition: opacity .15s;
    }

    .p-left { display: flex; align-items: center; gap: 10px; }

    .p-num {
      font-family: 'DM Mono', monospace;
      font-size: 10px;
      color: var(--muted);
      width: 16px;
    }

    .p-name { font-size: 13px; font-weight: 500; }
    .p-owner { font-size: 10px; color: var(--muted); margin-top: 1px; }

    .pill {
      font-family: 'DM Mono', monospace;
      font-size: 9px;
      padding: 2px 8px;
      border-radius: 20px;
      white-space: nowrap;
      font-weight: 500;
    }

    .pill-ns { background: var(--bg2); color: var(--muted); border: 1px solid var(--border); }
    .pill-ip { background: rgba(217,119,6,0.1); color: #d97706; border: 1px solid rgba(217,119,6,0.2); }
    .pill-ok { background: rgba(22,163,74,0.1); color: #16a34a; border: 1px solid rgba(22,163,74,0.2); }
    .pill-bl { background: rgba(220,38,38,0.1); color: #dc2626; border: 1px solid rgba(220,38,38,0.2); }
    .pill[data-pid] { cursor: pointer; user-select: none; transition: filter .12s; }
    .pill[data-pid]:hover { filter: brightness(0.93); }

    .backlog-list { display: flex; flex-direction: column; gap: 8px; }

    .b-item {
      padding: 9px 11px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg);
    }

    .b-title { font-size: 12px; margin-bottom: 5px; }

    .b-tags { display: flex; gap: 5px; flex-wrap: wrap; }

    .tag {
      font-family: 'DM Mono', monospace;
      font-size: 9px;
      padding: 2px 7px;
      border-radius: 10px;
      background: var(--bg2);
      border: 1px solid var(--border);
      color: var(--muted);
    }

    .tag-r { background: rgba(220,38,38,0.08); color: #dc2626; border-color: rgba(220,38,38,0.2); }
    .tag-y { background: rgba(217,119,6,0.08); color: #d97706; border-color: rgba(217,119,6,0.2); }

    /* â”€â”€ BOTTOM PANELS â”€â”€ */
    .panels {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 14px;
    }

    .panel {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px 18px;
    }

    .panel-title {
      font-family: 'DM Mono', monospace;
      font-size: 9px;
      letter-spacing: 0.18em;
      color: var(--muted);
      text-transform: uppercase;
      margin-bottom: 12px;
    }

    .act-row {
      display: flex;
      align-items: baseline;
      gap: 10px;
      font-size: 12px;
      padding: 4px 0;
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }

    .act-row:last-child { border-bottom: none; }

    .act-time {
      font-family: 'DM Mono', monospace;
      font-size: 10px;
      color: var(--muted);
      white-space: nowrap;
    }

    .act-dot { font-size: 7px; }

    .sys-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      padding: 5px 0;
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }

    .sys-row:last-child { border-bottom: none; }
    .sys-name { color: var(--muted); }

    .sys-badge {
      font-family: 'DM Mono', monospace;
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 4px;
    }

    /* â”€â”€ MALINOOVEK â”€â”€ */
    .mal-fab {
      position: fixed;
      bottom: 22px; right: 22px;
      width: 50px; height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--os) 0%, #9b1dff 100%);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      box-shadow: 0 4px 18px rgba(224,64,123,0.45);
      transition: transform 0.2s, box-shadow 0.2s;
      z-index: 1000;
    }

    .mal-fab:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 26px rgba(224,64,123,0.65);
    }

    .mal-panel {
      position: fixed;
      bottom: 82px; right: 22px;
      width: 370px;
      background: var(--bg2);
      border: 1px solid rgba(224,64,123,0.2);
      border-radius: 16px;
      display: none;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 8px 40px rgba(0,0,0,0.55);
      z-index: 999;
    }

    .mal-panel.open { display: flex; }

    .mal-ph {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      background: rgba(224,64,123,0.06);
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }

    .mal-ph-title {
      font-family: 'DM Mono', monospace;
      font-size: 12px;
      color: var(--os);
      letter-spacing: 0.07em;
    }

    .mal-ph-close {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-size: 15px;
      line-height: 1;
      padding: 0;
    }

    .mal-msgs {
      flex: 1;
      overflow-y: auto;
      padding: 12px 14px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 280px;
      max-height: 400px;
    }

    .mal-msg {
      padding: 8px 12px;
      border-radius: 10px;
      font-size: 13px;
      line-height: 1.55;
      max-width: 87%;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .mal-msg.user {
      background: rgba(224,64,123,0.14);
      border: 1px solid rgba(224,64,123,0.18);
      align-self: flex-end;
    }

    .mal-msg.bot {
      background: var(--bg3);
      border: 1px solid var(--border);
      align-self: flex-start;
    }

    .mal-msg.typing {
      background: var(--bg3);
      border: 1px solid var(--border);
      align-self: flex-start;
      color: var(--muted);
      font-style: italic;
    }

    .mal-input-row {
      display: flex;
      gap: 7px;
      padding: 10px 14px;
      border-top: 1px solid rgba(255,255,255,0.06);
    }

    .mal-input {
      flex: 1;
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 11px;
      font-size: 13px;
      color: var(--text);
      font-family: 'Inter', sans-serif;
      outline: none;
      resize: none;
      line-height: 1.4;
    }

    .mal-input:focus { border-color: rgba(224,64,123,0.35); }

    .mal-send {
      background: linear-gradient(135deg, var(--os), #9b1dff);
      border: none;
      border-radius: 8px;
      width: 34px;
      color: #fff;
      font-size: 15px;
      cursor: pointer;
      transition: opacity 0.2s;
      flex-shrink: 0;
    }

    .mal-send:hover { opacity: 0.82; }

    /* â”€â”€ RESPONSIVE â”€â”€ */
    @media (max-width: 680px) {
      .proc-grid { grid-template-columns: 1fr; }
      .panels    { grid-template-columns: 1fr; }
      .mal-panel { width: calc(100vw - 28px); right: 14px; }
    }
  </style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="hd-logo">
    <div class="hd-logo-icon">ğŸ«</div>
    <div>
      <div class="hd-logo-name">OvocxMalinovi</div>
      <div class="hd-logo-sub">REORG 2026</div>
    </div>
  </div>
  <div class="hd-right">
    <div class="pill pill-live"><div class="pill-live-dot"></div>LIVE</div>
    <div class="pill pill-ver">v4.0</div>
    <div class="hd-time" id="hdTime">â€”</div>
  </div>
</header>

<!-- MAIN -->
<main>

  <!-- MAPA PROCESÃ“W -->
  <div class="proc-grid">

    <div class="card">
      <div class="card-header">
        <div class="card-title">Mapa ProcesÃ³w</div>
        <a href="https://docs.google.com/spreadsheets/d/1LEHtdzY-vVbNw4riaCL3DZ6qa7NQgTix5ra9w_kfvoY/edit?gid=1555115517#gid=1555115517" target="_blank" class="card-link">â†— OtwÃ³rz w Google Sheets</a>
      </div>
      <div class="card-body">
        <div class="section-label">Procesy GÅ‚Ã³wne</div>
        <div class="process-list">
          <div class="process-item">
            <div class="p-left">
              <div class="p-num">01</div>
              <div>
                <div class="p-name">SprzedaÅ¼ i Handel</div>
                <div class="p-owner">Dyrektor handlowy</div>
              </div>
            </div>
            <div class="pill pill-ns" data-pid="01" onclick="toggleStatus(event,'01')" title="Kliknij, Å¼eby zmieniÄ‡ status">Not started</div>
          </div>
          <div class="process-item">
            <div class="p-left">
              <div class="p-num">02</div>
              <div>
                <div class="p-name">ObsÅ‚uga zamÃ³wieÅ„ OxM</div>
                <div class="p-owner">Dr. handlowy + Magazyny + Iza + Renia</div>
              </div>
            </div>
            <div class="pill pill-ns" data-pid="02" onclick="toggleStatus(event,'02')" title="Kliknij, Å¼eby zmieniÄ‡ status">Not started</div>
          </div>
          <div class="process-item has-sheet" onclick="window.open('rozliczenia-rt.html','_self')">
            <div class="p-left">
              <div class="p-num">03</div>
              <div>
                <div class="p-name">Rozliczenia RT 2025<span class="sheet-badge">â†— PodglÄ…d</span></div>
                <div class="p-owner">Dz. RozliczeÅ„</div>
              </div>
            </div>
            <div class="pill pill-ns" data-pid="03" onclick="toggleStatus(event,'03')" title="Kliknij, Å¼eby zmieniÄ‡ status">Not started</div>
          </div>
        </div>

        <div class="section-label" style="margin-top:12px">Procesy WspierajÄ…ce</div>
        <div class="process-list">
          <div class="process-item">
            <div class="p-left">
              <div class="p-num">04</div>
              <div>
                <div class="p-name">ObsÅ‚uga reklamacji</div>
                <div class="p-owner">Olgierd (nowy wÅ‚aÅ›ciciel)</div>
              </div>
            </div>
            <div class="pill pill-ns" data-pid="04" onclick="toggleStatus(event,'04')" title="Kliknij, Å¼eby zmieniÄ‡ status">Not started</div>
          </div>
          <div class="process-item active">
            <div class="p-left">
              <div class="p-num">05</div>
              <div>
                <div class="p-name">Gospodarka magazynowa</div>
                <div class="p-owner">Renia + Magazyny Â· v1.0</div>
              </div>
            </div>
            <div class="pill pill-ip" data-pid="05" onclick="toggleStatus(event,'05')" title="Kliknij, Å¼eby zmieniÄ‡ status">In progress</div>
          </div>
          <div class="process-item">
            <div class="p-left">
              <div class="p-num">06</div>
              <div>
                <div class="p-name">Komunikacja wewnÄ™trzna</div>
                <div class="p-owner">wszyscy zwiÄ…zani z biurem</div>
              </div>
            </div>
            <div class="pill pill-ns" data-pid="06" onclick="toggleStatus(event,'06')" title="Kliknij, Å¼eby zmieniÄ‡ status">Not started</div>
          </div>
          <div class="process-item">
            <div class="p-left">
              <div class="p-num">07</div>
              <div>
                <div class="p-name">Certyfikacja i wymogi prawne</div>
                <div class="p-owner">Iza i Renia</div>
              </div>
            </div>
            <div class="pill pill-ns" data-pid="07" onclick="toggleStatus(event,'07')" title="Kliknij, Å¼eby zmieniÄ‡ status">Not started</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-title">Backlog</div>
        <span style="font-family:'DM Mono',monospace;font-size:10px;color:var(--muted)">6 wpisÃ³w</span>
      </div>
      <div class="card-body">
        <div class="backlog-list">
          <div class="b-item">
            <div class="b-title">Automatyczne potwierdzenie przyjÄ™cia reklamacji do klienta</div>
            <div class="b-tags"><span class="tag">Usprawnienie</span><span class="tag">Reklamacje</span></div>
          </div>
          <div class="b-item">
            <div class="b-title">Archiwizacja dokumentÃ³w do chmury zamiast kuriera do ksiÄ™gowoÅ›ci</div>
            <div class="b-tags"><span class="tag">Systemowa</span><span class="tag">Komunikacja</span></div>
          </div>
          <div class="b-item">
            <div class="b-title">Kontrola terminu zamkniÄ™cia reklamacji â€” cel: â‰¤14 dni</div>
            <div class="b-tags"><span class="tag">Usprawnienie</span><span class="tag">Reklamacje</span></div>
          </div>
          <div class="b-item">
            <div class="b-title">Ustandaryzowanie dokumentu PZ przy przyjÄ™ciu surowcÃ³w na magazyn</div>
            <div class="b-tags"><span class="tag">Usprawnienie</span><span class="tag tag-y">Magazyn</span></div>
          </div>
          <div class="b-item">
            <div class="b-title">Mail complaints@ nie dziaÅ‚a zgodnie z zaÅ‚oÅ¼eniami</div>
            <div class="b-tags"><span class="tag tag-r">BÅ‚Ä…d</span><span class="tag">Komunikacja</span></div>
          </div>
          <div class="b-item">
            <div class="b-title">Regularna kontrola stanÃ³w magazynowych vs stany w SS (1x/miesiÄ…c)</div>
            <div class="b-tags"><span class="tag tag-r">BÅ‚Ä…d</span><span class="tag tag-y">Magazyn</span></div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- BOTTOM PANELS -->
  <div class="panels">

    <div class="panel">
      <div class="panel-title">AktywnoÅ›Ä‡ rynkowa â€” ostatnie zdarzenia</div>
      <div id="actFeed"></div>
    </div>

    <div class="panel">
      <div class="panel-title">Status systemÃ³w</div>
      <div id="sysFeed"></div>
    </div>

  </div>

</main>

<!-- MALINOOVEK FAB -->
<button class="mal-fab" onclick="toggleMal()" title="Malinoovek â€” asystent AI">ğŸ«</button>

<!-- MALINOOVEK PANEL -->
<div class="mal-panel" id="malPanel">
  <div class="mal-ph">
    <div class="mal-ph-title">ğŸ« MALINOOVEK</div>
    <button class="mal-ph-close" onclick="toggleMal()">&#x2715;</button>
  </div>
  <div class="mal-msgs" id="malMsgs">
    <div class="mal-msg bot">CzeÅ›Ä‡! Jestem Malinoovek â€” asystent AI OvocxMalinovi.
Pytaj o plan 2026, opakowania, procesy, rozliczenia. Mam dostÄ™p do peÅ‚nej wiedzy firmowej.</div>
  </div>
  <div class="mal-input-row">
    <textarea class="mal-input" id="malInput" rows="1"
      placeholder="Pytaj Malinoovkaâ€¦" onkeydown="malKey(event)"></textarea>
    <button class="mal-send" onclick="malSend()">&#x2191;</button>
  </div>
</div>

<script>
// â”€â”€â”€ TIME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function tickTime() {
  var d = new Date();
  var p = function(n){ return String(n).padStart(2,'0'); };
  document.getElementById('hdTime').textContent =
    p(d.getDate())+'.'+p(d.getMonth()+1)+'.'+d.getFullYear()+
    '  '+p(d.getHours())+':'+p(d.getMinutes())+':'+p(d.getSeconds());
}
setInterval(tickTime, 1000);
tickTime();

// â”€â”€â”€ ACTIVITY FEED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var ACTS = [
  { t:'09:42', txt:'OGL Food â€” zamÃ³wienie T22: 2 400 kg malin',       col:'#00c875' },
  { t:'09:38', txt:'Biedronka â€” EDI potwierdzenie dostawy',            col:'#00c875' },
  { t:'09:31', txt:'Kartony mb â€” zamÃ³wienie do TFP: 8 500 szt.',       col:'#4a9eff' },
  { t:'09:18', txt:'WZ ÅobÅ¼enica â€” opÃ³Åºnienie (oczekiwane)',           col:'#f5a623' },
  { t:'08:55', txt:'FA/2026/044 â€” wystawiona przez IzÄ™',               col:'#00c875' },
  { t:'08:40', txt:'Reklamacja #3 â€” przekazana do Olgierda',           col:'#9b9bb0' },
  { t:'08:22', txt:'Przelew do dostawcy â€” zatwierdzony przez ReniÄ™',   col:'#00c875' },
  { t:'08:15', txt:'REORG: mapa procesu Zakupy â€” zaktualizowana',      col:'#9b9bb0' },
];

document.getElementById('actFeed').innerHTML = ACTS.map(function(a) {
  return '<div class="act-row">' +
    '<span class="act-time">' + a.t + '</span>' +
    '<span class="act-dot" style="color:' + a.col + '">&#9679;</span>' +
    '<span style="color:#c0c3d8;font-size:12px">' + a.txt + '</span>' +
    '</div>';
}).join('');

// â”€â”€â”€ SYSTEM STATUS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var SYSTEMS = [
  { n:'StreamSoft ERP',  s:'ok',   l:'Online'     },
  { n:'EDI (DINO)',       s:'ok',   l:'Aktywny'    },
  { n:'Excel RT',         s:'ok',   l:'T08/2026'   },
  { n:'Malinoovek AI',    s:'ok',   l:'Online'     },
  { n:'WZ Magazyny',      s:'warn', l:'OpÃ³Åºnienia' },
  { n:'Certyfikacja BW',  s:'info', l:'W toku'     },
];

var SC = { ok:'#00c875', warn:'#f5a623', info:'#4a9eff', err:'#ff4d6d' };

document.getElementById('sysFeed').innerHTML = SYSTEMS.map(function(s) {
  return '<div class="sys-row">' +
    '<span class="sys-name">' + s.n + '</span>' +
    '<span class="sys-badge" style="color:' + SC[s.s] + ';background:' + SC[s.s] + '18">' + s.l + '</span>' +
    '</div>';
}).join('');

// â”€â”€â”€ MALINOOVEK â€” buildMalContext â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildMalContext(msg) {
  var q = msg.toLowerCase()
    .replace(/Ä…/g,'a').replace(/Ä‡/g,'c').replace(/Ä™/g,'e')
    .replace(/Å‚/g,'l').replace(/Å„/g,'n').replace(/Ã³/g,'o')
    .replace(/Å›/g,'s').replace(/Åº/g,'z').replace(/Å¼/g,'z');

  var dataKeywords = ['karton','opakow','kg','ton','ilosc','wolumen','prognoz','plan','zamow','sprzed','sezon','tygodnie','tyg','pakow','szt','jednostek'];
  var priceKeywords = ['cen','pln','eur','zl','plac','porownaj','rozlicz','rt ','rt2025'];
  var hasDataIntent = dataKeywords.some(function(k){ return q.includes(k); }) ||
                      priceKeywords.some(function(k){ return q.includes(k); });
  if (!hasDataIntent) return '';

  var hasOpak = !!(window.OPAK_DATA && window.OPAK_DATA.rekordy);
  var hasPlan = !!(window.PLAN_DATA && window.PLAN_DATA.length);
  if (!hasOpak && !hasPlan) return '';

  var ODBIORCY = hasOpak ? [...new Set(window.OPAK_DATA.rekordy.map(function(r){ return r.odbiorca; }))] : [];
  var KLIENCI  = hasPlan  ? [...new Set(window.PLAN_DATA.filter(function(r){ return r.typ==='klient'; }).map(function(r){ return r.podmiot; }))] : [];
  var RT_ODB   = (window.RT_SPRZEDAZ && window.RT_SPRZEDAZ.length) ? [...new Set(window.RT_SPRZEDAZ.map(function(r){ return r.odbiorca; }))] : [];
  var ALL_NAMES = [...new Set([...ODBIORCY, ...KLIENCI, ...RT_ODB])];

  function normN(s) {
    return (s||'').toLowerCase()
      .replace(/Ä…/g,'a').replace(/Ä‡/g,'c').replace(/Ä™/g,'e')
      .replace(/Å‚/g,'l').replace(/Å„/g,'n').replace(/Ã³/g,'o')
      .replace(/Å›/g,'s').replace(/Åº/g,'z').replace(/Å¼/g,'z');
  }

  var matchedName = null, bestScore = 0;
  ALL_NAMES.forEach(function(name) {
    var n = normN(name);
    var words = n.split(/\s+/);
    var score = words.filter(function(w){ return q.includes(w) && w.length > 2; }).length;
    if (score > bestScore) { bestScore = score; matchedName = name; }
  });

  var matchedOwoc = null;
  if (q.includes('malin')) matchedOwoc = 'Malina';
  else if (q.includes('truskaw')) matchedOwoc = 'Truskawka tunelowa';

  var MONTHS = {
    'maj':[18,22],'czerw':[23,26],'lip':[27,30],'sierp':[31,35],
    'wrzes':[36,39],'paz':[40,44],'listop':[45,46]
  };
  var matchedWeeks = null;
  Object.keys(MONTHS).forEach(function(kw) {
    if (!matchedWeeks && q.includes(kw)) matchedWeeks = MONTHS[kw];
  });

  var priceKw = ['cen','eur','pln','zl','zÅ‚','plac','platil','kosztow'];
  var asksPrice = priceKw.some(function(k){ return q.includes(k); });

  var ctx = '';

  // â”€â”€ RT 2025 â€” opakowania â”€â”€
  if (hasOpak) {
    var rekordy = window.OPAK_DATA.rekordy;
    if (matchedName) rekordy = rekordy.filter(function(r){ return r.odbiorca === matchedName || normN(r.odbiorca) === normN(matchedName); });
    if (matchedOwoc) rekordy = rekordy.filter(function(r){ return r.owoc === matchedOwoc; });
    if (matchedWeeks) rekordy = rekordy.filter(function(r){ return r.tydzien >= matchedWeeks[0] && r.tydzien <= matchedWeeks[1]; });

    if (rekordy.length > 0) {
      var agg = {};
      rekordy.forEach(function(r) {
        if (!agg[r.pak]) agg[r.pak] = { kg:0, kartony:0, jednostki:0 };
        agg[r.pak].kg        += r.wolumen_kg  || 0;
        agg[r.pak].kartony   += r.kartonow    || 0;
        agg[r.pak].jednostki += r.jednostek   || 0;
      });
      var rows = Object.entries(agg)
        .sort(function(a,b){ return b[1].kartony - a[1].kartony; })
        .slice(0,20)
        .map(function(e){ return e[0]+': '+Math.round(e[1].kg)+' kg, '+e[1].kartony+' kart., '+e[1].jednostki+' jedn.'; })
        .join('\n');
      var totalKg      = rekordy.reduce(function(s,r){ return s+(r.wolumen_kg||0); }, 0);
      var totalKartony = rekordy.reduce(function(s,r){ return s+(r.kartonow||0); }, 0);
      ctx += '\n[DANE FIRMOWE â€” RT 2025';
      if (matchedName) ctx += ', odbiorca: '+matchedName;
      if (matchedOwoc) ctx += ', owoc: '+matchedOwoc;
      if (matchedWeeks) ctx += ', tyg. '+matchedWeeks[0]+'â€“'+matchedWeeks[1];
      ctx += ']\nÅÄ…cznie: '+Math.round(totalKg)+' kg, '+totalKartony+' kartonÃ³w\nWg opakowania:\n'+rows;
    }
  }

  // â”€â”€ RT 2025 â€” ceny sprzedaÅ¼y â”€â”€
  var hasRT = !!(window.RT_SPRZEDAZ && window.RT_SPRZEDAZ.length);
  var asksRT = asksPrice || q.includes('porownaj') || q.includes('cen') || q.includes('rozlicz');
  if (hasRT && asksRT) {
    var rt = window.RT_SPRZEDAZ;
    var isCompare = q.includes('porownaj');
    if (!isCompare && matchedName) {
      rt = rt.filter(function(r){ return normN(r.odbiorca).includes(normN(matchedName)) || normN(matchedName).includes(normN(r.odbiorca).split(' ')[0]); });
    }
    if (matchedOwoc) rt = rt.filter(function(r){ return r.owoc === matchedOwoc; });
    if (matchedWeeks) rt = rt.filter(function(r){ return r.tydzien >= matchedWeeks[0] && r.tydzien <= matchedWeeks[1]; });

    if (rt.length > 0) {
      var rtAgg = {};
      rt.forEach(function(r) {
        var k = r.odbiorca+'|||'+r.owoc;
        if (!rtAgg[k]) rtAgg[k] = { odbiorca:r.odbiorca, owoc:r.owoc, totalKg:0, totalPrzychod:0 };
        rtAgg[k].totalKg       += r.kg;
        rtAgg[k].totalPrzychod += r.przychod;
      });
      var rtRows = Object.values(rtAgg)
        .sort(function(a,b){ return b.totalKg - a.totalKg; })
        .slice(0,20)
        .map(function(v){ return v.odbiorca+' / '+v.owoc+': '+Math.round(v.totalKg)+' kg, Å›r. cena '+(v.totalKg>0?(v.totalPrzychod/v.totalKg).toFixed(2):'â€”')+' PLN/kg'; })
        .join('\n');
      ctx += '\n\n[ROZLICZENIA RT 2025 â€” ceny sprzedaÅ¼y';
      if (!isCompare && matchedName) ctx += ', odbiorca: '+matchedName;
      if (matchedOwoc) ctx += ', owoc: '+matchedOwoc;
      if (matchedWeeks) ctx += ', tyg. '+matchedWeeks[0]+'â€“'+matchedWeeks[1];
      ctx += ']\n'+rtRows;
    }
  }

  // â”€â”€ PLAN 2026 â”€â”€
  if (hasPlan) {
    var plan = window.PLAN_DATA.filter(function(r){ return r.typ==='klient'; });
    if (matchedName) plan = plan.filter(function(r){ return r.podmiot===matchedName || normN(r.podmiot)===normN(matchedName); });
    if (matchedOwoc) plan = plan.filter(function(r){ return r.owoc===matchedOwoc; });
    if (matchedWeeks) plan = plan.filter(function(r){ return r.tydzien>=matchedWeeks[0] && r.tydzien<=matchedWeeks[1]; });

    var planKw = ['plan','prognoz','2026','sezon'];
    var asksPlan = planKw.some(function(k){ return q.includes(k); });

    if (plan.length > 0 && asksPlan) {
      var planKg = plan.reduce(function(s,r){ return s+(r.kg||0); }, 0);
      var planGrp = {};
      plan.forEach(function(r){ var k=r.podmiot+'/'+r.owoc; if(!planGrp[k]) planGrp[k]=0; planGrp[k]+=r.kg||0; });
      var planRows = Object.entries(planGrp)
        .sort(function(a,b){ return b[1]-a[1]; }).slice(0,10)
        .map(function(e){ return e[0]+': '+Math.round(e[1])+' kg'; }).join('\n');
      ctx += '\n\n[PLAN 2026';
      if (matchedName) ctx += ', klient: '+matchedName;
      if (matchedOwoc) ctx += ', owoc: '+matchedOwoc;
      ctx += ']\nÅÄ…cznie: '+Math.round(planKg)+' kg\n'+planRows;
    }
  }

  return ctx;
}

// â”€â”€â”€ MALINOOVEK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var MAL_SYSTEM = 'JesteÅ› Malinoovkiem â€” asystentem AI firmy OvocxMalinovi sp. z o.o.\n' +
  'Twoja rola: wspieraÄ‡ zespÃ³Å‚ w codziennej pracy, optymalizacji procesÃ³w i zarzÄ…dzaniu wiedzÄ… firmowÄ….\n' +
  'Zawsze odpowiadaj po polsku, chyba Å¼e ktoÅ› pisze do Ciebie w innym jÄ™zyku.\n' +
  'JesteÅ› konkretny, procesowy i praktyczny. Nie owijasz w baweÅ‚nÄ™. Odpowiedzi krÃ³tkie â€” max 3-4 zdania lub lista punktÃ³w.';

var malHistory = [];

function toggleMal() {
  var p = document.getElementById('malPanel');
  p.classList.toggle('open');
  if (p.classList.contains('open')) document.getElementById('malInput').focus();
}

function malGetKey() {
  var cfg = window.OXM_CONFIG;
  if (cfg && cfg.apiKey && cfg.apiKey !== '__ANTHROPIC_KEY__') return cfg.apiKey;
  var stored = localStorage.getItem('oxm_api_key');
  if (stored) return stored;
  var k = prompt('Wklej klucz API Anthropic (sk-ant-\u2026):');
  if (k && k.startsWith('sk-')) { localStorage.setItem('oxm_api_key', k); return k; }
  return null;
}

function malModel() {
  return (window.OXM_CONFIG && window.OXM_CONFIG.model) || 'claude-haiku-4-5-20251001';
}

function malAdd(role, text) {
  var box = document.getElementById('malMsgs');
  var d = document.createElement('div');
  d.className = 'mal-msg ' + (role === 'user' ? 'user' : 'bot');
  d.textContent = text;
  box.appendChild(d);
  box.scrollTop = box.scrollHeight;
  return d;
}

function malKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); malSend(); }
}

async function malSend() {
  var inp = document.getElementById('malInput');
  var q = inp.value.trim();
  if (!q) return;
  var key = malGetKey();
  if (!key) return;
  inp.value = '';
  malAdd('user', q);
  var ctxData = buildMalContext(q);
  var msgContent = ctxData ? q + '\n\n[Kontekst danych firmowych:' + ctxData + ']' : q;
  malHistory.push({ role: 'user', content: msgContent });

  var typing = malAdd('bot', 'Malinoovek pisze\u2026');
  typing.classList.add('typing');

  try {
    var res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': key,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true',
      },
      body: JSON.stringify({
        model: malModel(),
        max_tokens: 1024,
        system: MAL_SYSTEM + (window.FIRMA_WIEDZA ? '\n\n---\n' + window.FIRMA_WIEDZA : ''),
        messages: malHistory,
      }),
    });

    typing.remove();

    if (!res.ok) {
      var err = await res.json().catch(function(){ return {}; });
      malAdd('bot', 'BÅ‚Ä…d API: ' + ((err.error && err.error.message) || res.status));
      return;
    }

    var data = await res.json();
    var answer = (data.content && data.content[0] && data.content[0].text) || '(brak odpowiedzi)';
    malHistory.push({ role: 'assistant', content: answer });
    malAdd('bot', answer);

  } catch(e) {
    typing.remove();
    malAdd('bot', 'BÅ‚Ä…d poÅ‚Ä…czenia: ' + e.message);
  }
}

// â”€â”€â”€ PROCESS STATUS (PILL) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PILL_LABELS   = { ns: 'Not started', ip: 'In progress', ok: 'Done âœ“', bl: 'Blocked' };
const PILL_CYCLE    = ['ns', 'ip', 'ok', 'bl'];
const PILL_KEY      = 'oxm_process_status';
const PILL_DEFAULTS = { '01':'ns','02':'ns','03':'ns','04':'ns','05':'ip','06':'ns','07':'ns' };

function toggleStatus(e, pid) {
  e.stopPropagation();
  const statuses = JSON.parse(localStorage.getItem(PILL_KEY) || '{}');
  const cur  = statuses[pid] !== undefined ? statuses[pid] : (PILL_DEFAULTS[pid] || 'ns');
  const next = PILL_CYCLE[(PILL_CYCLE.indexOf(cur) + 1) % PILL_CYCLE.length];
  statuses[pid] = next;
  localStorage.setItem(PILL_KEY, JSON.stringify(statuses));
  const pill = document.querySelector('.pill[data-pid="' + pid + '"]');
  if (pill) { pill.className = 'pill pill-' + next; pill.textContent = PILL_LABELS[next]; }
}

function loadStatuses() {
  const statuses = JSON.parse(localStorage.getItem(PILL_KEY) || '{}');
  document.querySelectorAll('.pill[data-pid]').forEach(function(pill) {
    const pid = pill.dataset.pid;
    const st  = statuses[pid] !== undefined ? statuses[pid] : (PILL_DEFAULTS[pid] || 'ns');
    pill.className = 'pill pill-' + st;
    pill.textContent = PILL_LABELS[st];
  });
}

loadStatuses();
</script>
</body>
</html>
