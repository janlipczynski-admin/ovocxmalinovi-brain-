<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <title>OvocxMalinovi â€” WIG Dashboard 2026</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="config.js"></script>
  <script src="firma-wiedza.js"></script>
  <script src="opakowania-data.js" defer></script>
  <script src="planowanie-data.js" defer></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:     #07080f;
      --bg2:    #0d0f1c;
      --bg3:    #121428;
      --border: rgba(255,255,255,0.07);
      --text:   #dde0f0;
      --muted:  rgba(200,204,224,0.45);
      --os:     #e0407b;
      --h50:    #00c875;
      --nc:     #4a9eff;
      --px:     #f5a623;
      --red:    #ff4d6d;
      --green:  #00c875;
    }

    html, body { height: 100%; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', sans-serif;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    /* â”€â”€ HEADER â”€â”€ */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 24px;
      background: var(--bg2);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .hd-logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .hd-logo-icon { font-size: 22px; }

    .hd-logo-name {
      font-family: 'DM Mono', monospace;
      font-size: 13px;
      font-weight: 500;
      letter-spacing: 0.04em;
    }

    .hd-logo-sub {
      font-family: 'DM Mono', monospace;
      font-size: 9px;
      color: var(--muted);
      letter-spacing: 0.14em;
      margin-top: 2px;
    }

    .hd-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .pill {
      font-family: 'DM Mono', monospace;
      font-size: 10px;
      letter-spacing: 0.1em;
      padding: 4px 10px;
      border-radius: 20px;
    }

    .pill-live {
      color: var(--green);
      background: rgba(0,200,117,0.08);
      border: 1px solid rgba(0,200,117,0.2);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .pill-live-dot {
      width: 6px; height: 6px;
      background: var(--green);
      border-radius: 50%;
      animation: blink 1.6s ease-in-out infinite;
    }

    @keyframes blink {
      0%,100% { opacity: 1; }
      50%      { opacity: 0.25; }
    }

    .pill-ver {
      color: var(--os);
      background: rgba(224,64,123,0.07);
      border: 1px solid rgba(224,64,123,0.18);
    }

    .hd-time {
      font-family: 'DM Mono', monospace;
      font-size: 11px;
      color: var(--muted);
    }

    /* â”€â”€ TICKER â”€â”€ */
    .ticker {
      background: var(--bg3);
      border-bottom: 1px solid var(--border);
      height: 28px;
      overflow: hidden;
      display: flex;
      align-items: center;
    }

    .ticker-label {
      font-family: 'DM Mono', monospace;
      font-size: 9px;
      letter-spacing: 0.14em;
      color: var(--muted);
      padding: 0 14px;
      border-right: 1px solid var(--border);
      white-space: nowrap;
    }

    .ticker-track {
      overflow: hidden;
      flex: 1;
      display: flex;
      align-items: center;
    }

    .ticker-inner {
      display: flex;
      gap: 36px;
      padding: 0 20px;
      animation: scroll-left 50s linear infinite;
      white-space: nowrap;
    }

    @keyframes scroll-left {
      from { transform: translateX(0); }
      to   { transform: translateX(-50%); }
    }

    .ti {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-family: 'DM Mono', monospace;
      font-size: 11px;
    }

    .ti-n { color: var(--muted); }
    .ti-v { color: var(--text); }
    .ti-c.up   { color: var(--green); }
    .ti-c.down { color: var(--red);   }

    /* â”€â”€ MAIN â”€â”€ */
    main {
      flex: 1;
      padding: 20px 24px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .section-label {
      font-family: 'DM Mono', monospace;
      font-size: 9px;
      letter-spacing: 0.2em;
      color: var(--muted);
      text-transform: uppercase;
    }

    /* â”€â”€ WIG GRID â”€â”€ */
    .wig-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 14px;
    }

    .wc {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 18px;
      position: relative;
      overflow: hidden;
      transition: border-color 0.25s, box-shadow 0.25s;
    }

    .wc:hover {
      border-color: rgba(255,255,255,0.13);
      box-shadow: 0 4px 24px rgba(0,0,0,0.3);
    }

    .wc::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 2px;
    }

    .wc-os::before  { background: var(--os);  }
    .wc-h50::before { background: var(--h50); }
    .wc-nc::before  { background: var(--nc);  }
    .wc-px::before  { background: var(--px);  }

    .wc-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }

    .wc-name {
      font-family: 'DM Mono', monospace;
      font-size: 10px;
      letter-spacing: 0.14em;
      color: var(--muted);
    }

    .wc-tag {
      font-family: 'DM Mono', monospace;
      font-size: 9px;
      letter-spacing: 0.08em;
      padding: 2px 7px;
      border-radius: 4px;
    }

    .wc-os  .wc-tag { color: var(--os);  background: rgba(224,64,123,0.1);  }
    .wc-h50 .wc-tag { color: var(--h50); background: rgba(0,200,117,0.1);   }
    .wc-nc  .wc-tag { color: var(--nc);  background: rgba(74,158,255,0.1);  }
    .wc-px  .wc-tag { color: var(--px);  background: rgba(245,166,35,0.1);  }

    .wc-val {
      font-family: 'DM Mono', monospace;
      font-size: 30px;
      font-weight: 500;
      letter-spacing: -0.02em;
      line-height: 1;
      margin-bottom: 5px;
    }

    .wc-os  .wc-val { color: var(--os);  }
    .wc-h50 .wc-val { color: var(--h50); }
    .wc-nc  .wc-val { color: var(--nc);  }
    .wc-px  .wc-val { color: var(--px);  }

    .wc-chg {
      display: flex;
      align-items: center;
      gap: 7px;
      margin-bottom: 14px;
      font-family: 'DM Mono', monospace;
    }

    .wc-chg-abs { font-size: 13px; font-weight: 500; }
    .wc-chg-pct { font-size: 11px; padding: 2px 6px; border-radius: 4px; }

    .wc-chg.up   .wc-chg-abs { color: var(--green); }
    .wc-chg.down .wc-chg-abs { color: var(--red);   }
    .wc-chg.up   .wc-chg-pct { color: var(--green); background: rgba(0,200,117,0.1);  }
    .wc-chg.down .wc-chg-pct { color: var(--red);   background: rgba(255,77,109,0.1); }

    .wc-chart {
      width: 100%;
      height: 56px;
      display: block;
      margin-bottom: 14px;
    }

    .wc-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .wc-stat-label {
      font-family: 'DM Mono', monospace;
      font-size: 8px;
      letter-spacing: 0.12em;
      color: var(--muted);
      text-transform: uppercase;
      margin-bottom: 2px;
    }

    .wc-stat-val {
      font-family: 'DM Mono', monospace;
      font-size: 11px;
      color: var(--text);
    }

    /* â”€â”€ BOTTOM PANELS â”€â”€ */
    .panels {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 14px;
    }

    .panel {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px 18px;
    }

    .panel-title {
      font-family: 'DM Mono', monospace;
      font-size: 9px;
      letter-spacing: 0.18em;
      color: var(--muted);
      text-transform: uppercase;
      margin-bottom: 12px;
    }

    .act-row {
      display: flex;
      align-items: baseline;
      gap: 10px;
      font-size: 12px;
      padding: 4px 0;
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }

    .act-row:last-child { border-bottom: none; }

    .act-time {
      font-family: 'DM Mono', monospace;
      font-size: 10px;
      color: var(--muted);
      white-space: nowrap;
    }

    .act-dot { font-size: 7px; }

    .sys-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      padding: 5px 0;
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }

    .sys-row:last-child { border-bottom: none; }
    .sys-name { color: var(--muted); }

    .sys-badge {
      font-family: 'DM Mono', monospace;
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 4px;
    }

    /* â”€â”€ MALINOOVEK â”€â”€ */
    .mal-fab {
      position: fixed;
      bottom: 22px; right: 22px;
      width: 50px; height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--os) 0%, #9b1dff 100%);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      box-shadow: 0 4px 18px rgba(224,64,123,0.45);
      transition: transform 0.2s, box-shadow 0.2s;
      z-index: 1000;
    }

    .mal-fab:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 26px rgba(224,64,123,0.65);
    }

    .mal-panel {
      position: fixed;
      bottom: 82px; right: 22px;
      width: 370px;
      background: var(--bg2);
      border: 1px solid rgba(224,64,123,0.2);
      border-radius: 16px;
      display: none;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 8px 40px rgba(0,0,0,0.55);
      z-index: 999;
    }

    .mal-panel.open { display: flex; }

    .mal-ph {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      background: rgba(224,64,123,0.06);
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }

    .mal-ph-title {
      font-family: 'DM Mono', monospace;
      font-size: 12px;
      color: var(--os);
      letter-spacing: 0.07em;
    }

    .mal-ph-close {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-size: 15px;
      line-height: 1;
      padding: 0;
    }

    .mal-msgs {
      flex: 1;
      overflow-y: auto;
      padding: 12px 14px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 280px;
      max-height: 400px;
    }

    .mal-msg {
      padding: 8px 12px;
      border-radius: 10px;
      font-size: 13px;
      line-height: 1.55;
      max-width: 87%;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .mal-msg.user {
      background: rgba(224,64,123,0.14);
      border: 1px solid rgba(224,64,123,0.18);
      align-self: flex-end;
    }

    .mal-msg.bot {
      background: var(--bg3);
      border: 1px solid var(--border);
      align-self: flex-start;
    }

    .mal-msg.typing {
      background: var(--bg3);
      border: 1px solid var(--border);
      align-self: flex-start;
      color: var(--muted);
      font-style: italic;
    }

    .mal-input-row {
      display: flex;
      gap: 7px;
      padding: 10px 14px;
      border-top: 1px solid rgba(255,255,255,0.06);
    }

    .mal-input {
      flex: 1;
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 11px;
      font-size: 13px;
      color: var(--text);
      font-family: 'Inter', sans-serif;
      outline: none;
      resize: none;
      line-height: 1.4;
    }

    .mal-input:focus { border-color: rgba(224,64,123,0.35); }

    .mal-send {
      background: linear-gradient(135deg, var(--os), #9b1dff);
      border: none;
      border-radius: 8px;
      width: 34px;
      color: #fff;
      font-size: 15px;
      cursor: pointer;
      transition: opacity 0.2s;
      flex-shrink: 0;
    }

    .mal-send:hover { opacity: 0.82; }

    /* â”€â”€ RESPONSIVE â”€â”€ */
    @media (max-width: 1100px) {
      .wig-grid { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 680px) {
      .wig-grid  { grid-template-columns: 1fr; }
      .panels    { grid-template-columns: 1fr; }
      .mal-panel { width: calc(100vw - 28px); right: 14px; }
    }
  </style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="hd-logo">
    <div class="hd-logo-icon">ğŸ«</div>
    <div>
      <div class="hd-logo-name">OvocxMalinovi</div>
      <div class="hd-logo-sub">WIG DASHBOARD 2026</div>
    </div>
  </div>
  <div class="hd-right">
    <div class="pill pill-live"><div class="pill-live-dot"></div>LIVE</div>
    <div class="pill pill-ver">v4.0</div>
    <div class="hd-time" id="hdTime">â€”</div>
  </div>
</header>

<!-- TICKER -->
<div class="ticker">
  <div class="ticker-label">OXMÂ·MARKET</div>
  <div class="ticker-track">
    <div class="ticker-inner" id="tickerInner"></div>
  </div>
</div>

<!-- MAIN -->
<main>
<div class="wig-grid">

  <div class="section-label">Indeksy WIG â€” Sezon 2026</div>

  <!-- 4 WIG CARDS -->
  <div class="wig-grid">

    <!-- OS MALINOVI -->
    <div class="wc wc-os">
      <div class="wc-header">
        <div class="wc-name">OS MALINOVI</div>
        <div class="wc-tag">OXMÂ·OS</div>
      </div>
      <div class="wc-val" id="os-val">1 247.32</div>
      <div class="wc-chg up" id="os-chg">
        <span class="wc-chg-abs" id="os-abs">+12.40</span>
        <span class="wc-chg-pct" id="os-pct">+1.00%</span>
      </div>
      <canvas class="wc-chart" id="os-c"></canvas>
      <div class="wc-stats">
        <div>
          <div class="wc-stat-label">Plan kg</div>
          <div class="wc-stat-val">1 539 t</div>
        </div>
        <div>
          <div class="wc-stat-label">Plan kartony</div>
          <div class="wc-stat-val">686k</div>
        </div>
        <div>
          <div class="wc-stat-label">GrowerÃ³w</div>
          <div class="wc-stat-val">47</div>
        </div>
        <div>
          <div class="wc-stat-label">Wzrost YoY</div>
          <div class="wc-stat-val" style="color:var(--green)">+48%</div>
        </div>
      </div>
      <div class="raag green"><div class="raag-dot"></div>CEL Q2!</div>
    </div>

    <!-- HARVEST 50 -->
    <div class="wc wc-h50">
      <div class="wc-header">
        <div class="wc-name">HARVEST 50</div>
        <div class="wc-tag">OXMÂ·H50</div>
      </div>
      <div class="wc-val" id="h50-val">892.15</div>
      <div class="wc-chg down" id="h50-chg">
        <span class="wc-chg-abs" id="h50-abs">-3.21</span>
        <span class="wc-chg-pct" id="h50-pct">-0.36%</span>
      </div>
      <canvas class="wc-chart" id="h50-c"></canvas>
      <div class="wc-stats">
        <div>
          <div class="wc-stat-label">Top growerzy</div>
          <div class="wc-stat-val">50</div>
        </div>
        <div>
          <div class="wc-stat-label">Dostawy</div>
          <div class="wc-stat-val">92.4%</div>
        </div>
        <div>
          <div class="wc-stat-label">Magazyny</div>
          <div class="wc-stat-val">4</div>
        </div>
        <div>
          <div class="wc-stat-label">WZ na czas</div>
          <div class="wc-stat-val" style="color:var(--red)">71.2%</div>
        </div>
      </div>
    </div>

    <!-- NO COMPLAINTS -->
    <div class="wc wc-nc">
      <div class="wc-header">
        <div class="wc-name">NO COMPLAINTS</div>
        <div class="wc-tag">OXMÂ·NC</div>
      </div>
      <div class="wc-val" id="nc-val">9 987.44</div>
      <div class="wc-chg up" id="nc-chg">
        <span class="wc-chg-abs" id="nc-abs">+24.70</span>
        <span class="wc-chg-pct" id="nc-pct">+0.25%</span>
      </div>
      <canvas class="wc-chart" id="nc-c"></canvas>
      <div class="wc-stats">
        <div>
          <div class="wc-stat-label">Reklamacje</div>
          <div class="wc-stat-val">3</div>
        </div>
        <div>
          <div class="wc-stat-label">RozwiÄ…zane</div>
          <div class="wc-stat-val" style="color:var(--green)">100%</div>
        </div>
        <div>
          <div class="wc-stat-label">WÅ‚aÅ›ciciel</div>
          <div class="wc-stat-val">Olgierd</div>
        </div>
        <div>
          <div class="wc-stat-label">Åšr. czas</div>
          <div class="wc-stat-val">2.1 dni</div>
        </div>
      </div>
    </div>

    <!-- PRODUCT X -->
    <div class="wc wc-px">
      <div class="wc-header">
        <div class="wc-name">PRODUCT X</div>
        <div class="wc-tag">OXMÂ·PX</div>
      </div>
      <div class="wc-val" id="px-val">4 521.08</div>
      <div class="wc-chg up" id="px-chg">
        <span class="wc-chg-abs" id="px-abs">+156.30</span>
        <span class="wc-chg-pct" id="px-pct">+3.58%</span>
      </div>
      <canvas class="wc-chart" id="px-c"></canvas>
      <div class="wc-stats">
        <div>
          <div class="wc-stat-label">Odmiany BW</div>
          <div class="wc-stat-val">5</div>
        </div>
        <div>
          <div class="wc-stat-label">Royalties</div>
          <div class="wc-stat-val">Frutania</div>
        </div>
        <div>
          <div class="wc-stat-label">REORG</div>
          <div class="wc-stat-val" style="color:var(--px)">W toku</div>
        </div>
        <div>
          <div class="wc-stat-label">Certyfikacje</div>
          <div class="wc-stat-val">FSC Â· OZE</div>
        </div>
      </div>
    </div>

  </div>

  <!-- BOTTOM PANELS -->
  <div class="panels">

    <div class="panel">
      <div class="panel-title">AktywnoÅ›Ä‡ rynkowa â€” ostatnie zdarzenia</div>
      <div id="actFeed"></div>
    </div>

    <div class="panel">
      <div class="panel-title">Status systemÃ³w</div>
      <div id="sysFeed"></div>
    </div>

  </div>

</main>

<!-- MALINOOVEK FAB -->
<button class="mal-fab" onclick="toggleMal()" title="Malinoovek â€” asystent AI">ğŸ«</button>

<!-- MALINOOVEK PANEL -->
<div class="mal-panel" id="malPanel">
  <div class="mal-ph">
    <div class="mal-ph-title">ğŸ« MALINOOVEK</div>
    <button class="mal-ph-close" onclick="toggleMal()">&#x2715;</button>
  </div>
  <div class="mal-msgs" id="malMsgs">
    <div class="mal-msg bot">CzeÅ›Ä‡! Jestem Malinoovek â€” asystent AI OvocxMalinovi.
Pytaj o plan 2026, opakowania, procesy, rozliczenia. Mam dostÄ™p do peÅ‚nej wiedzy firmowej.</div>
  </div>
  <div class="mal-input-row">
    <textarea class="mal-input" id="malInput" rows="1"
      placeholder="Pytaj Malinoovkaâ€¦" onkeydown="malKey(event)"></textarea>
    <button class="mal-send" onclick="malSend()">&#x2191;</button>
  </div>
</div>

<script>
// â”€â”€â”€ TIME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function tickTime() {
  var d = new Date();
  var p = function(n){ return String(n).padStart(2,'0'); };
  document.getElementById('hdTime').textContent =
    p(d.getDate())+'.'+p(d.getMonth()+1)+'.'+d.getFullYear()+
    '  '+p(d.getHours())+':'+p(d.getMinutes())+':'+p(d.getSeconds());
}
setInterval(tickTime, 1000);
tickTime();

// â”€â”€â”€ TICKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var TICKERS = [
  { n:'OSÂ·MALINOWI',   v:'1 247.32', c:'+1.00%',  up:true  },
  { n:'HARVESTÂ·50',    v:'892.15',   c:'-0.36%',  up:false },
  { n:'NOÂ·COMPLAINTS', v:'9 987.44', c:'+0.25%',  up:true  },
  { n:'PRODUCTÂ·X',     v:'4 521.08', c:'+3.58%',  up:true  },
  { n:'MALINYÂ·PLN',    v:'12.40',    c:'+2.10%',  up:true  },
  { n:'KARTONYÂ·2026',  v:'686 434',  c:'+48.0%',  up:true  },
  { n:'OGLÂ·FOOD',      v:'244 100',  c:'+12.3%',  up:true  },
  { n:'JERONIMOÂ·MR',   v:'63 200',   c:'+8.5%',   up:true  },
  { n:'GROWERZY',      v:'47',       c:'0.00%',   up:true  },
  { n:'WZÂ·NAÂ·CZAS',    v:'71.2%',    c:'-4.1%',   up:false },
];

(function buildTicker() {
  var items = TICKERS.concat(TICKERS);
  document.getElementById('tickerInner').innerHTML = items.map(function(t) {
    return '<span class="ti">' +
      '<span class="ti-n">' + t.n + '</span>' +
      '<span class="ti-v">' + t.v + '</span>' +
      '<span class="ti-c ' + (t.up ? 'up' : 'down') + '">' + t.c + '</span>' +
      '</span>';
  }).join('');
})();

// â”€â”€â”€ SPARKLINES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function walk(n, start, vol, bias) {
  var d = [start];
  for (var i = 1; i < n; i++) {
    d.push(Math.max(1, d[i-1] + (Math.random()-0.5+bias*0.12)*vol));
  }
  return d;
}

var WALKS = {
  os:  walk(60, 1150, 14, 1.2),
  h50: walk(60,  920,  8, -0.2),
  nc:  walk(60, 9800, 30, 0.9),
  px:  walk(60, 4000, 42, 2.1),
};

function sparkline(id, data, color) {
  var c = document.getElementById(id);
  if (!c) return;
  var dpr = window.devicePixelRatio || 1;
  c.width  = c.offsetWidth  * dpr;
  c.height = c.offsetHeight * dpr;
  var ctx = c.getContext('2d');
  ctx.scale(dpr, dpr);
  var W = c.offsetWidth, H = c.offsetHeight;
  var mn = Math.min.apply(null, data);
  var mx = Math.max.apply(null, data);
  var rng = mx - mn || 1;
  var toX = function(i){ return (i / (data.length - 1)) * W; };
  var toY = function(v){ return H - ((v - mn) / rng) * (H - 6) - 3; };

  var grad = ctx.createLinearGradient(0, 0, 0, H);
  grad.addColorStop(0, color + '38');
  grad.addColorStop(1, color + '00');

  ctx.beginPath();
  ctx.moveTo(0, H);
  data.forEach(function(v, i){ ctx.lineTo(toX(i), toY(v)); });
  ctx.lineTo(W, H);
  ctx.closePath();
  ctx.fillStyle = grad;
  ctx.fill();

  ctx.beginPath();
  data.forEach(function(v, i){
    if (i === 0) ctx.moveTo(toX(i), toY(v));
    else ctx.lineTo(toX(i), toY(v));
  });
  ctx.strokeStyle = color;
  ctx.lineWidth = 1.5;
  ctx.stroke();

  var lx = toX(data.length - 1), ly = toY(data[data.length - 1]);
  ctx.beginPath();
  ctx.arc(lx, ly, 2.5, 0, Math.PI * 2);
  ctx.fillStyle = color;
  ctx.fill();
}

function drawAll() {
  sparkline('os-c',  WALKS.os,  '#e0407b');
  sparkline('h50-c', WALKS.h50, '#00c875');
  sparkline('nc-c',  WALKS.nc,  '#4a9eff');
  sparkline('px-c',  WALKS.px,  '#f5a623');
}

window.addEventListener('load', function(){ requestAnimationFrame(drawAll); });
window.addEventListener('resize', drawAll);

// â”€â”€â”€ LIVE VALUES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var WIGS = {
  os:  { valId:'os-val',  absId:'os-abs',  pctId:'os-pct',  chgId:'os-chg',  val:1247.32, base:1247.32 },
  h50: { valId:'h50-val', absId:'h50-abs', pctId:'h50-pct', chgId:'h50-chg', val:892.15,  base:892.15  },
  nc:  { valId:'nc-val',  absId:'nc-abs',  pctId:'nc-pct',  chgId:'nc-chg',  val:9987.44, base:9987.44 },
  px:  { valId:'px-val',  absId:'px-abs',  pctId:'px-pct',  chgId:'px-chg',  val:4521.08, base:4521.08 },
};

function fmt(v) {
  return v.toLocaleString('pl-PL', { minimumFractionDigits:2, maximumFractionDigits:2 });
}

function tickWIGs() {
  Object.keys(WIGS).forEach(function(k) {
    var w = WIGS[k];
    w.val += (Math.random() - 0.48) * w.base * 0.0018;
    w.val = Math.max(w.base * 0.75, w.val);
    var d = w.val - w.base;
    var p = (d / w.base) * 100;
    var up = d >= 0;
    document.getElementById(w.valId).textContent = fmt(w.val);
    document.getElementById(w.absId).textContent = (up ? '+' : '') + d.toFixed(2);
    document.getElementById(w.pctId).textContent = (up ? '+' : '') + p.toFixed(2) + '%';
    document.getElementById(w.chgId).className = 'wc-chg ' + (up ? 'up' : 'down');
  });
}
setInterval(tickWIGs, 3500);

// â”€â”€â”€ ACTIVITY FEED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var ACTS = [
  { t:'09:42', txt:'OGL Food â€” zamÃ³wienie T22: 2 400 kg malin',       col:'#00c875' },
  { t:'09:38', txt:'Biedronka â€” EDI potwierdzenie dostawy',            col:'#00c875' },
  { t:'09:31', txt:'Kartony mb â€” zamÃ³wienie do TFP: 8 500 szt.',       col:'#4a9eff' },
  { t:'09:18', txt:'WZ ÅobÅ¼enica â€” opÃ³Åºnienie (oczekiwane)',           col:'#f5a623' },
  { t:'08:55', txt:'FA/2026/044 â€” wystawiona przez IzÄ™',               col:'#00c875' },
  { t:'08:40', txt:'Reklamacja #3 â€” przekazana do Olgierda',           col:'#9b9bb0' },
  { t:'08:22', txt:'Przelew do dostawcy â€” zatwierdzony przez ReniÄ™',   col:'#00c875' },
  { t:'08:15', txt:'REORG: mapa procesu Zakupy â€” zaktualizowana',      col:'#9b9bb0' },
];

document.getElementById('actFeed').innerHTML = ACTS.map(function(a) {
  return '<div class="act-row">' +
    '<span class="act-time">' + a.t + '</span>' +
    '<span class="act-dot" style="color:' + a.col + '">&#9679;</span>' +
    '<span style="color:#c0c3d8;font-size:12px">' + a.txt + '</span>' +
    '</div>';
}).join('');

// â”€â”€â”€ SYSTEM STATUS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var SYSTEMS = [
  { n:'StreamSoft ERP',  s:'ok',   l:'Online'     },
  { n:'EDI (DINO)',       s:'ok',   l:'Aktywny'    },
  { n:'Excel RT',         s:'ok',   l:'T08/2026'   },
  { n:'Malinoovek AI',    s:'ok',   l:'Online'     },
  { n:'WZ Magazyny',      s:'warn', l:'OpÃ³Åºnienia' },
  { n:'Certyfikacja BW',  s:'info', l:'W toku'     },
];

var SC = { ok:'#00c875', warn:'#f5a623', info:'#4a9eff', err:'#ff4d6d' };

document.getElementById('sysFeed').innerHTML = SYSTEMS.map(function(s) {
  return '<div class="sys-row">' +
    '<span class="sys-name">' + s.n + '</span>' +
    '<span class="sys-badge" style="color:' + SC[s.s] + ';background:' + SC[s.s] + '18">' + s.l + '</span>' +
    '</div>';
}).join('');

// â”€â”€â”€ MALINOOVEK â€” buildMalContext â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildMalContext(msg) {
  var q = msg.toLowerCase()
    .replace(/Ä…/g,'a').replace(/Ä‡/g,'c').replace(/Ä™/g,'e')
    .replace(/Å‚/g,'l').replace(/Å„/g,'n').replace(/Ã³/g,'o')
    .replace(/Å›/g,'s').replace(/Åº/g,'z').replace(/Å¼/g,'z');

  var dataKeywords = ['karton','opakow','kg','ton','ilosc','wolumen','prognoz','plan','zamow','sprzed','sezon','tygodnie','tyg','pakow','szt','jednostek'];
  var priceKeywords = ['cen','pln','eur','zl','plac','porownaj','rozlicz','rt ','rt2025'];
  var hasDataIntent = dataKeywords.some(function(k){ return q.includes(k); }) ||
                      priceKeywords.some(function(k){ return q.includes(k); });
  if (!hasDataIntent) return '';

  var hasOpak = !!(window.OPAK_DATA && window.OPAK_DATA.rekordy);
  var hasPlan = !!(window.PLAN_DATA && window.PLAN_DATA.length);
  if (!hasOpak && !hasPlan) return '';

  var ODBIORCY = hasOpak ? [...new Set(window.OPAK_DATA.rekordy.map(function(r){ return r.odbiorca; }))] : [];
  var KLIENCI  = hasPlan  ? [...new Set(window.PLAN_DATA.filter(function(r){ return r.typ==='klient'; }).map(function(r){ return r.podmiot; }))] : [];
  var RT_ODB   = (window.RT_SPRZEDAZ && window.RT_SPRZEDAZ.length) ? [...new Set(window.RT_SPRZEDAZ.map(function(r){ return r.odbiorca; }))] : [];
  var ALL_NAMES = [...new Set([...ODBIORCY, ...KLIENCI, ...RT_ODB])];

  function normN(s) {
    return (s||'').toLowerCase()
      .replace(/Ä…/g,'a').replace(/Ä‡/g,'c').replace(/Ä™/g,'e')
      .replace(/Å‚/g,'l').replace(/Å„/g,'n').replace(/Ã³/g,'o')
      .replace(/Å›/g,'s').replace(/Åº/g,'z').replace(/Å¼/g,'z');
  }

  var matchedName = null, bestScore = 0;
  ALL_NAMES.forEach(function(name) {
    var n = normN(name);
    var words = n.split(/\s+/);
    var score = words.filter(function(w){ return q.includes(w) && w.length > 2; }).length;
    if (score > bestScore) { bestScore = score; matchedName = name; }
  });

  var matchedOwoc = null;
  if (q.includes('malin')) matchedOwoc = 'Malina';
  else if (q.includes('truskaw')) matchedOwoc = 'Truskawka tunelowa';

  var MONTHS = {
    'maj':[18,22],'czerw':[23,26],'lip':[27,30],'sierp':[31,35],
    'wrzes':[36,39],'paz':[40,44],'listop':[45,46]
  };
  var matchedWeeks = null;
  Object.keys(MONTHS).forEach(function(kw) {
    if (!matchedWeeks && q.includes(kw)) matchedWeeks = MONTHS[kw];
  });

  var priceKw = ['cen','eur','pln','zl','zÅ‚','plac','platil','kosztow'];
  var asksPrice = priceKw.some(function(k){ return q.includes(k); });

  var ctx = '';

  // â”€â”€ RT 2025 â€” opakowania â”€â”€
  if (hasOpak) {
    var rekordy = window.OPAK_DATA.rekordy;
    if (matchedName) rekordy = rekordy.filter(function(r){ return r.odbiorca === matchedName || normN(r.odbiorca) === normN(matchedName); });
    if (matchedOwoc) rekordy = rekordy.filter(function(r){ return r.owoc === matchedOwoc; });
    if (matchedWeeks) rekordy = rekordy.filter(function(r){ return r.tydzien >= matchedWeeks[0] && r.tydzien <= matchedWeeks[1]; });

    if (rekordy.length > 0) {
      var agg = {};
      rekordy.forEach(function(r) {
        if (!agg[r.pak]) agg[r.pak] = { kg:0, kartony:0, jednostki:0 };
        agg[r.pak].kg        += r.wolumen_kg  || 0;
        agg[r.pak].kartony   += r.kartonow    || 0;
        agg[r.pak].jednostki += r.jednostek   || 0;
      });
      var rows = Object.entries(agg)
        .sort(function(a,b){ return b[1].kartony - a[1].kartony; })
        .slice(0,20)
        .map(function(e){ return e[0]+': '+Math.round(e[1].kg)+' kg, '+e[1].kartony+' kart., '+e[1].jednostki+' jedn.'; })
        .join('\n');
      var totalKg      = rekordy.reduce(function(s,r){ return s+(r.wolumen_kg||0); }, 0);
      var totalKartony = rekordy.reduce(function(s,r){ return s+(r.kartonow||0); }, 0);
      ctx += '\n[DANE FIRMOWE â€” RT 2025';
      if (matchedName) ctx += ', odbiorca: '+matchedName;
      if (matchedOwoc) ctx += ', owoc: '+matchedOwoc;
      if (matchedWeeks) ctx += ', tyg. '+matchedWeeks[0]+'â€“'+matchedWeeks[1];
      ctx += ']\nÅÄ…cznie: '+Math.round(totalKg)+' kg, '+totalKartony+' kartonÃ³w\nWg opakowania:\n'+rows;
    }
  }

  // â”€â”€ RT 2025 â€” ceny sprzedaÅ¼y â”€â”€
  var hasRT = !!(window.RT_SPRZEDAZ && window.RT_SPRZEDAZ.length);
  var asksRT = asksPrice || q.includes('porownaj') || q.includes('cen') || q.includes('rozlicz');
  if (hasRT && asksRT) {
    var rt = window.RT_SPRZEDAZ;
    var isCompare = q.includes('porownaj');
    if (!isCompare && matchedName) {
      rt = rt.filter(function(r){ return normN(r.odbiorca).includes(normN(matchedName)) || normN(matchedName).includes(normN(r.odbiorca).split(' ')[0]); });
    }
    if (matchedOwoc) rt = rt.filter(function(r){ return r.owoc === matchedOwoc; });
    if (matchedWeeks) rt = rt.filter(function(r){ return r.tydzien >= matchedWeeks[0] && r.tydzien <= matchedWeeks[1]; });

    if (rt.length > 0) {
      var rtAgg = {};
      rt.forEach(function(r) {
        var k = r.odbiorca+'|||'+r.owoc;
        if (!rtAgg[k]) rtAgg[k] = { odbiorca:r.odbiorca, owoc:r.owoc, totalKg:0, totalPrzychod:0 };
        rtAgg[k].totalKg       += r.kg;
        rtAgg[k].totalPrzychod += r.przychod;
      });
      var rtRows = Object.values(rtAgg)
        .sort(function(a,b){ return b.totalKg - a.totalKg; })
        .slice(0,20)
        .map(function(v){ return v.odbiorca+' / '+v.owoc+': '+Math.round(v.totalKg)+' kg, Å›r. cena '+(v.totalKg>0?(v.totalPrzychod/v.totalKg).toFixed(2):'â€”')+' PLN/kg'; })
        .join('\n');
      ctx += '\n\n[ROZLICZENIA RT 2025 â€” ceny sprzedaÅ¼y';
      if (!isCompare && matchedName) ctx += ', odbiorca: '+matchedName;
      if (matchedOwoc) ctx += ', owoc: '+matchedOwoc;
      if (matchedWeeks) ctx += ', tyg. '+matchedWeeks[0]+'â€“'+matchedWeeks[1];
      ctx += ']\n'+rtRows;
    }
  }

  // â”€â”€ PLAN 2026 â”€â”€
  if (hasPlan) {
    var plan = window.PLAN_DATA.filter(function(r){ return r.typ==='klient'; });
    if (matchedName) plan = plan.filter(function(r){ return r.podmiot===matchedName || normN(r.podmiot)===normN(matchedName); });
    if (matchedOwoc) plan = plan.filter(function(r){ return r.owoc===matchedOwoc; });
    if (matchedWeeks) plan = plan.filter(function(r){ return r.tydzien>=matchedWeeks[0] && r.tydzien<=matchedWeeks[1]; });

    var planKw = ['plan','prognoz','2026','sezon'];
    var asksPlan = planKw.some(function(k){ return q.includes(k); });

    if (plan.length > 0 && asksPlan) {
      var planKg = plan.reduce(function(s,r){ return s+(r.kg||0); }, 0);
      var planGrp = {};
      plan.forEach(function(r){ var k=r.podmiot+'/'+r.owoc; if(!planGrp[k]) planGrp[k]=0; planGrp[k]+=r.kg||0; });
      var planRows = Object.entries(planGrp)
        .sort(function(a,b){ return b[1]-a[1]; }).slice(0,10)
        .map(function(e){ return e[0]+': '+Math.round(e[1])+' kg'; }).join('\n');
      ctx += '\n\n[PLAN 2026';
      if (matchedName) ctx += ', klient: '+matchedName;
      if (matchedOwoc) ctx += ', owoc: '+matchedOwoc;
      ctx += ']\nÅÄ…cznie: '+Math.round(planKg)+' kg\n'+planRows;
    }
  }

  return ctx;
}

// â”€â”€â”€ MALINOOVEK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var MAL_SYSTEM = 'JesteÅ› Malinoovkiem â€” asystentem AI firmy OvocxMalinovi sp. z o.o.\n' +
  'Twoja rola: wspieraÄ‡ zespÃ³Å‚ w codziennej pracy, optymalizacji procesÃ³w i zarzÄ…dzaniu wiedzÄ… firmowÄ….\n' +
  'Zawsze odpowiadaj po polsku, chyba Å¼e ktoÅ› pisze do Ciebie w innym jÄ™zyku.\n' +
  'JesteÅ› konkretny, procesowy i praktyczny. Nie owijasz w baweÅ‚nÄ™. Odpowiedzi krÃ³tkie â€” max 3-4 zdania lub lista punktÃ³w.';

var malHistory = [];

function toggleMal() {
  var p = document.getElementById('malPanel');
  p.classList.toggle('open');
  if (p.classList.contains('open')) document.getElementById('malInput').focus();
}

function malGetKey() {
  var cfg = window.OXM_CONFIG;
  if (cfg && cfg.apiKey && cfg.apiKey !== '__ANTHROPIC_KEY__') return cfg.apiKey;
  var stored = localStorage.getItem('oxm_api_key');
  if (stored) return stored;
  var k = prompt('Wklej klucz API Anthropic (sk-ant-\u2026):');
  if (k && k.startsWith('sk-')) { localStorage.setItem('oxm_api_key', k); return k; }
  return null;
}

function malModel() {
  return (window.OXM_CONFIG && window.OXM_CONFIG.model) || 'claude-haiku-4-5-20251001';
}

function malAdd(role, text) {
  var box = document.getElementById('malMsgs');
  var d = document.createElement('div');
  d.className = 'mal-msg ' + (role === 'user' ? 'user' : 'bot');
  d.textContent = text;
  box.appendChild(d);
  box.scrollTop = box.scrollHeight;
  return d;
}

function malKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); malSend(); }
}

async function malSend() {
  var inp = document.getElementById('malInput');
  var q = inp.value.trim();
  if (!q) return;
  var key = malGetKey();
  if (!key) return;
  inp.value = '';
  malAdd('user', q);
  var ctxData = buildMalContext(q);
  var msgContent = ctxData ? q + '\n\n[Kontekst danych firmowych:' + ctxData + ']' : q;
  malHistory.push({ role: 'user', content: msgContent });

  var typing = malAdd('bot', 'Malinoovek pisze\u2026');
  typing.classList.add('typing');

  try {
    var res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': key,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true',
      },
      body: JSON.stringify({
        model: malModel(),
        max_tokens: 1024,
        system: MAL_SYSTEM + (window.FIRMA_WIEDZA ? '\n\n---\n' + window.FIRMA_WIEDZA : ''),
        messages: malHistory,
      }),
    });

    typing.remove();

    if (!res.ok) {
      var err = await res.json().catch(function(){ return {}; });
      malAdd('bot', 'BÅ‚Ä…d API: ' + ((err.error && err.error.message) || res.status));
      return;
    }

    var data = await res.json();
    var answer = (data.content && data.content[0] && data.content[0].text) || '(brak odpowiedzi)';
    malHistory.push({ role: 'assistant', content: answer });
    malAdd('bot', answer);

  } catch(e) {
    typing.remove();
    malAdd('bot', 'BÅ‚Ä…d poÅ‚Ä…czenia: ' + e.message);
  }
}
</script>
</body>
</html>
