<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Plan Zakup√≥w Karton√≥w 2026 ‚Äî OvocxMalinovi</title>
<script src="plan-zakupow-2026-data.js"></script>
<script src="planowanie-data.js"></script>
<script src="zakupy-data.js"></script>
<script src="dostawcy-data.js"></script>
<script src="karton-mapa.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --orange:#fa4211; --purple:#9013fe; --green:#16a34a; --blue:#2563eb; --yellow:#d97706;
  --grad:linear-gradient(135deg,#fa4211,#9013fe);
  --bg:#f7f7f5; --white:#fff;
  --border:#e8e6e1; --border2:#d8d5ce;
  --text:#1a1a18; --text-dim:#4a4a46; --text-muted:#8a8a82;
  --surface2:#f0ede8; --nav-h:52px;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}

/* ‚îÄ‚îÄ Nav ‚îÄ‚îÄ */
.nav{height:var(--nav-h);background:var(--white);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 20px;gap:12px;position:sticky;top:0;z-index:100}
.nav-logo{background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight:800;font-size:15px;letter-spacing:-.3px;white-space:nowrap}
.nav-sep{width:1px;height:20px;background:var(--border2)}
.nav-back{font-size:12px;color:var(--text-muted);text-decoration:none;display:flex;align-items:center;gap:4px;padding:4px 8px;border-radius:6px;transition:background .15s}
.nav-back:hover{background:var(--surface2);color:var(--text-dim)}
.nav-title{font-size:13px;font-weight:600;color:var(--text)}
.nav-spacer{flex:1}
.nav-badge{font-family:'DM Mono',monospace;font-size:10px;padding:3px 8px;border-radius:8px;background:rgba(22,163,74,.1);color:var(--green);border:1px solid rgba(22,163,74,.2)}

/* ‚îÄ‚îÄ Main layout ‚îÄ‚îÄ */
.main{max-width:1200px;margin:0 auto;padding:20px 16px 40px}

/* ‚îÄ‚îÄ Page header ‚îÄ‚îÄ */
.page-head{margin-bottom:20px}
.page-head-row{display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:10px}
.page-head h1{font-size:22px;font-weight:800;letter-spacing:-.4px;line-height:1.2}
.page-head-meta{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.source-link{display:flex;align-items:center;gap:5px;font-size:11px;font-weight:600;color:var(--text-muted);text-decoration:none;padding:4px 9px;border:1px solid var(--border2);border-radius:7px;transition:all .15s;font-family:'DM Mono',monospace}
.source-link:hover{border-color:var(--orange);color:var(--orange);background:rgba(250,66,17,.04)}
.source-link span{font-size:12px}
.alert-info{background:rgba(217,119,6,.08);border:1px solid rgba(217,119,6,.25);border-radius:9px;padding:10px 14px;font-size:12px;color:#92400e;line-height:1.5;display:flex;gap:8px;align-items:flex-start}
.alert-info strong{white-space:nowrap}

/* ‚îÄ‚îÄ CTA button ‚îÄ‚îÄ */
.gen-btn{background:var(--grad);color:white;border:none;padding:9px 18px;border-radius:9px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:700;cursor:pointer;letter-spacing:.2px;display:flex;align-items:center;gap:7px;transition:opacity .15s,transform .12s;white-space:nowrap;box-shadow:0 2px 8px rgba(250,66,17,.3)}
.gen-btn:hover{opacity:.9;transform:translateY(-1px)}
.gen-btn:active{transform:translateY(0)}

/* ‚îÄ‚îÄ KPI stats ‚îÄ‚îÄ */
.kpi-row{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:20px}
@media(max-width:700px){.kpi-row{grid-template-columns:repeat(2,1fr)}}
.kpi{background:var(--white);border:1px solid var(--border);border-radius:10px;padding:13px 16px}
.kpi-label{font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:.05em;font-family:'DM Mono',monospace;margin-bottom:5px}
.kpi-val{font-size:22px;font-weight:800;font-variant-numeric:tabular-nums;line-height:1}
.kpi-sub{font-size:10px;color:var(--text-muted);margin-top:3px}

/* ‚îÄ‚îÄ Group cards ‚îÄ‚îÄ */
.group-row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px}
@media(max-width:700px){.group-row{grid-template-columns:1fr}}
.group-card{background:var(--white);border:2px solid var(--border);border-radius:10px;padding:13px 16px;cursor:pointer;transition:all .15s}
.group-card:hover,.group-card.active{border-width:2px}
.group-card.active-OGL{border-color:var(--orange);background:rgba(250,66,17,.03)}
.group-card.active-Jeronimo{border-color:var(--purple);background:rgba(144,19,254,.03)}
.group-card.active-Pozostali{border-color:var(--blue);background:rgba(37,99,235,.03)}
.group-card.active-all{border-color:var(--green);background:rgba(22,163,74,.03)}
.gc-name{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px}
.gc-name-OGL{color:var(--orange)}
.gc-name-Jeronimo{color:var(--purple)}
.gc-name-Pozostali{color:var(--blue)}
.gc-kl{font-size:10px;color:var(--text-muted);margin-bottom:10px}
.gc-stat{display:flex;justify-content:space-between;align-items:baseline;margin-top:5px}
.gc-val{font-size:18px;font-weight:800;font-variant-numeric:tabular-nums}
.gc-lbl{font-size:10px;color:var(--text-muted);font-family:'DM Mono',monospace}
.gc-badge{font-size:10px;font-family:'DM Mono',monospace;padding:1px 6px;border-radius:5px}
.badge-no-plan{background:rgba(217,119,6,.1);color:#92400e}
.badge-has-plan{background:rgba(22,163,74,.1);color:var(--green)}

/* ‚îÄ‚îÄ Tab bar ‚îÄ‚îÄ */
.tabs{display:flex;gap:4px;margin-bottom:16px;background:var(--surface2);padding:4px;border-radius:10px;width:fit-content}
.tab-btn{padding:6px 16px;border-radius:7px;border:none;background:transparent;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;transition:all .15s;color:var(--text-muted)}
.tab-btn.active{background:var(--white);color:var(--text);box-shadow:0 1px 3px rgba(0,0,0,.1)}
.tab-btn:hover:not(.active){color:var(--text)}

/* ‚îÄ‚îÄ Main table ‚îÄ‚îÄ */
.table-wrap{background:var(--white);border:1px solid var(--border);border-radius:12px;overflow:hidden}
.plan-table{width:100%;border-collapse:collapse;font-size:12px}
.plan-table th{background:var(--surface2);color:var(--text-muted);font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;padding:9px 12px;text-align:left;border-bottom:1px solid var(--border);white-space:nowrap}
.plan-table th.num{text-align:right}
.plan-table td{padding:8px 12px;border-bottom:1px solid var(--border);vertical-align:middle}
.plan-table tr:last-child>td{border-bottom:none}
.client-row{cursor:pointer;transition:background .1s}
.client-row:hover td{background:rgba(250,66,17,.02)}
.client-row td{background:var(--white)}
.expand-icon{display:inline-block;transition:transform .2s;font-size:10px;margin-right:4px;color:var(--text-muted)}
.client-row.open .expand-icon{transform:rotate(90deg)}
.pak-row{background:var(--surface2)!important}
.pak-row td{padding:5px 12px 5px 36px;border-bottom:1px solid var(--border);font-size:11px;color:var(--text-dim)}
.pak-row:last-of-type td{border-bottom:1px solid var(--border)}
.num-cell{font-family:'DM Mono',monospace;text-align:right;font-variant-numeric:tabular-nums}

/* Ratio badge */
.ratio-badge{display:inline-block;font-family:'DM Mono',monospace;font-size:10px;padding:2px 6px;border-radius:6px;font-weight:700}
.r-up{background:rgba(22,163,74,.12);color:#166534}
.r-neutral{background:rgba(37,99,235,.1);color:#1e3a8a}
.r-down{background:rgba(217,119,6,.1);color:#92400e}
.r-none{background:rgba(138,138,130,.1);color:var(--text-muted)}

/* Progress bar */
.prog-bar{height:5px;border-radius:3px;background:var(--border);position:relative;min-width:60px;overflow:hidden}
.prog-fill{height:100%;border-radius:3px;position:absolute;left:0;top:0}

/* Group color strip */
.g-strip{display:inline-block;width:3px;height:14px;border-radius:2px;vertical-align:middle;margin-right:6px}
.g-OGL{background:var(--orange)}
.g-Jeronimo{background:var(--purple)}
.g-Pozostali{background:var(--blue)}

/* Owoc chip */
.owoc-chip{display:inline-block;font-size:10px;padding:2px 6px;border-radius:5px;font-weight:600;white-space:nowrap}
.o-Malina{background:rgba(250,66,17,.1);color:var(--orange)}
.o-Truskawka{background:rgba(220,38,38,.1);color:#dc2626}
.o-Je≈ºyna{background:rgba(144,19,254,.1);color:var(--purple)}
.o-Porzeczka{background:rgba(37,99,235,.1);color:var(--blue)}
.o-Agrest{background:rgba(22,163,74,.1);color:var(--green)}

/* Table footer */
.table-footer{padding:8px 14px;background:var(--surface2);border-top:1px solid var(--border);font-size:11px;color:var(--text-muted);font-family:'DM Mono',monospace;display:flex;justify-content:space-between;align-items:center}

/* No-plan row */
.no-plan-row td{opacity:.65}
.no-plan-note{font-size:10px;color:var(--yellow);font-style:italic}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   WIZARD OVERLAY
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.wz-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:500;display:flex;align-items:flex-start;justify-content:center;overflow-y:auto;padding:24px 16px 48px}
.wz-overlay.hidden{display:none}
.wz-panel{background:var(--white);border-radius:16px;width:100%;max-width:880px;box-shadow:0 24px 80px rgba(0,0,0,.35);overflow:hidden;margin:auto}
.wz-head{background:var(--grad);padding:14px 18px;display:flex;align-items:center;justify-content:space-between}
.wz-head h2{color:white;font-size:14px;font-weight:800;letter-spacing:-.2px}
.wz-close{background:rgba(255,255,255,.18);border:none;color:white;width:28px;height:28px;border-radius:7px;cursor:pointer;font-size:16px;line-height:1;transition:background .15s;flex-shrink:0}
.wz-close:hover{background:rgba(255,255,255,.35)}
.wz-stepper{padding:8px 18px;background:var(--surface2);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;font-size:11px}
.wz-dot{width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;flex-shrink:0;transition:all .2s}
.wz-dot-idle{background:var(--border);color:var(--text-muted)}
.wz-dot-active{background:var(--orange);color:white}
.wz-dot-done{background:var(--green);color:white}
.wz-line{flex:1;height:1px;background:var(--border)}
.wz-step-lbl{margin-left:auto;font-weight:700;font-size:11px;color:var(--text-dim);white-space:nowrap}
.wz-body{padding:18px 20px;min-height:240px}
.wz-footer{padding:12px 20px;border-top:1px solid var(--border);background:var(--surface2);display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
.wz-sec{margin-bottom:18px}
.wz-sec h3{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--text-muted);margin-bottom:10px;display:flex;align-items:center;gap:6px}
.wz-sec h3::after{content:'';flex:1;height:1px;background:var(--border)}
.wz-chips{display:flex;gap:8px;flex-wrap:wrap}
.wz-chip{padding:8px 14px;border:2px solid var(--border);border-radius:9px;cursor:pointer;font-size:12px;font-weight:600;transition:all .15s;user-select:none;display:flex;align-items:center;gap:6px;background:transparent;font-family:'Plus Jakarta Sans',sans-serif;color:var(--text-muted)}
.wz-chip:hover{border-color:var(--border2);color:var(--text)}
.wz-chip.on-OGL{border-color:var(--orange);background:rgba(250,66,17,.06);color:var(--orange)}
.wz-chip.on-Jeronimo{border-color:var(--purple);background:rgba(144,19,254,.06);color:var(--purple)}
.wz-chip.on-Pozostali{border-color:var(--blue);background:rgba(37,99,235,.06);color:var(--blue)}
.wz-radio-list{display:flex;flex-direction:column;gap:8px}
.wz-radio-item{border:2px solid var(--border);border-radius:9px;padding:10px 14px;cursor:pointer;transition:border-color .15s;display:flex;align-items:flex-start;gap:10px}
.wz-radio-item:hover{border-color:var(--border2)}
.wz-radio-item.sel{border-color:var(--blue);background:rgba(37,99,235,.03)}
.wz-radio-item input[type=radio]{accent-color:var(--blue);margin-top:2px;flex-shrink:0}
.wz-rlabel{font-size:12px;font-weight:700}
.wz-rsub{font-size:11px;color:var(--text-muted);margin-top:2px}
.wz-months{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-top:10px}
.mth-btn{padding:7px 4px;border:1.5px solid var(--border);border-radius:7px;text-align:center;cursor:pointer;font-size:11px;font-weight:600;transition:all .15s;background:transparent;font-family:'Plus Jakarta Sans',sans-serif;color:var(--text-muted)}
.mth-btn:hover{border-color:var(--border2);color:var(--text)}
.mth-btn.sel{border-color:var(--blue);background:rgba(37,99,235,.09);color:var(--blue)}
.mth-btn.dis{opacity:.4;cursor:default}
/* Step 2 ‚Äî assign table */
.assign-wrap{overflow-x:auto;border:1px solid var(--border);border-radius:10px}
.assign-table{width:100%;border-collapse:collapse;font-size:11px}
.assign-table th{background:var(--surface2);padding:7px 10px;text-align:left;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--text-muted);border-bottom:1px solid var(--border);white-space:nowrap}
.assign-table th.r{text-align:right}
.assign-table td{padding:7px 10px;border-bottom:1px solid var(--border);vertical-align:middle}
.assign-table tr:last-child td{border-bottom:none}
.assign-table td.r{text-align:right;font-family:'DM Mono',monospace}
.assign-sel{font-size:11px;padding:4px 7px;border:1.5px solid var(--border2);border-radius:6px;width:100%;min-width:180px;background:white;font-family:'Plus Jakarta Sans',sans-serif;color:var(--text);cursor:pointer}
.assign-sel:focus{outline:none;border-color:var(--orange)}
.val-need{color:var(--blue);font-weight:700}
.val-ok{color:var(--green);font-weight:700}
.val-warn{color:var(--orange);font-weight:700}
.val-order{color:var(--orange);font-weight:800}
/* Step 3 ‚Äî summary */
.rfq-head{display:flex;align-items:center;gap:16px;padding:14px 16px;background:var(--surface2);border-radius:10px;margin-bottom:16px}
.rfq-avatar{flex-shrink:0}
.rfq-meta{flex:1}
.rfq-meta h3{font-size:14px;font-weight:800;letter-spacing:-.2px}
.rfq-meta .doc-title{font-size:12px;font-weight:700;color:var(--orange);margin-top:2px}
.rfq-meta p{font-size:11px;color:var(--text-muted);margin-top:3px}
.sum-wrap{overflow-x:auto;border:1px solid var(--border);border-radius:10px}
.sum-table{width:100%;border-collapse:collapse;font-size:12px}
.sum-table th{background:#1a1a18;color:white;padding:8px 12px;text-align:left;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.05em}
.sum-table th.r{text-align:right}
.sum-table td{padding:9px 12px;border-bottom:1px solid var(--border)}
.sum-table td.r{text-align:right;font-family:'DM Mono',monospace}
.sum-table tr.total-row td{background:var(--surface2);font-weight:700}
.big-qty{font-family:'DM Mono',monospace;font-size:16px;font-weight:800;color:var(--orange)}
.notes-box{margin-top:14px;padding:12px 14px;background:rgba(37,99,235,.04);border:1px solid rgba(37,99,235,.15);border-radius:9px;font-size:11px;color:var(--text-dim);line-height:1.7}
/* Wizard buttons */
.wz-btn{padding:8px 18px;border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:700;cursor:pointer;border:none;transition:all .15s}
.wz-btn-ghost{background:transparent;border:1.5px solid var(--border2);color:var(--text-dim)}
.wz-btn-ghost:hover{border-color:var(--text-muted);color:var(--text)}
.wz-btn-primary{background:var(--grad);color:white;box-shadow:0 2px 8px rgba(250,66,17,.25)}
.wz-btn-primary:hover{opacity:.9}
.wz-btn-green{background:var(--green);color:white}
.wz-btn-green:hover{opacity:.9}
.wz-btn-blue{background:var(--blue);color:white}
.wz-btn-blue:hover{opacity:.9}

/* ‚ïê‚ïê‚ïê‚ïê PRINT / PDF ‚ïê‚ïê‚ïê‚ïê */
#print-area{display:none}
@media print{
  body>*{display:none!important}
  #print-area{display:block!important;padding:20px}
  .print-table td,.print-table th{font-size:10px!important;padding:5px 8px!important}
}
.print-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:20px;padding-bottom:14px;border-bottom:3px solid #fa4211}
.print-logo-txt{font-size:20px;font-weight:900;color:#fa4211;font-family:'Plus Jakarta Sans',sans-serif}
.print-doc-title{font-size:14px;font-weight:700;margin-top:4px}
.print-meta{font-size:11px;color:#666;margin-top:6px;line-height:1.6}
.print-renia{text-align:center;font-size:10px;color:#666}
.print-table{width:100%;border-collapse:collapse;font-size:11px;margin-top:10px}
.print-table th{background:#1a1a18;color:white;padding:7px 10px;text-align:left;font-size:10px;font-weight:700}
.print-table th.r{text-align:right}
.print-table td{padding:7px 10px;border-bottom:1px solid #e8e6e1}
.print-table td.r{text-align:right;font-family:monospace;font-weight:700}
.print-table tr:nth-child(even) td{background:#f7f7f5}
.print-table .total-row td{background:#1a1a18;color:white;font-weight:700}
.print-table .total-row td.r{color:#fa4211}
.print-footer{margin-top:16px;font-size:10px;color:#888;border-top:1px solid #e8e6e1;padding-top:8px}
.print-notes{margin-top:14px;font-size:11px;line-height:1.7;color:#444;border:1px solid #e8e6e1;padding:10px 12px;border-radius:6px}
</style>
</head>
<body>

<!-- ‚îÄ‚îÄ Nav ‚îÄ‚îÄ -->
<nav class="nav">
  <span class="nav-logo">OvocxMalinovi</span>
  <span class="nav-sep"></span>
  <a href="zakupy-planowanie.html" class="nav-back">‚Üê Zakupy</a>
  <span class="nav-sep"></span>
  <span class="nav-title">Plan Zakup√≥w Karton√≥w 2026</span>
  <span class="nav-spacer"></span>
  <span class="nav-badge" id="nav-date-badge"></span>
</nav>

<main class="main">

  <!-- ‚îÄ‚îÄ Nag≈Ç√≥wek ‚îÄ‚îÄ -->
  <div class="page-head">
    <div class="page-head-row">
      <div>
        <h1>Plan Zakup√≥w Karton√≥w ‚Äî Sezon 2026</h1>
        <p style="font-size:12px;color:var(--text-muted);margin-top:4px">
          Estymacja na podstawie proporcji karton√≥w 2025 przeskalowanych do planu sprzeda≈ºy 2026
        </p>
      </div>
      <div class="page-head-meta">
        <a href="planowanie-i-sprzedaz.html" target="_blank" class="source-link">
          <span>üìä</span> Plan sprzeda≈ºy 2026
        </a>
        <a href="kartony-dostawcy.html" class="source-link" style="border-color:rgba(144,19,254,.3);color:var(--purple)">
          <span>üè≠</span> Dostawcy karton√≥w
        </a>
        <a href="https://github.com/janlipczynski-admin/ovocxmalinovi-brain-/commits/main/planowanie-data.js"
           target="_blank" class="source-link">
          <span>üïê</span> Historia zmian
        </a>
        <button class="gen-btn" onclick="openWizard()">
          <span style="font-size:14px">üõí</span> GENERUJ ZAPOTRZEBOWANIE
        </button>
      </div>
    </div>
    <div class="alert-info" id="plan-alert">
      <strong>‚ÑπÔ∏è</strong>
      <span id="plan-alert-text">≈Åadowanie danych‚Ä¶</span>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ KPI row ‚îÄ‚îÄ -->
  <div class="kpi-row">
    <div class="kpi">
      <div class="kpi-label">Sprzedano 2025 (RT)</div>
      <div class="kpi-val" id="kpi-kg-rt" style="color:var(--text-dim)">‚Äî</div>
      <div class="kpi-sub">kg ‚Äî rzeczywiste dostawy do klient√≥w</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">Plan sprzeda≈ºy 2026</div>
      <div class="kpi-val" id="kpi-kg" style="color:var(--orange)">‚Äî</div>
      <div class="kpi-sub">kg (suma klient√≥w z planem)</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">Szac. karton√≥w 2026</div>
      <div class="kpi-val" id="kpi-kart" style="color:var(--blue)">‚Äî</div>
      <div class="kpi-sub">proporcje ZP 2025 √ó ratio plan/RT</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">Klient√≥w z planem</div>
      <div class="kpi-val" id="kpi-klienci">‚Äî</div>
      <div class="kpi-sub">z <span id="kpi-total-kl"></span> zmapowanych</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">Kart. baza 2025 (ZP)</div>
      <div class="kpi-val" id="kpi-hist" style="font-size:16px;color:var(--text-dim)">‚Äî</div>
      <div class="kpi-sub">kartony faktyczne 2025</div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ Group cards ‚îÄ‚îÄ -->
  <div class="group-row" id="group-cards"></div>

  <!-- ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ -->
  <div class="tabs">
    <button class="tab-btn active" data-tab="all" onclick="setTab('all')">TOTAL</button>
    <button class="tab-btn" data-tab="OGL" onclick="setTab('OGL')" style="color:var(--orange)">OGL</button>
    <button class="tab-btn" data-tab="Jeronimo" onclick="setTab('Jeronimo')" style="color:var(--purple)">Jeronimo (Biedronka)</button>
    <button class="tab-btn" data-tab="Pozostali" onclick="setTab('Pozostali')">Pozostali</button>
  </div>

  <!-- ‚îÄ‚îÄ Tabela ‚îÄ‚îÄ -->
  <div class="table-wrap">
    <table class="plan-table">
      <thead>
        <tr>
          <th style="width:24px"></th>
          <th>Klient</th>
          <th>Owoc</th>
          <th class="num">Kg sprzedano 2025 (RT)</th>
          <th class="num">Kg plan 2026</th>
          <th class="num" style="width:80px">Zmiana</th>
          <th class="num">Kart. 2025</th>
          <th class="num">Kart. plan 2026</th>
          <th class="num" style="width:90px">Proporcja</th>
        </tr>
      </thead>
      <tbody id="plan-tbody"></tbody>
    </table>
    <div class="table-footer" id="plan-footer"></div>
  </div>

</main>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     WIZARD OVERLAY
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="wz-overlay hidden" id="wz-overlay">
  <div class="wz-panel" id="wz-panel">
    <!-- Header -->
    <div class="wz-head">
      <h2>üõí Generuj Zapotrzebowanie na Kartony</h2>
      <button class="wz-close" onclick="closeWizard()" title="Zamknij">‚úï</button>
    </div>
    <!-- Step indicators -->
    <div class="wz-stepper">
      <div class="wz-dot wz-dot-active" id="wz-dot-1">1</div>
      <span style="font-size:11px;color:var(--text-muted)">Parametry</span>
      <div class="wz-line"></div>
      <div class="wz-dot wz-dot-idle" id="wz-dot-2">2</div>
      <span style="font-size:11px;color:var(--text-muted)">Przypisanie karton√≥w</span>
      <div class="wz-line"></div>
      <div class="wz-dot wz-dot-idle" id="wz-dot-3">3</div>
      <span style="font-size:11px;color:var(--text-muted)">Podsumowanie</span>
      <span class="wz-step-lbl" id="wz-step-lbl">Parametry zam√≥wienia</span>
    </div>
    <!-- Dynamic body -->
    <div class="wz-body" id="wz-body"></div>
    <!-- Dynamic footer -->
    <div class="wz-footer" id="wz-footer"></div>
  </div>
</div>

<!-- Print / PDF area -->
<div id="print-area"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     EXISTING PAGE SCRIPT
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
const D = window.PLAN2026_DATA;
let activeTab = 'all';

const fmt  = n => n == null ? '‚Äî' : Math.round(n).toLocaleString('pl-PL');
const fmtK = n => n == null ? '‚Äî' : (n >= 1000 ? (n/1000).toFixed(1)+'k' : String(n));

function ratioBadge(ratio) {
  if (ratio == null) return '<span class="ratio-badge r-none">brak planu</span>';
  const pct = Math.round((ratio-1)*100);
  const cls = ratio >= 1 ? 'r-up' : ratio >= 0.5 ? 'r-neutral' : 'r-down';
  const arrow = ratio >= 1 ? '‚ñ≤' : '‚ñº';
  return `<span class="ratio-badge ${cls}">${arrow} ${pct}%</span>`;
}

function owocChip(owoc) {
  const key = owoc.replace('Truskawka tunelowa','Truskawka').replace('Truskawka szklarniowa','Truskawka').split(' ')[0];
  return `<span class="owoc-chip o-${key}">${owoc}</span>`;
}

function gStrip(group) {
  return `<span class="g-strip g-${group}"></span>`;
}

function progBar(ratio) {
  if (ratio == null) return '';
  const w = Math.min(ratio * 100, 200);
  const col = ratio >= 1 ? 'var(--green)' : ratio >= 0.5 ? 'var(--blue)' : 'var(--yellow)';
  return `<div class="prog-bar"><div class="prog-fill" style="width:${w}%;background:${col}"></div></div>`;
}

function renderKPIs() {
  const { totals, group_totals, rows } = D;
  const klienci_z_planem = [...new Set(rows.filter(r=>r.kartony_2026).map(r=>r.klient))].length;
  const total_klienci    = [...new Set(rows.map(r=>r.klient))].length;
  const rt_total = rows.reduce((s,r)=>s+(r.kg_rt_2025||0),0);
  document.getElementById('kpi-kg-rt').textContent = fmt(rt_total);
  document.getElementById('kpi-kg').textContent    = fmt(totals.kg_plan_2026);
  document.getElementById('kpi-kart').textContent  = fmt(totals.kartony_2026);
  document.getElementById('kpi-klienci').textContent = klienci_z_planem;
  document.getElementById('kpi-total-kl').textContent = total_klienci;
  document.getElementById('kpi-hist').textContent  = fmt(totals.kartony_2025);
  document.getElementById('nav-date-badge').textContent = 'Sezon 2026 ¬∑ ' + D.wygenerowano;
}

function renderGroupCards() {
  const { group_totals } = D;
  const groups = [
    {id:'all', label:'TOTAL', klienci:'Wszyscy klienci', color:'green'},
    {id:'OGL', label:'OGL', klienci:'OGL Food Trade', color:'orange'},
    {id:'Jeronimo', label:'Jeronimo', klienci:'Biedronka (Jeronimo Martins)', color:'purple'},
    {id:'Pozostali', label:'Pozostali', klienci: (group_totals['Pozostali']?.klienci||[]).join(', '), color:'blue'}
  ];
  const totalAll = D.totals;
  const totalsMap = {all: {kartony_2025:totalAll.kartony_2025, kartony_2026:totalAll.kartony_2026}, ...group_totals};
  document.getElementById('group-cards').innerHTML = groups.map(g => {
    const t = totalsMap[g.id] || {};
    const hasP = (t.kartony_2026||0) > 0;
    return `
    <div class="group-card ${activeTab===g.id?'active-'+g.id:''}" onclick="setTab('${g.id}')">
      <div class="gc-name gc-name-${g.id==='all'?'Pozostali':g.id}">${g.label}</div>
      <div class="gc-kl" title="${g.klienci}">${g.klienci.length > 60 ? g.klienci.substring(0,60)+'‚Ä¶' : g.klienci}</div>
      <div class="gc-stat">
        <div><div class="gc-lbl">Kart. 2025</div><div class="gc-val">${fmt(t.kartony_2025)}</div></div>
        <div style="text-align:right"><div class="gc-lbl">Kart. plan 2026</div><div class="gc-val" style="color:${hasP?'var(--green)':'var(--text-muted)'}">${hasP?fmt(t.kartony_2026):'‚Äî'}</div></div>
      </div>
      ${hasP ? `<div style="margin-top:6px">${progBar((t.kartony_2026||0)/(t.kartony_2025||1))}</div>` : ''}
    </div>`;
  }).join('');
}

function renderTable() {
  const rows = activeTab === 'all' ? D.rows : D.rows.filter(r => r.group === activeTab);
  let html = '';
  rows.forEach((r, idx) => {
    const rowId = 'r' + idx;
    const hasP  = r.kartony_2026 != null;
    html += `
    <tr class="client-row ${!hasP?'no-plan-row':''}" onclick="togglePaks('${rowId}',this)">
      <td><span class="expand-icon">‚ñ∂</span></td>
      <td>${gStrip(r.group)}<strong>${r.klient}</strong></td>
      <td>${owocChip(r.owoc)}</td>
      <td class="num-cell">${fmt(r.kg_rt_2025)}</td>
      <td class="num-cell">${hasP ? fmt(r.kg_2026) : '<span class="no-plan-note">brak planu</span>'}</td>
      <td class="num-cell">${ratioBadge(r.ratio)}</td>
      <td class="num-cell">${fmt(r.kartony_2025)}</td>
      <td class="num-cell"><strong>${hasP ? fmt(r.kartony_2026) : '‚Äî'}</strong></td>
      <td class="num-cell">${hasP ? progBar(r.ratio) : ''}</td>
    </tr>`;
    html += `<tr id="${rowId}-paks" style="display:none"><td colspan="9" style="padding:0;background:var(--surface2)">
      <table style="width:100%;border-collapse:collapse;font-size:11px">
        <tr style="background:rgba(0,0,0,.03)">
          <th style="padding:5px 12px 5px 36px;text-align:left;font-size:10px;color:var(--text-muted);font-weight:600;width:38%">Kod kartonu</th>
          <th style="padding:5px 8px;text-align:center;font-size:10px;color:var(--text-muted);font-weight:600">Waga</th>
          <th style="padding:5px 8px;text-align:center;font-size:10px;color:var(--text-muted);font-weight:600">Szt/kart</th>
          <th style="padding:5px 8px;text-align:right;font-size:10px;color:var(--text-muted);font-weight:600">Udz. 2025</th>
          <th style="padding:5px 8px;text-align:right;font-size:10px;color:var(--text-muted);font-weight:600">Kart. 2025</th>
          <th style="padding:5px 8px;text-align:right;font-size:10px;color:var(--text-muted);font-weight:600">Kart. plan 2026</th>
        </tr>
        ${r.paks.filter(p=>p.udzial >= 0.5).map(p => `
        <tr style="border-top:1px solid var(--border)">
          <td style="padding:5px 12px 5px 36px;font-family:'DM Mono',monospace;font-size:10px">${p.pak}</td>
          <td style="padding:5px 8px;text-align:center;color:var(--text-muted)">${p.waga_g}g</td>
          <td style="padding:5px 8px;text-align:center;color:var(--text-muted)">√ó${p.szt}</td>
          <td style="padding:5px 8px;text-align:right;color:var(--text-muted)">${p.udzial}%</td>
          <td style="padding:5px 8px;text-align:right;font-family:'DM Mono',monospace">${fmt(p.kartony_2025)}</td>
          <td style="padding:5px 8px;text-align:right;font-family:'DM Mono',monospace;font-weight:700;color:${p.kartony_2026?'var(--green)':'var(--text-muted)'}">${p.kartony_2026 != null ? fmt(p.kartony_2026) : '‚Äî'}</td>
        </tr>`).join('')}
      </table>
    </td></tr>`;
  });
  document.getElementById('plan-tbody').innerHTML = html;
  const withPlan   = rows.filter(r=>r.kartony_2026).length;
  const totalKart  = rows.filter(r=>r.kartony_2026).reduce((s,r)=>s+(r.kartony_2026||0),0);
  const totalKart25= rows.reduce((s,r)=>s+r.kartony_2025,0);
  document.getElementById('plan-footer').innerHTML = `
    <span>${rows.length} wierszy ¬∑ ${withPlan} z planem 2026</span>
    <span>2025: ${fmt(totalKart25)} kart. &nbsp;‚Üí&nbsp; <strong>2026 plan: ${fmt(totalKart)} kart.</strong></span>`;
}

function togglePaks(id, row) {
  const pr = document.getElementById(id+'-paks');
  if (!pr) return;
  const vis = pr.style.display !== 'none';
  pr.style.display = vis ? 'none' : 'table-row';
  row.classList.toggle('open', !vis);
}

function setTab(tab) {
  activeTab = tab;
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
  renderGroupCards();
  renderTable();
}

function renderAlert() {
  const { rows } = D;
  const brakPlanu = rows.filter(r=>!r.kartony_2026);
  const brakKl = [...new Set(brakPlanu.map(r=>r.klient+'|'+r.owoc))];
  const brakTxt = brakKl.length > 0
    ? ` Brak planu dla ${brakKl.length} kombinacji (${brakKl.slice(0,4).join(', ')}${brakKl.length>4?'‚Ä¶':''}) ‚Äî uzupe≈Çnij w `
    : ' Zmie≈Ñ plan w ';
  document.getElementById('plan-alert-text').innerHTML =
    '<strong>Jak liczone:</strong> '
    + 'Kartony 2026 = kg z planu √ó udzia≈Ç formatu (ZP 2025) √∑ kg/karton. '
    + 'Regu≈Ça: 1 karton = szt √ó waga, np. <strong>12√ó125g = 1,5 kg</strong>, 10√ó200g = 2,0 kg, 10√ó250g = 2,5 kg, 6√ó750g = 4,5 kg. '
    + 'Proporcje format√≥w: ' + D.zrodlo_historyczne_zp + '. '
    + 'Wolumen 2025: ' + D.zrodlo_historyczne_rt + '. '
    + brakTxt
    + '<a href="planowanie-i-sprzedaz.html" target="_blank" style="color:#92400e;text-decoration:underline">planowanie-i-sprzedaz.html</a>.';
}

renderKPIs();
renderGroupCards();
renderTable();
renderAlert();
</script>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     WIZARD SCRIPT
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
// ‚îÄ‚îÄ Constants ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ISO week ‚Üí month (2026, precomputed)
const WEEK_MONTH = {
  18:4, 19:5, 20:5, 21:5, 22:5,
  23:6, 24:6, 25:6, 26:6, 27:6,
  28:7, 29:7, 30:7, 31:7,
  32:8, 33:8, 34:8, 35:8, 36:8,
  37:9, 38:9, 39:9, 40:9,
  41:10,42:10,43:10,44:10,
  45:11,46:11
};
const ALL_WEEKS = new Set(Object.keys(WEEK_MONTH).map(Number)); // 29 weeks W18-W46
const MONTHS_INFO = [
  {m:4, name:'Kwiecie≈Ñ', short:'Kwi', weeks:[18]},
  {m:5, name:'Maj',      short:'Maj', weeks:[19,20,21,22]},
  {m:6, name:'Czerwiec', short:'Cze', weeks:[23,24,25,26,27]},
  {m:7, name:'Lipiec',   short:'Lip', weeks:[28,29,30,31]},
  {m:8, name:'Sierpie≈Ñ', short:'Sie', weeks:[32,33,34,35,36]},
  {m:9, name:'Wrzesie≈Ñ', short:'Wrz', weeks:[37,38,39,40]},
  {m:10,name:'Pa≈∫dziernik',short:'Pa≈∫',weeks:[41,42,43,44]},
  {m:11,name:'Listopad', short:'Lis', weeks:[45,46]}
];
const RENIA_SVG = `<svg viewBox="0 0 80 80" width="68" height="68" xmlns="http://www.w3.org/2000/svg">
  <circle cx="40" cy="40" r="38" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
  <path d="M14 32 Q18 6 40 6 Q62 6 66 32 Q68 18 60 12 Q50 2 40 2 Q30 2 20 12 Q12 18 14 32Z" fill="#92400e"/>
  <path d="M15 32 Q9 22 13 13" stroke="#78350f" stroke-width="3" fill="none" stroke-linecap="round"/>
  <path d="M65 32 Q71 22 67 13" stroke="#78350f" stroke-width="3" fill="none" stroke-linecap="round"/>
  <ellipse cx="40" cy="47" rx="20" ry="21" fill="#fde68a"/>
  <circle cx="31" cy="41" r="4.5" fill="white" stroke="#e5e7eb" stroke-width=".5"/>
  <circle cx="49" cy="41" r="4.5" fill="white" stroke="#e5e7eb" stroke-width=".5"/>
  <circle cx="31" cy="41" r="2.8" fill="#1c1917"/>
  <circle cx="49" cy="41" r="2.8" fill="#1c1917"/>
  <circle cx="32.2" cy="39.8" r="1" fill="white"/>
  <circle cx="50.2" cy="39.8" r="1" fill="white"/>
  <path d="M 26 54 Q 40 65 54 54" stroke="#92400e" stroke-width="2.5" fill="none" stroke-linecap="round"/>
  <circle cx="23" cy="51" r="5" fill="#fca5a5" opacity="0.45"/>
  <circle cx="57" cy="51" r="5" fill="#fca5a5" opacity="0.45"/>
  <path d="M 25 36 Q 31 33 37 36" stroke="#78350f" stroke-width="1.5" fill="none" stroke-linecap="round"/>
  <path d="M 43 36 Q 49 33 55 36" stroke="#78350f" stroke-width="1.5" fill="none" stroke-linecap="round"/>
  <path d="M 30 28 Q 35 24 40 26 Q 45 24 50 28" stroke="#92400e" stroke-width="2" fill="none" stroke-linecap="round"/>
</svg>`;

// ‚îÄ‚îÄ Wizard state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const WZ = {
  step: 1,
  groups:       { OGL: true, Jeronimo: true, Pozostali: true },
  periodType:   'season',
  selMonths:    new Set([5,6,7,8,9,10,11]),
  assignments:  {},       // "GROUP||pak_code" ‚Üí K-xxx indeks
  computed:     null,     // { group: { pak: data } }
  selDostawca:  null,     // id dostawcy wybranego na Step 3
  printData:    null
};

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function selectedWeeks() {
  if (WZ.periodType === 'season') return ALL_WEEKS;
  const s = new Set();
  MONTHS_INFO.forEach(mi => { if (WZ.selMonths.has(mi.m)) mi.weeks.forEach(w => s.add(w)); });
  return s;
}

function getStanyMap() {
  const m = {};
  ((window.ZAKUPY_DATA||{stany:[]}).stany).filter(s => s.kategoria === 'kartony')
    .forEach(s => { m[s.indeks] = s; });
  return m;
}

function kartonOptions() {
  return ((window.ZAKUPY_DATA||{stany:[]}).stany)
    .filter(s => s.kategoria === 'kartony')
    .map(s => {
      const nm = s.nazwa.length > 52 ? s.nazwa.slice(0,50)+'‚Ä¶' : s.nazwa;
      return `<option value="${s.indeks}">${s.indeks} ‚Äî ${nm}</option>`;
    }).join('');
}

// ‚îÄ‚îÄ Plan lookup ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _planLookup = null;
function planLookup() {
  if (_planLookup) return _planLookup;
  _planLookup = {};
  (window.PLAN_DATA||[]).filter(r => r.typ === 'klient').forEach(r => {
    const k = `${r.podmiot}||${r.owoc}||${r.tydzien}`;
    _planLookup[k] = (_planLookup[k]||0) + r.kg;
  });
  return _planLookup;
}

// ‚îÄ‚îÄ Core computation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Returns: { OGL: { pak_code: {...data, kartony_period} }, Jeronimo: {...}, Pozostali: {...} }
function computeNeeds() {
  const weeks  = selectedWeeks();
  const pl     = planLookup();
  const selGrp = Object.entries(WZ.groups).filter(([,v]) => v).map(([g]) => g);
  const result = {}; // group ‚Üí pakMap

  window.PLAN2026_DATA.rows
    .filter(r => r.kartony_2026 && selGrp.includes(r.group))
    .forEach(r => {
      let periodKg = 0;
      weeks.forEach(w => {
        if (r.owoc === 'Truskawka') {
          periodKg += pl[`${r.klient}||Truskawka tunelowa||${w}`]     || 0;
          periodKg += pl[`${r.klient}||Truskawka szklarniowa||${w}`]  || 0;
        } else {
          periodKg += pl[`${r.klient}||${r.owoc}||${w}`] || 0;
        }
      });
      if (periodKg === 0 && r.kg_2026) periodKg = r.kg_2026 * (weeks.size / ALL_WEEKS.size);

      if (!result[r.group]) result[r.group] = {};
      const pakMap = result[r.group];
      r.paks.forEach(p => {
        if (!pakMap[p.pak]) pakMap[p.pak] = { ...p, kartony_period: 0, kg_period: 0 };
        pakMap[p.pak].kartony_period += Math.round(periodKg * (p.udzial / 100) / p.kgpk);
        pakMap[p.pak].kg_period      += Math.round(periodKg * (p.udzial / 100));
      });
    });
  return result; // { OGL: {pak: data}, Jeronimo: {...}, Pozostali: {...} }
}

// ‚îÄ‚îÄ Step indicator update ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setDots(step) {
  [1,2,3].forEach(s => {
    const el = document.getElementById('wz-dot-'+s);
    el.className = 'wz-dot ' + (s < step ? 'wz-dot-done' : s === step ? 'wz-dot-active' : 'wz-dot-idle');
  });
  const labels = {1:'Parametry zam√≥wienia', 2:'Przypisanie karton√≥w', 3:'Podsumowanie i PDF'};
  document.getElementById('wz-step-lbl').textContent = labels[step] || '';
}

// ‚îÄ‚îÄ Open / Close ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openWizard() {
  document.getElementById('wz-overlay').classList.remove('hidden');
  document.body.style.overflow = 'hidden';
  WZ.step = 1;
  renderStep1();
}
function closeWizard() {
  document.getElementById('wz-overlay').classList.add('hidden');
  document.body.style.overflow = '';
}
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeWizard(); });
document.getElementById('wz-overlay').addEventListener('click', e => {
  if (e.target === document.getElementById('wz-overlay')) closeWizard();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STEP 1 ‚Äî Parametry
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderStep1() {
  setDots(1);
  const gt = window.PLAN2026_DATA.group_totals;
  const chips = [
    {id:'OGL',       label:'üçÉ OGL',               sub: fmt(gt.OGL?.kartony_2026||0)+' kart.'},
    {id:'Jeronimo',  label:'ü´ê Jeronimo (Biedronka)',sub: fmt(gt.Jeronimo?.kartony_2026||0)+' kart.'},
    {id:'Pozostali', label:'üåç Pozostali',          sub: fmt(gt.Pozostali?.kartony_2026||0)+' kart.'}
  ].map(c => `
    <button class="wz-chip ${WZ.groups[c.id]?'on-'+c.id:''}" onclick="toggleGrp('${c.id}')">
      ${c.label}
      <span style="font-size:10px;opacity:.65">${c.sub}</span>
    </button>`).join('');

  const monthBtns = MONTHS_INFO.map(mi => {
    const sel = WZ.selMonths.has(mi.m) && WZ.periodType === 'months';
    const dis  = WZ.periodType === 'season' ? 'dis' : '';
    return `<button class="mth-btn ${sel?'sel':''} ${dis}" onclick="clickMonth(${mi.m})" id="mth-${mi.m}">
      <div>${mi.short}</div>
      <div style="font-size:9px;opacity:.65">W${mi.weeks[0]}${mi.weeks.length>1?'‚Äì'+mi.weeks[mi.weeks.length-1]:''}</div>
    </button>`;
  }).join('');

  document.getElementById('wz-body').innerHTML = `
  <div class="wz-sec">
    <h3>Grupy klient√≥w</h3>
    <div class="wz-chips">${chips}</div>
  </div>
  <div class="wz-sec">
    <h3>Okres zam√≥wienia</h3>
    <div class="wz-radio-list">
      <label class="wz-radio-item ${WZ.periodType==='season'?'sel':''}" onclick="setPeriod('season')">
        <input type="radio" name="period" ${WZ.periodType==='season'?'checked':''} readonly>
        <div>
          <div class="wz-rlabel">Ca≈Çy sezon 2026</div>
          <div class="wz-rsub">Tygodnie W18‚ÄìW46 ¬∑ kwiecie≈Ñ ‚Äì listopad 2026 (29 tygodni)</div>
        </div>
      </label>
      <label class="wz-radio-item ${WZ.periodType==='months'?'sel':''}" onclick="setPeriod('months')">
        <input type="radio" name="period" ${WZ.periodType==='months'?'checked':''} readonly>
        <div style="width:100%">
          <div class="wz-rlabel">Wybrane miesiƒÖce</div>
          <div class="wz-rsub">Kliknij miesiƒÖc aby wybraƒá / odznaczyƒá</div>
          <div class="wz-months" style="margin-top:10px">${monthBtns}</div>
        </div>
      </label>
    </div>
  </div>`;

  document.getElementById('wz-footer').innerHTML = `
    <button class="wz-btn wz-btn-ghost" onclick="closeWizard()">‚úï Anuluj</button>
    <button class="wz-btn wz-btn-primary" onclick="goStep2()">Dalej: Przypisz kartony ‚Üí</button>`;
}

function toggleGrp(g)      { WZ.groups[g] = !WZ.groups[g]; renderStep1(); }
function setPeriod(type)    { WZ.periodType = type; renderStep1(); }
function clickMonth(m) {
  WZ.periodType = 'months';
  if (WZ.selMonths.has(m)) WZ.selMonths.delete(m); else WZ.selMonths.add(m);
  renderStep1();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STEP 2 ‚Äî Przypisanie karton√≥w
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function goStep2() {
  if (!Object.values(WZ.groups).some(v => v)) { alert('Wybierz co najmniej jednƒÖ grupƒô klient√≥w.'); return; }
  if (WZ.periodType === 'months' && WZ.selMonths.size === 0) { alert('Wybierz co najmniej jeden miesiƒÖc.'); return; }
  WZ.step = 2;
  WZ.computed = computeNeeds(); // { group: { pak: data } }
  // Default assignments from karton-mapa.js (ZP 2025 historical data, col. M)
  const kartonMapa = window.KARTON_MAPA;
  Object.entries(WZ.computed).forEach(([grp, pakMap]) => {
    Object.entries(pakMap).forEach(([pak, d]) => {
      const key = grp + '||' + pak;
      if (!WZ.assignments[key]) {
        WZ.assignments[key] = kartonMapa ? kartonMapa.get(grp, pak) : (d.rozmiar === 'MA≈ÅY' ? 'K-369X285X84' : 'K-580X390X90');
      }
    });
  });
  renderStep2();
}

const GRP_CFG = {
  OGL:       { color: 'var(--orange)', bg: 'rgba(250,66,17,.06)',  icon: 'üçÉ', label: 'OGL' },
  Jeronimo:  { color: 'var(--purple)', bg: 'rgba(144,19,254,.06)', icon: 'ü´ê', label: 'Jeronimo (Biedronka)' },
  Pozostali: { color: 'var(--blue)',   bg: 'rgba(37,99,235,.06)',  icon: 'üåç', label: 'Pozostali' }
};

function renderStep2() {
  setDots(2);
  const stanyMap  = getStanyMap();
  const opts      = kartonOptions();
  const selGrpArr = Object.entries(WZ.groups).filter(([,v]) => v).map(([g]) => g);
  const selGrps   = selGrpArr.join(', ');
  const periodLbl = WZ.periodType === 'season' ? 'Ca≈Çy sezon (W18‚ÄìW46)'
    : MONTHS_INFO.filter(mi => WZ.selMonths.has(mi.m)).map(mi => mi.short).join(', ') || '(brak wyboru)';

  let totalNeed = 0;
  let bodyHtml  = `
  <div style="background:rgba(37,99,235,.07);border:1px solid rgba(37,99,235,.22);border-radius:8px;padding:10px 14px;margin-bottom:14px;font-size:11px;color:var(--text-dim)">
    <div style="font-weight:700;color:var(--blue);margin-bottom:5px">‚ÑπÔ∏è SkƒÖd pochodzi kolumna ZAPOTRZEB.?</div>
    <div><strong>Wz√≥r:</strong> Zapotrzebowanie = kg z Planu Sprzeda≈ºy 2026 √ó udzia≈Ç formatu (ZP 2025) √∑ kg/karton</div>
    <div style="margin-top:4px"><strong>≈πr√≥d≈Ço kg:</strong> <code>planowanie-data.js</code> ‚Äî plan tygodniowy per klient/owoc &nbsp;|&nbsp; <strong>Okres:</strong> ${periodLbl}</div>
    <div style="margin-top:2px"><strong>≈πr√≥d≈Ço proporcji:</strong> Zestawienie Proceduralne ZP 2025 ‚Äî % wolumenu per format opakowania</div>
    <div style="margin-top:2px"><strong>kg/karton:</strong> szt √ó waga_g √∑ 1000 &nbsp;(np. 12 szt √ó 125 g = 1,5 kg/kart)</div>
  </div>
  <p style="font-size:11px;color:var(--text-dim);margin-bottom:14px">
    Dla ka≈ºdego formatu opakowania (ZP 2025) wybierz karton ze stanu magazynowego.
    Domy≈õlne przypisanie pochodzi z <strong>ZP 2025 (kol. M ‚Äî Surowiec Indeks)</strong> per klient √ó format. Zmie≈Ñ w razie potrzeby.
  </p>`;

  selGrpArr.forEach((grp, gi) => {
    const cfg     = GRP_CFG[grp] || { color:'var(--text)', bg:'transparent', icon:'', label:grp };
    const pakMap  = WZ.computed[grp] || {};
    const entries = Object.entries(pakMap).sort((a,b) => b[1].kartony_period - a[1].kartony_period);
    const grpTot  = entries.reduce((s,[,d]) => s + d.kartony_period, 0);
    totalNeed    += grpTot;

    const rows = entries.map(([pak, d]) => {
      const key      = grp + '||' + pak;
      const assigned = WZ.assignments[key] || '';
      const stan     = assigned ? (stanyMap[assigned]?.total || 0) : null;
      const doZam    = stan != null ? Math.max(0, d.kartony_period - stan) : null;
      const pakSafe  = pak.replace(/"/g,'&quot;');
      return `<tr>
        <td>
          <div style="font-weight:700;font-size:11px">${d.waga_g}g √ó ${d.szt} szt${d.topseal?' <span style="font-size:9px;color:var(--text-muted)">topseal</span>':''}</div>
          <div style="font-size:9px;color:var(--text-muted);font-family:\'DM Mono\',monospace;margin-top:1px">${pak.replace(/_/g,' ')}</div>
        </td>
        <td class="r val-need">${fmt(d.kartony_period)}</td>
        <td>
          <select class="assign-sel" data-grp="${grp}" data-pak="${pakSafe}"
            onchange="setAsgn(this.dataset.grp,this.dataset.pak,this.value)">
            <option value="">‚Äî wybierz ‚Äî</option>
            ${opts}
          </select>
        </td>
        <td class="r ${stan > 0 ? 'val-ok' : 'val-warn'}">${stan != null ? fmt(stan) : '‚Äî'}</td>
        <td class="r ${doZam > 0 ? 'val-order' : doZam === 0 ? 'val-ok' : ''}">${doZam != null ? fmt(doZam) : '‚Äî'}</td>
      </tr>`;
    }).join('');

    bodyHtml += `
    <div style="margin:${gi > 0 ? '20px' : '0'} 0 8px;display:flex;align-items:center;gap:10px">
      <span style="font-size:13px;font-weight:800;color:${cfg.color}">${cfg.icon} ${cfg.label}</span>
      <span style="font-family:\'DM Mono\',monospace;font-size:11px;color:var(--text-muted)">${fmt(grpTot)} kart.</span>
      <span style="flex:1;height:1px;background:${cfg.color};opacity:.25"></span>
    </div>
    <div class="assign-wrap">
      <table class="assign-table">
        <thead>
          <tr>
            <th style="width:36%">Format opakowania (ZP 2025)</th>
            <th class="r">Zapotrzeb.</th>
            <th>Karton ze stanu ‚Üì przypisz</th>
            <th class="r">Stan mag.</th>
            <th class="r">Do zam√≥wienia</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;
  });

  document.getElementById('wz-body').innerHTML = bodyHtml;

  // Set <select> values after DOM render
  selGrpArr.forEach(grp => {
    Object.keys(WZ.computed[grp] || {}).forEach(pak => {
      const key = grp + '||' + pak;
      const sel = document.querySelector(`select[data-grp="${grp}"][data-pak="${pak.replace(/"/g,'&quot;')}"]`);
      if (sel && WZ.assignments[key]) sel.value = WZ.assignments[key];
    });
  });

  document.getElementById('wz-footer').innerHTML = `
    <div style="font-size:11px;color:var(--text-muted)">
      Grupy: <strong>${selGrps}</strong>
      &nbsp;¬∑&nbsp; Okres: <strong>${periodLbl}</strong>
      &nbsp;¬∑&nbsp; ≈ÅƒÖcznie: <strong>${fmt(totalNeed)}</strong> kart.
    </div>
    <div style="display:flex;gap:8px">
      <button class="wz-btn wz-btn-ghost" onclick="WZ.step=1;renderStep1()">‚Üê Wstecz</button>
      <button class="wz-btn wz-btn-ghost" onclick="exportExcelStep2()" title="Eksportuj tabelƒô przypisa≈Ñ do Excel">üìä Excel</button>
      <button class="wz-btn wz-btn-green" onclick="goStep3()">Generuj podsumowanie ‚Üí</button>
    </div>`;
}

function setAsgn(grp, pak, indeks) {
  const key = grp + '||' + pak;
  WZ.assignments[key] = indeks;
  const stanyMap = getStanyMap();
  const d = (WZ.computed[grp] || {})[pak];
  if (!d) return;
  const row = document.querySelector(`select[data-grp="${grp}"][data-pak="${pak.replace(/"/g,'&quot;')}"]`)?.closest('tr');
  if (!row) return;
  const stan  = indeks ? (stanyMap[indeks]?.total || 0) : null;
  const doZam = stan != null ? Math.max(0, d.kartony_period - stan) : null;
  const cells = row.querySelectorAll('td');
  if (cells[3]) { cells[3].textContent = stan != null ? fmt(stan) : '‚Äî'; cells[3].className = 'r '+(stan>0?'val-ok':'val-warn'); }
  if (cells[4]) { cells[4].textContent = doZam != null ? fmt(doZam) : '‚Äî'; cells[4].className = 'r '+(doZam>0?'val-order':doZam===0?'val-ok':''); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STEP 3 ‚Äî Podsumowanie + PDF
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function goStep3() {
  WZ.step = 3;
  renderStep3();
}

function renderStep3() {
  setDots(3);
  const stanyMap = getStanyMap();
  const selGrps  = Object.entries(WZ.groups).filter(([,v]) => v).map(([g]) => g).join(', ');
  const periodLbl = WZ.periodType === 'season' ? 'Ca≈Çy sezon 2026 (kwiecie≈Ñ‚Äìlistopad)'
    : MONTHS_INFO.filter(mi => WZ.selMonths.has(mi.m)).map(mi => mi.name).join(', ');

  // Aggregate by assigned carton code ‚Äî key: "GROUP||pak_code"
  const orderMap = {};
  Object.entries(WZ.computed).forEach(([grp, pakMap]) => {
    Object.entries(pakMap).forEach(([pak, d]) => {
      const asgn = WZ.assignments[grp + '||' + pak];
      if (!asgn) return;
      if (!orderMap[asgn]) {
        const s = stanyMap[asgn] || {};
        orderMap[asgn] = { indeks: asgn, nazwa: s.nazwa||asgn, total_need: 0, stan: s.total||0, formats: [] };
      }
      orderMap[asgn].total_need += d.kartony_period;
      orderMap[asgn].formats.push(`${d.waga_g}g√ó${d.szt}`);
    });
  });

  const orderRows = Object.values(orderMap).sort((a,b) => b.total_need - a.total_need);
  const totalNeed  = orderRows.reduce((s,r) => s + r.total_need, 0);
  const totalStan  = orderRows.reduce((s,r) => s + r.stan, 0);
  const totalOrder = orderRows.reduce((s,r) => s + Math.max(0, r.total_need - r.stan), 0);
  WZ.printData = { orderRows, totalNeed, totalStan, totalOrder, selGrps, periodLbl };

  const tableRows = orderRows.map((r, i) => {
    const toOrder = Math.max(0, r.total_need - r.stan);
    const fmts = [...new Set(r.formats)].join(', ');
    return `<tr>
      <td style="font-size:11px;color:var(--text-muted)">${i+1}</td>
      <td><strong style="font-family:'DM Mono',monospace;font-size:11px">${r.indeks}</strong></td>
      <td>${r.nazwa}</td>
      <td style="font-size:10px;color:var(--text-muted)">${fmts}</td>
      <td class="r">${fmt(r.total_need)}</td>
      <td class="r ${r.stan>0?'val-ok':'val-warn'}">${fmt(r.stan)}</td>
      <td class="r"><span class="big-qty">${fmt(toOrder)}</span></td>
    </tr>`;
  }).join('');

  // ‚îÄ‚îÄ Supplier chips ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const dostawcyList = (window.DOSTAWCY_DATA?.dostawcy || []).filter(d => d.aktywny && d.id !== 'INNY');
  const selD = WZ.selDostawca ? dostawcyList.find(d => d.id === WZ.selDostawca) : null;
  const supChips = dostawcyList.map(d => {
    const on = WZ.selDostawca === d.id;
    return `<button style="padding:6px 13px;border:2px solid ${on ? d.kolor : 'var(--border2)'};border-radius:8px;background:${on ? d.kolor+'18' : 'transparent'};color:${on ? d.kolor : 'var(--text-muted)'};font-size:11px;font-weight:700;cursor:pointer;font-family:\'Plus Jakarta Sans\',sans-serif;transition:all .15s"
      onclick="WZ.selDostawca='${d.id}';renderStep3()">${d.skrot}</button>`;
  }).join('');
  const supDetail = selD
    ? `<div style="font-size:11px;color:var(--text-dim);margin-top:8px;padding:9px 12px;background:var(--surface2);border-radius:8px;display:flex;gap:16px;flex-wrap:wrap">
        <span><strong>${selD.nazwa}</strong></span>
        <span>${[selD.adres, selD.miasto, selD.kraj].filter(Boolean).join(', ')}</span>
        ${selD.email && selD.email !== 'do uzupe≈Çnienia' ? `<span>‚úâÔ∏è ${selD.email}</span>` : ''}
        ${selD.telefon && selD.telefon !== 'do uzupe≈Çnienia' ? `<span>üìû ${selD.telefon}</span>` : ''}
       </div>`
    : `<div style="font-size:11px;color:var(--text-muted);margin-top:6px;font-style:italic">Wybierz dostawcƒô ‚Äî jego dane pojawiƒÖ siƒô w nag≈Ç√≥wku PDF.</div>`;

  document.getElementById('wz-body').innerHTML = `
  <div class="rfq-head">
    <div class="rfq-avatar">${RENIA_SVG}</div>
    <div class="rfq-meta">
      <h3>OvocxMalinovi sp. z o.o.</h3>
      <div class="doc-title">üìã Zapytanie ofertowe ‚Äî Kartony Sezon 2026</div>
      <p>Grupy: <strong>${selGrps}</strong> &nbsp;¬∑&nbsp; Okres: <strong>${periodLbl}</strong></p>
      <p>Przygotowa≈Ça: <strong>Renia</strong> ‚Äî Specjalista ds. Rozlicze≈Ñ &nbsp;¬∑&nbsp; 26.02.2026</p>
    </div>
  </div>
  <div style="margin-bottom:16px;padding:12px 14px;border:2px solid ${WZ.selDostawca ? 'rgba(250,66,17,.3)' : 'var(--border)'};border-radius:10px;background:${WZ.selDostawca ? 'rgba(250,66,17,.03)' : 'transparent'}">
    <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--text-muted);margin-bottom:8px">
      üì§ DO: Dostawca (wybierz dla kogo generujesz zapytanie)
    </div>
    <div style="display:flex;gap:6px;flex-wrap:wrap">${supChips}</div>
    ${supDetail}
  </div>
  <div class="sum-wrap">
    <table class="sum-table">
      <thead>
        <tr>
          <th style="width:28px">Lp</th>
          <th>Kod</th>
          <th>Nazwa kartonu</th>
          <th>Formaty</th>
          <th class="r">Zapotrzeb.</th>
          <th class="r">Stan mag.</th>
          <th class="r" style="color:#fa4211">Do zam√≥wienia</th>
        </tr>
      </thead>
      <tbody>
        ${tableRows}
        <tr class="total-row">
          <td colspan="4" style="font-weight:800">≈ÅƒÑCZNIE</td>
          <td class="r">${fmt(totalNeed)}</td>
          <td class="r ${totalStan >= totalNeed ? 'val-ok' : 'val-warn'}">${fmt(totalStan)}</td>
          <td class="r" style="background:${totalOrder === 0 ? 'rgba(22,163,74,.08)' : 'rgba(220,38,38,.08)'}">
            <span style="font-family:\'DM Mono\',monospace;font-size:16px;font-weight:900;color:${totalOrder === 0 ? 'var(--green)' : '#dc2626'}">
              ${totalOrder === 0 ? '‚úì 0' : '‚àí\u200b' + fmt(totalOrder)}
            </span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <div class="notes-box">
    <strong>Uwagi do zapytania ofertowego:</strong><br>
    ‚Ä¢ Prosimy o wycenƒô przy zam√≥wieniu jednorazowym (ca≈Ço≈õƒá sezonu) oraz w transzach (sugestia: 3√ó w sezonie)<br>
    ‚Ä¢ Dostawy do magazyn√≥w: <strong>Chodzie≈º, ≈Åob≈ºenica, Str√≥≈ºewo, Wyszynki</strong><br>
    ‚Ä¢ Kartony powinny spe≈Çniaƒá wymogi jako≈õciowe dla owoc√≥w miƒôkkich (malina, truskawka)<br>
    ‚Ä¢ Kontakt: Renia ‚Äî Specjalista ds. Rozlicze≈Ñ, OvocxMalinovi sp. z o.o.
  </div>`;

  document.getElementById('wz-footer').innerHTML = `
    <button class="wz-btn wz-btn-ghost" onclick="WZ.step=2;renderStep2()">‚Üê Wstecz</button>
    <div style="display:flex;gap:8px">
      <button class="wz-btn wz-btn-ghost" onclick="copyRFQ()">üìã Kopiuj tekst</button>
      <button class="wz-btn wz-btn-ghost" onclick="exportExcelStep3()" title="Eksportuj RFQ do pliku Excel">üìä Excel</button>
      <button class="wz-btn wz-btn-blue" onclick="doPrint()">üñ®Ô∏è Drukuj / PDF</button>
    </div>`;
}

// ‚îÄ‚îÄ Print / PDF ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function doPrint() {
  if (!WZ.printData) return;
  const { orderRows, totalNeed, totalStan, totalOrder, selGrps, periodLbl } = WZ.printData;
  const today = '26.02.2026';
  const selD = WZ.selDostawca
    ? (window.DOSTAWCY_DATA?.dostawcy || []).find(d => d.id === WZ.selDostawca)
    : null;

  const tableRows = orderRows.map((r, i) => {
    const toOrder = Math.max(0, r.total_need - r.stan);
    const fmts = [...new Set(r.formats)].join(', ');
    return `<tr>
      <td class="r">${i+1}</td>
      <td style="font-family:monospace"><strong>${r.indeks}</strong></td>
      <td>${r.nazwa}</td>
      <td>${fmts}</td>
      <td class="r">${fmt(r.total_need)}</td>
      <td class="r">${fmt(r.stan)}</td>
      <td class="r"><strong>${fmt(toOrder)}</strong></td>
    </tr>`;
  }).join('');

  const doBlock = selD ? `
    <div style="margin:14px 0;padding:10px 12px;border:1px solid #e8e6e1;border-radius:6px;font-size:11px">
      <div style="font-size:10px;font-weight:700;color:#888;text-transform:uppercase;margin-bottom:4px">Do:</div>
      <div style="font-weight:700;font-size:12px">${selD.nazwa}</div>
      <div>${[selD.adres, selD.miasto, selD.kraj].filter(Boolean).join(', ')}</div>
      ${selD.email && selD.email !== 'do uzupe≈Çnienia' ? `<div>‚úâÔ∏è ${selD.email}</div>` : ''}
      ${selD.telefon && selD.telefon !== 'do uzupe≈Çnienia' ? `<div>üìû ${selD.telefon}</div>` : ''}
      ${selD.nip ? `<div style="color:#888;font-size:10px">NIP: ${selD.nip}</div>` : ''}
    </div>` : '';

  document.getElementById('print-area').innerHTML = `
    <div class="print-header">
      <div style="flex:1">
        <div class="print-logo-txt">OvocxMalinovi sp. z o.o.</div>
        <div class="print-doc-title">Zapytanie ofertowe ‚Äî Kartony Sezon 2026</div>
        <div class="print-meta">
          Grupy klient√≥w: <strong>${selGrps}</strong><br>
          Okres: <strong>${periodLbl}</strong><br>
          Data wygenerowania: ${today}
        </div>
      </div>
      <div class="print-renia">
        ${RENIA_SVG}
        <div style="margin-top:4px"><strong>Renia</strong></div>
        <div>Specjalista ds. Rozlicze≈Ñ</div>
      </div>
    </div>
    ${doBlock}
    <p style="font-size:12px;margin-bottom:10px">
      Prosimy o przedstawienie oferty cenowej na dostawƒô karton√≥w opakowaniowych sezon 2026:
    </p>
    <table class="print-table">
      <thead>
        <tr>
          <th class="r">Lp</th>
          <th>Kod</th>
          <th>Nazwa kartonu</th>
          <th>Formaty op.</th>
          <th class="r">Zapotrzeb.</th>
          <th class="r">Stan mag.</th>
          <th class="r" style="background:#fa4211">Do zam√≥wienia</th>
        </tr>
      </thead>
      <tbody>
        ${tableRows}
        <tr class="total-row">
          <td colspan="4"><strong>≈ÅƒÑCZNIE</strong></td>
          <td class="r"><strong>${fmt(totalNeed)}</strong></td>
          <td class="r" style="color:${totalStan >= totalNeed ? '#16a34a' : '#dc2626'}"><strong>${fmt(totalStan)}</strong></td>
          <td class="r" style="color:${totalOrder === 0 ? '#16a34a' : '#dc2626'}"><strong>${totalOrder === 0 ? '‚úì 0' : '‚àí ' + fmt(totalOrder)}</strong></td>
        </tr>
      </tbody>
    </table>
    <div class="print-notes">
      <strong>Warunki i uwagi:</strong><br>
      ‚Ä¢ Prosimy o wycenƒô przy zam√≥wieniu jednorazowym (ca≈Ço≈õƒá) oraz w 3 transzach w sezonie<br>
      ‚Ä¢ Dostawy do magazyn√≥w: Chodzie≈º, ≈Åob≈ºenica, Str√≥≈ºewo, Wyszynki<br>
      ‚Ä¢ Kartony dla owoc√≥w miƒôkkich ‚Äî wymagana odporno≈õƒá na wilgoƒá, spe≈Çnienie wymog√≥w HACCP<br>
      ‚Ä¢ Termin odpowiedzi: do 7 dni od daty zapytania
    </div>
    <div class="print-footer">
      OvocxMalinovi sp. z o.o. &nbsp;|&nbsp; Zapytanie wygenerowane przez OxM Brain &nbsp;|&nbsp;
      Kontakt: Renia (Specjalista ds. Rozlicze≈Ñ) &nbsp;|&nbsp; ${today}
    </div>`;
  window.print();
}

// ‚îÄ‚îÄ Excel exports ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function xlsxCheck() {
  if (!window.XLSX) { alert('Biblioteka Excel (SheetJS) nie za≈Çadowa≈Ça siƒô ‚Äî sprawd≈∫ po≈ÇƒÖczenie z internetem.'); return false; }
  return true;
}

// Step 2 ‚Äî tabela przypisa≈Ñ per format / per grupa
function exportExcelStep2() {
  if (!xlsxCheck() || !WZ.computed) return;
  const XLSX = window.XLSX;
  const wb   = XLSX.utils.book_new();
  const stanyMap = getStanyMap();
  const selGrpArr = Object.entries(WZ.groups).filter(([,v]) => v).map(([g]) => g);
  const periodLbl = WZ.periodType === 'season' ? 'Ca≈Çy sezon 2026 (W18‚ÄìW46)'
    : MONTHS_INFO.filter(mi => WZ.selMonths.has(mi.m)).map(mi => mi.short).join(', ');
  const today = '26.02.2026';

  const rows = [
    ['OvocxMalinovi sp. z o.o. ‚Äî Przypisanie karton√≥w do format√≥w opakowa≈Ñ'],
    ['Grupy klient√≥w:', selGrpArr.join(', '), '', 'Okres:', periodLbl, '', 'Data:', today],
    [],
    ['Grupa', 'Format (ZP 2025)', 'Waga√óSzt', 'Zapotrzebowanie (kart.)', 'Przypisany karton (K-xxx)', 'Nazwa kartonu', 'Stan magazynowy (szt.)', 'Do zam√≥wienia (szt.)']
  ];

  selGrpArr.forEach(grp => {
    const pakMap = WZ.computed[grp] || {};
    Object.entries(pakMap)
      .sort((a,b) => b[1].kartony_period - a[1].kartony_period)
      .forEach(([pak, d]) => {
        const key    = grp + '||' + pak;
        const asgn   = WZ.assignments[key] || '';
        const stan   = asgn ? (stanyMap[asgn]?.total || 0) : '';
        const doZam  = asgn ? Math.max(0, d.kartony_period - (stanyMap[asgn]?.total || 0)) : '';
        const nazwa  = asgn ? (stanyMap[asgn]?.nazwa || '') : '';
        rows.push([grp, pak.replace(/_/g,' '), `${d.waga_g}g√ó${d.szt}`,
          d.kartony_period, asgn, nazwa, stan, doZam]);
      });
    rows.push([]); // spacer between groups
  });

  const ws = XLSX.utils.aoa_to_sheet(rows);
  ws['!cols'] = [{wch:14},{wch:40},{wch:12},{wch:20},{wch:22},{wch:44},{wch:20},{wch:18}];
  ws['!merges'] = [{s:{r:0,c:0},e:{r:0,c:6}}];
  XLSX.utils.book_append_sheet(wb, ws, 'Przypisanie karton√≥w');
  XLSX.writeFile(wb, `Przypisanie_kartonow_${today.replace(/\./g,'')}.xlsx`);
}

// Step 3 ‚Äî zestawienie RFQ (jak PDF ale w Excel)
function exportExcelStep3() {
  if (!xlsxCheck() || !WZ.printData) return;
  const XLSX = window.XLSX;
  const { orderRows, totalNeed, totalStan, totalOrder, selGrps, periodLbl } = WZ.printData;
  const selD  = WZ.selDostawca ? (window.DOSTAWCY_DATA?.dostawcy||[]).find(d=>d.id===WZ.selDostawca) : null;
  const today = '26.02.2026';
  const wb    = XLSX.utils.book_new();

  // Arkusz 1 ‚Äî RFQ
  const wsRows = [
    ['OvocxMalinovi sp. z o.o.'],
    ['ZAPYTANIE OFERTOWE ‚Äî KARTONY SEZON 2026'],
    [],
    ['Grupy klient√≥w:', selGrps, '', '', 'Data:', today],
    ['Okres:', periodLbl],
    ['Dostawca:', selD ? selD.nazwa : '‚Äî nie wybrano'],
    selD ? ['Adres:', [selD.adres,selD.miasto,selD.kraj].filter(Boolean).join(', ')] : [],
    selD ? ['E-mail:', selD.email||''] : [],
    [],
    ['Lp','Kod kartonu','Nazwa kartonu','Formaty opakowa≈Ñ','Zapotrzebowanie','Stan magazynowy','Do zam√≥wienia','Cena jdn. NETTO','Warto≈õƒá NETTO','Uwagi']
  ];
  orderRows.forEach((r, i) => {
    const toOrder = Math.max(0, r.total_need - r.stan);
    wsRows.push([i+1, r.indeks, r.nazwa, [...new Set(r.formats)].join(', '),
      r.total_need, r.stan, toOrder, '', '', '']);
  });
  wsRows.push(['', '', '', '≈ÅƒÑCZNIE', totalNeed, totalStan, totalOrder, '', '', '']);
  wsRows.push([]);
  wsRows.push(['UWAGI DO ZAPYTANIA']);
  wsRows.push(['Proszƒô o wycenƒô jednorazowƒÖ (ca≈Çy sezon) oraz w 3 transzach']);
  wsRows.push(['Dostawy: Chodzie≈º, ≈Åob≈ºenica, Str√≥≈ºewo, Wyszynki']);
  wsRows.push(['Wymagania: odporno≈õƒá na wilgoƒá, HACCP, kartony dla owoc√≥w miƒôkkich']);
  wsRows.push(['Termin odpowiedzi: 7 dni']);

  const ws1 = XLSX.utils.aoa_to_sheet(wsRows);
  ws1['!cols'] = [{wch:4},{wch:22},{wch:42},{wch:26},{wch:18},{wch:18},{wch:18},{wch:20},{wch:18},{wch:24}];
  ws1['!merges'] = [{s:{r:0,c:0},e:{r:0,c:5}},{s:{r:1,c:0},e:{r:1,c:5}}];
  XLSX.utils.book_append_sheet(wb, ws1, 'Zapytanie ofertowe');

  // Arkusz 2 ‚Äî per-grupa szczeg√≥≈Çy (jak Step 2)
  const rows2 = [['Szczeg√≥≈Çy zapotrzebowania per format (ZP 2025)'],[]];
  const stanyMap  = getStanyMap();
  const selGrpArr = Object.entries(WZ.groups).filter(([,v])=>v).map(([g])=>g);
  rows2.push(['Grupa','Format ZP','Waga√óSzt','Zapotrzeb. (kart.)','Przypisany K-xxx','Stan mag.','Do zam√≥w.']);
  selGrpArr.forEach(grp => {
    const pakMap = WZ.computed[grp]||{};
    Object.entries(pakMap).sort((a,b)=>b[1].kartony_period-a[1].kartony_period).forEach(([pak,d])=>{
      const key=grp+'||'+pak, asgn=WZ.assignments[key]||'';
      const stan=asgn?(stanyMap[asgn]?.total||0):'';
      rows2.push([grp,pak.replace(/_/g,' '),`${d.waga_g}g√ó${d.szt}`,d.kartony_period,asgn,stan,
        asgn?Math.max(0,d.kartony_period-(stanyMap[asgn]?.total||0)):'']);
    });
    rows2.push([]);
  });
  const ws2 = XLSX.utils.aoa_to_sheet(rows2);
  ws2['!cols'] = [{wch:14},{wch:40},{wch:12},{wch:18},{wch:22},{wch:16},{wch:16}];
  XLSX.utils.book_append_sheet(wb, ws2, 'Szczeg√≥≈Çy per format');

  const fname = `RFQ_Kartony_2026_${selD?selD.skrot+'_':''}${today.replace(/\./g,'')}.xlsx`;
  XLSX.writeFile(wb, fname);
}

// ‚îÄ‚îÄ Copy to clipboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function copyRFQ() {
  if (!WZ.printData) return;
  const { orderRows, totalOrder, selGrps, periodLbl } = WZ.printData;
  const selD = WZ.selDostawca ? (window.DOSTAWCY_DATA?.dostawcy||[]).find(d=>d.id===WZ.selDostawca) : null;
  const doLine = selD ? `DO: ${selD.nazwa} ¬∑ ${[selD.adres,selD.miasto].filter(Boolean).join(', ')}\n` : '';
  let t = `ZAPYTANIE OFERTOWE ‚Äî KARTONY SEZON 2026\nOvocxMalinovi sp. z o.o.\n${doLine}Grupy: ${selGrps} | Okres: ${periodLbl}\n\n`;
  t += 'Kod'.padEnd(26) + 'Nazwa'.padEnd(48) + 'Do zam√≥wienia\n' + '‚îÄ'.repeat(90) + '\n';
  orderRows.forEach(r => {
    t += r.indeks.padEnd(26) + r.nazwa.slice(0,46).padEnd(48) + fmt(Math.max(0,r.total_need-r.stan)) + '\n';
  });
  t += '‚îÄ'.repeat(90) + '\n≈ÅƒÑCZNIE' + ' '.repeat(68) + fmt(totalOrder) + '\n';
  navigator.clipboard?.writeText(t).then(() => alert('Skopiowano do schowka!'))
    .catch(() => {
      const ta = document.createElement('textarea');
      ta.value = t; document.body.appendChild(ta); ta.select();
      document.execCommand('copy'); document.body.removeChild(ta);
      alert('Skopiowano do schowka!');
    });
}
</script>
</body>
</html>